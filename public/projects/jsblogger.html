
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>JSBlogger - Jumpstart Lab Curriculum</title>
  <meta name="author" content="Jumpstart Lab">

  
  <meta name="description" content="            JSBlogger          In this project you&#8217;ll create a simple blog system and learn the basics of Ruby on Rails including:Models, Vie...">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://yoursite.com/projects/jsblogger.html">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection, print" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="http://s3.amazonaws.com/ender-js/jeesh.min.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Jumpstart Lab Curriculum" type="application/atom+xml">
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.3/jquery.min.js" type="text/javascript"></script>
  <script src="http://tab-slide-out.googlecode.com/files/jquery.tabSlideOut.v1.3.js"></script>

  <script type="text/javascript">
    $(function(){
      $('.slide-out-div').tabSlideOut({
        tabHandle: '.handle',                     //class of the element that will become your tab
        pathToTabImage: '/images/feedback_tab.png', //path to the image for the tab //Optionally can be set using css
        imageHeight: '150px',                     //height of tab image           //Optionally can be set using css
        imageWidth: '50px',                       //width of tab image            //Optionally can be set using css
        tabLocation: 'left',                      //side of screen where tab lives, top, right, bottom, or left
        speed: 300,                               //speed of animation
        action: 'click',                          //options: 'click' or 'hover', action to trigger animation
        topPos: '200px',                          //position from the top/ use if tabLocation is left or right
        leftPos: '20px',                          //position from left/ use if tabLocation is bottom or top
        fixedPosition: true                      //options: true makes it stick(fixed position) on scroll
        });
      });
  </script>

  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

</head>

<body  >
  <header role="banner"><hgroup>
  <h1><a href="/">Jumpstart Lab Curriculum</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:yoursite.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
<ul class="main-navigation">
  <li><a href="/">Curriculum Index</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article role="article">
  
  <header>
    
    <h1 class="entry-title">JSBlogger</h1>
    
  </header>
  
  <p>In this project you&#8217;ll create a simple blog system and learn the basics of Ruby on Rails including:</p>

<ul>
<li>Models, Views, and Controllers (MVC)</li>
<li>Data Structures &amp; Relationships</li>
<li>Routing</li>
<li>Migrations</li>
<li>Views with forms, partials, and helpers</li>
<li>RESTful design</li>
<li>Using Rails plugins/gems</li>
</ul>

<p>The project will be developed in five iterations.</p>

<div class="note">
<p>This tutorial is open source. If you notice errors, typos, or have questions/suggestions, please <a href="https://github.com/JumpstartLab/curriculum/blob/master/source/projects/jsblogger.markdown">submit them to the project on Github</a>.</p>
</div>

<h2>I0: Up and Running</h2>

<p>Part of the reason Ruby on Rails became popular quickly is that it takes a lot of the hard work off your hands, and that&#8217;s especially true in starting up a project. Rails practices the idea of &quot;sensible defaults&quot; and will, with one command, create a working application ready for your customization.</p>

<h3>Setting the Stage</h3>

<p>First we need to make sure everything is setup and installed. See the &quot;Environment Setup&quot;:/topics/environment/environment.html page for instructions on setting up and verifying your Ruby, Rails, and add-ons.</p>

<p>From the command line, switch to the folder that will store your projects. For instance, I use <code>/Users/jcasimir/projects/</code>. Within that folder, run the <code>rails</code> command:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>rails new jsblogger</span></code></pre></td></tr></table></div></figure>

<p>Use <code>cd jsblogger</code> to change into the directory, then open it in your text editor. If you&#8217;re using TextMate, run <code>mate .</code> or with RubyMine run <code>mine .</code>.</p>

<h3>Project Tour</h3>

<p>The generator has created a Rails application for you. Let&#8217;s figure out what&#8217;s in there. Looking at the project root, we have these folders:</p>

<ul>
<li><code>app</code> - This is where 98% of your effort will go. It contains subfolders which will hold most of the code you write including Models, Controllers, Views, Helpers, JavaScripts, etc.</li>
<li><code>config</code> - Control the environment settings for your application. It also includes the <code>initializers</code> subfolder which holds items to be run on startup.</li>
<li><code>db</code> - Will eventually have a <code>migrations</code> subfolder where your migrations, used to structure the database will be stored. When using SQLite3, as is the Rails default, the database file will be stored in this folder.</li>
<li><code>doc</code> - Who writes documentation? If you did, it&#8217;d go here. Someday.</li>
<li><code>lib</code> - Not commonly used, this folder is to store code you control that is reusable outside the project. Instead, of storing code here, consider packaging it as a gem.</li>
<li><code>log</code> - Log files, one for each environment.</li>
<li><code>public</code> - The &quot;root&quot; of your application. Static files can be stored and accessed from here, but all the interesting things (JavaScript, Images, CSS) have moved up to <code>app</code> since Rails 3.1</li>
<li><code>script</code> - Nothing of interest</li>
<li><code>test</code> - If your project is using the default <code>Test::Unit</code> testing library, the tests will live here</li>
<li><code>tmp</code> - Temporary cached files</li>
<li><code>vendor</code> - Infrequently used, this folder is to store code you <em>do not</em> control. With Bundler and Rubygems, we generally don&#8217;t need anything in here during development.</li>
</ul>

<h3>Configuring the Database</h3>

<p>Look in the <code>config</code> directory and open the file <code>database.yml</code>. This file controls how Rails&#8217; database connection system will access your database. You can configure many different databases, including SQLite3, MySQL, PostgreSQL, SQL Server, and Oracle. </p>

<p>If you were connecting to an existing database you would enter the database configuration parameters here. Since we&#8217;re using SQLite3 and starting from scratch, we can leave the defaults to create a new database, which will happen automatically. The database will be stored in <code>db/development.sqlite3</code></p>

<h3>Starting the Server</h3>

<p>At your terminal and inside the project directory, start the server:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>rails server</span></code></pre></td></tr></table></div></figure>

<p>It generally takes about 15 seconds. When you see seven lines like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>=&gt; Booting WEBrick
</span><span class='line'>=&gt; Rails 3.1.3 application starting in development on http://0.0.0.0:3000
</span><span class='line'>=&gt; Call with -d to detach
</span><span class='line'>=&gt; Ctrl-C to shutdown server
</span><span class='line'>[2012-01-07 11:16:52] INFO  WEBrick 1.3.1
</span><span class='line'>[2012-01-07 11:16:52] INFO  ruby 1.9.3 (2011-10-30) [x86_64-darwin11.2.0]
</span><span class='line'>[2012-01-07 11:16:52] INFO  WEBrick::HTTPServer#start: pid=36790 port=3000</span></code></pre></td></tr></table></div></figure>

<p>You&#8217;re ready to go!</p>

<h3>Accessing the Server</h3>

<p>Open any web browser and enter the address <code>http://0.0.0.0:3000</code>. You can also use <code>http://localhost:3000</code> or <code>http://127.0.0.1:3000</code> &#8211; they are all &quot;loopback&quot; address that point to your machine.</p>

<p>You&#8217;ll see the Rails&#8217; &quot;Welcome Aboard&quot; page. Click the &quot;About your application’s environment&quot; link and you should see the versions of various gems. As long as there&#8217;s no error, you&#8217;re good to go.</p>

<h4>Getting an Error?</h4>

<p>If you see an error here, it&#8217;s most likely related to the database. You are probably running Windows and don&#8217;t have either the SQLite3 application installed or the gem isn&#8217;t installed properly. Go back to &quot;Environment Setup&quot;:/topics/environment/environment.html and use the Rails Installer package. Make sure you check the box during setup to configure the environment variables. Restart your machine after the installation and give it another try.</p>

<h3>Creating the Article Model</h3>

<p>Our blog will be centered around &quot;articles,&quot; so we&#8217;ll need a table in the database to store all the articles and a model to allow our Rails app to work with that data. We&#8217;ll use one of Rails&#8217; generators to create the required files. Switch to your terminal and enter the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>rails generate model Article</span></code></pre></td></tr></table></div></figure>

<p>We&#8217;re running the <code>generate</code> script, telling it to create a <code>model</code>, and naming that model <code>Article</code>. From that information, Rails creates the following files:</p>

<ul>
<li><code>/db/migrate/(some_time_stamp)_create_articles.rb</code> : A database migration to create the <code>articles</code> table</li>
<li><code>/app/models/article.rb</code> : The file that will hold the model code</li>
<li><code>/test/unit/article_test.rb</code> : A file to hold unit tests for <code>Article</code></li>
<li><code>/test/fixtures/articles.yml</code> : A fixtures file to assist with unit testing</li>
</ul>

<p>With those files in place we can start developing!</p>

<h3>Working with the Database</h3>

<p>Rails uses migration files to perform modifications to the database. Almost any modification you can make to a DB can be done through a migration. The killer feature about Rails migrations is that they&#8217;re generally database agnostic. When developing applications I usually use SQLite3 as we are in this tutorial, but when I deploy to my server it is running PostgreSQL. Many others choose MySQL. It doesn&#8217;t matter &#8211; the same migrations will work on all of them!  This is an example of how Rails takes some of the painful work off your hands. You write your migrations once, then run them against almost any database.</p>

<h4>Migration?</h4>

<p>What is a migration?  Let&#8217;s open <code>/db/migrate/(some_time_stamp)_create_articles.rb</code> and take a look. First you&#8217;ll notice that the filename begins with a mish-mash of numbers which is a timestamp of when the migration was created. Migrations need to be ordered, so the timestamp serves to keep them in chronologic order. Inside the file, you&#8217;ll see just the method <code>change</code>.</p>

<p>Migrations used to have two methods, <code>self.up</code> and <code>self.down</code>. The <code>up</code> was used to make your change, and the <code>down</code> was there as a safety valve to undo the change. But this usually meant a bunch of extra typing, so with Rails 3.1 those two were replace with <code>change</code>.</p>

<p>We write <code>change</code> migrations just like we used to write <code>self.up</code>, but Rails will figure out the undo operations for us automatically.</p>

<h4>Modifying <code>change</code></h4>

<p>Inside the <code>change</code> method you&#8217;ll see the generator has placed a call to the <code>create_table</code> method, passed the symbol <code>:articles</code> as a parameter, and created a block with the variable <code>t</code> referencing the table that&#8217;s created.</p>

<p>We call methods on <code>t</code> to create columns in the <code>articles</code> table. What kind of fields does our Article need to have?  Since migrations make it easy to add or change columns later, we don&#8217;t need to think of EVERYTHING right now, we just need a few to get us rolling. Here&#8217;s a starter set:</p>

<ul>
<li><code>title</code> (a string)</li>
<li><code>body</code> (a &quot;text&quot;)</li>
</ul>

<p>That&#8217;s it! You might be wondering, what is a &quot;text&quot; type?  This is an example of relying on the Rails database adapters to make the right call. For some DBs, large text fields are stored as <code>varchar</code>, while others like Postgres use a <code>text</code> type. The database adapter will figure out the best choice for us depending on the configured database &#8211; we don&#8217;t have to worry about it.</p>

<p>So add these into your <code>change</code> so it looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">def</span> <span class="nf">change</span>
</span><span class='line'>    <span class="n">create_table</span> <span class="ss">:articles</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
</span><span class='line'>      <span class="n">t</span><span class="o">.</span><span class="n">string</span> <span class="ss">:title</span>
</span><span class='line'>      <span class="n">t</span><span class="o">.</span><span class="n">text</span> <span class="ss">:body</span>
</span><span class='line'>      <span class="n">t</span><span class="o">.</span><span class="n">timestamps</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<h4>Timestamps</h4>

<p>What is that <code>t.timestamps</code> doing there? It will create two columns inside our table titled <code>created_at</code> and <code>updated_at</code>. Rails will manage these columns for us, so when an article is created its <code>created_at</code> and <code>updated_at</code> are automatically set. Each time we make a change to the article, the <code>updated_at</code> will automatically be updated. Very handy.</p>

<h4>Running the Migration</h4>

<p>Save that migration file, switch over to your terminal, and run this command:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>rake db:migrate</span></code></pre></td></tr></table></div></figure>

<p>This command starts the <code>rake</code> program which is a ruby utility for running maintenance-like functions on your application (working with the DB, executing unit tests, deploying to a server, etc). We tell <code>rake</code> to <code>db:migrate</code> which means &quot;look in your set of functions for the database (<code>db</code>) and run the <code>migrate</code> function.&quot;  The <code>migrate</code> action finds all migrations in the <code>/db/migrate/</code> folder, looks at a special table in the DB to determine which migrations have and have not been run yet, then runs any migration that hasn&#8217;t been run. </p>

<p>In this case we had just one migration to run and it should print some output like this to your terminal:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>==  CreateArticles: migrating =================================================
</span><span class='line'>-- create_table(:articles)
</span><span class='line'>   -&gt; 0.0012s
</span><span class='line'>==  CreateArticles: migrated (0.0013s) ========================================</span></code></pre></td></tr></table></div></figure>

<p>It tells you that it is running the migration named <code>CreateArticles</code>. And the &quot;migrated&quot; line means that it completed without errors. As I said before, rake keeps track of which migrations have and have not been run. Try running @rake db:migrate@ again now, and see what happens.</p>

<p>We&#8217;ve now created the <code>articles</code> table in the database and can start working on our <code>Article</code> model.</p>

<h3>Working with a Model in the Console</h3>

<p>Another awesome feature of working with Rails is the <code>console</code>. The <code>console</code> is a command-line interface to your application. It allows you to access and work with just about any part of your application directly instead of going through the web interface. This can simplify your development process, and even once an app is in production the console makes it very easy to do bulk modifications, searches, and other data operations. So let&#8217;s open the console now by going to your terminal and entering this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>rails console</span></code></pre></td></tr></table></div></figure>

<p>You&#8217;ll then just get back a prompt of <code>&gt;&gt;</code>. You&#8217;re now inside an <code>irb</code> interpreter with full access to your application. Let&#8217;s try some experiments. Enter each of these commands one at a time and observe the results:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>puts Time.now
</span><span class='line'>Article.all
</span><span class='line'>Article.new</span></code></pre></td></tr></table></div></figure>

<p>The first line was just to demonstrate that we can do anything we previously did inside <code>irb</code> now inside of our <code>console</code>. The second line referenced the <code>Article</code> model and called the <code>all</code> method which returns an array of all articles in the database &#8211; so far an empty array. The third line created a new article object. You can see that this new object had attributes <code>id</code>, <code>title</code>, <code>body</code>, <code>created_at</code>, and <code>updated_at</code>.</p>

<h3>Looking at the Model</h3>

<p>All the code for the <code>Article</code> model is in the file <code>/app/models/article.rb</code>, so let&#8217;s open that now.</p>

<p>Not very impressive, right?  There are no attributes defined inside the model, so how does Rails know that an Article should have a <code>title</code>, a <code>body</code>, etc?  It queries the database, looks at the articles table, and assumes that whatever columns that table has should probably be the attributes accessible through the model. </p>

<p>You created most of those in your migration file, but what about <code>id</code>?  Every table you create with a migration will automatically have an <code>id</code> column which serves as the table&#8217;s primary key. When you want to find a specific article, you&#8217;ll look it up in the articles table by its unique ID number. Rails and the database work together to make sure that these IDs are unique, usually using a special column type in the DB like &quot;serial&quot;.</p>

<p>In your console, try entering <code>Article.all</code> again. Do you see the blank article that we created with the <code>Article.new</code> command?  No?  The console doesn&#8217;t change values in the database until we explicitly call the <code>.save</code> method on an object. Let&#8217;s create a sample article and you&#8217;ll see how it works. Enter each of the following lines one at a time:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>a = Article.new
</span><span class='line'>a.title = "Sample Article Title"
</span><span class='line'>a.body = "This is the text for my article, woo hoo!"
</span><span class='line'>a.save
</span><span class='line'>Article.all</span></code></pre></td></tr></table></div></figure>

<p>Now you&#8217;ll see that the <code>Article.all</code> command gave you back an array holding the one article we created and saved. Go ahead and <em>create 3 more sample articles</em>.</p>

<h3>Setting up the Router</h3>

<p>We&#8217;ve created a few articles through the console, but we really don&#8217;t have a web application until we have a web interface. Let&#8217;s get that started. We said that Rails uses an &quot;MVC&quot; architecture and we&#8217;ve worked with the Model, now we need a Controller and View. </p>

<p>When a Rails server gets a request from a web browser it first goes to the <em>router</em>. The router decides what the request is trying to do, what resources it is trying to interact with. The router dissects a request based on the address it is requesting and other HTTP parameters (like the request type of GET or PUT). Let&#8217;s open the router&#8217;s configuration file, <code>/config/routes.rb</code>.</p>

<p>Inside this file you&#8217;ll see a LOT of comments that show you different options for routing requests. Let&#8217;s remove everything <em>except</em> the first line (@ActionController &#8230;@) and the final <code>end</code>. Then, in between those two lines, add @resources :articles@ so your file looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Jsblogger</span><span class="o">::</span><span class="no">Application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">resources</span> <span class="ss">:articles</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>This line tells Rails that we have a resource named <code>articles</code> and the router should expect requests to follow the <em>RESTful</em> model of web interaction (REpresentational State Transfer). The details don&#8217;t matter right now, but when you make a request like <code>http://localhost:3000/articles/</code> the router will understand you&#8217;re looking for a listing of the articles or <code>http://localhost:3000/articles/new</code> means you&#8217;re trying to create a new article.</p>

<h4>Looking at the Routing Table</h4>

<p>Dealing with routes is commonly very challening for new Rails programmers. There&#8217;s a great tool that can make it easier on you. To get a list of the routes in your application, go to a command prompt and run <code>rake routes</code>. You&#8217;ll get a listing like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ rake routes
</span><span class='line'>    articles GET    /articles(.:format)          {:action=&gt;"index", :controller=&gt;"articles"}
</span><span class='line'>             POST   /articles(.:format)          {:action=&gt;"create", :controller=&gt;"articles"}
</span><span class='line'> new_article GET    /articles/new(.:format)      {:action=&gt;"new", :controller=&gt;"articles"}
</span><span class='line'>edit_article GET    /articles/:id/edit(.:format) {:action=&gt;"edit", :controller=&gt;"articles"}
</span><span class='line'>     article GET    /articles/:id(.:format)      {:action=&gt;"show", :controller=&gt;"articles"}
</span><span class='line'>             PUT    /articles/:id(.:format)      {:action=&gt;"update", :controller=&gt;"articles"}
</span><span class='line'>             DELETE /articles/:id(.:format)      {:action=&gt;"destroy", :controller=&gt;"articles"}</span></code></pre></td></tr></table></div></figure>

<p>Experiment with commenting out the <code>resources :articles</code> in <code>routes.rb</code> and running the command again. Un-comment the line after you see the results.</p>

<p>These are the seven core actions of Rails&#8217; REST implementation. To understand the table, let&#8217;s look at the first row as an example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>articles GET    /articles(.:format)          {:action=&gt;"index", :controller=&gt;"articles"}</span></code></pre></td></tr></table></div></figure>

<p>The left most column says <code>articles</code>. This is the <em>name</em> of the path. The router will provide two methods to us using that name, <code>articles_path</code> and <code>articles_url</code>. The <code>_path</code> version uses a relative path while the <code>_url</code> version uses the full URL with protocol, server, and path. The <code>_path</code> version is always preferred.</p>

<p>The second column, here <code>GET</code>, is the HTTP verb for the route. Web browsers typically submit requests with the verbs <code>GET</code> or <code>POST</code>. In this column, you&#8217;ll see other HTTP verbs including <code>PUT</code> and <code>DELETE</code> which browsers don&#8217;t actually use. We&#8217;ll talk more about those later.</p>

<p>The third column is similar to a regular expression which is matched against the requested URL. Elements in parentheses are optional. Markers starting with a <code>:</code> will be made available to the controller with that name. In our example line, <code>/articles(.:format)</code> will match the URLs <code>/articles/</code>, <code>/articles.json</code>, <code>/articles</code> and other similar forms.</p>

<p>The fourth column is where the route maps to in the applications. Our example has <code>{:action=&gt;&quot;index&quot;, :controller=&gt;&quot;articles&quot;}</code>, so requests will be sent to the <code>index</code> method of the <code>ArticlesController</code> class.</p>

<p>Now that the router knows how to handle requests about articles, it needs a place to actually send those requests, the <em>Controller</em>.</p>

<h3>Creating the Articles Controller</h3>

<p>We&#8217;re going to use another Rails generator but your terminal has the console currently running. Let&#8217;s open one more terminal or command propmt and move to your project directory which we&#8217;ll use for command-line scripts. In that new terminal, enter this command:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>rails generate controller articles</span></code></pre></td></tr></table></div></figure>

<p>The output shows that the generator created several files/folders for you:</p>

<ul>
<li><code>app/controllers/articles_controller.rb</code> : The controller file itself</li>
<li><code>app/views/articles</code> : The directory to contain the controller&#8217;s view templates</li>
<li><code>test/functional/articles_controller_test.rb</code> : The controller&#8217;s unit tests file</li>
<li><code>app/helpers/articles_helper.rb</code> : A helper file to assist with the views (discussed later)</li>
<li><code>test/unit/helpers/articles_helper_test.rb</code> : The helper&#8217;s unit test file</li>
<li><code>app/assets/javascripts/articles.js.coffee</code> : A CoffeeScript file for this controller</li>
<li><code>app/assets/stylesheets/articles.css.scss</code> : An SCSS stylesheet for this controller</li>
</ul>

<p>Let&#8217;s open up the controller file, <code>/app/controllers/articles_controller.rb</code>. You&#8217;ll see that this is basically a blank class, beginning with the <code>class</code> keyword and ending with the <code>end</code> keyword. Any code we add to the controller must go <em>between</em> these two lines.</p>

<h3>Defining the Index Action</h3>

<p>The first feature we want to add is an &quot;index&quot; page. This is what the app will send back when a user requests <code>http://localhost:3000/articles/</code> &#8211; following the RESTful conventions, this should be a list of the articles. So when the router sees this request come in, it tries to call the <code>index</code> action inside <code>articles_controller</code>.</p>

<p>Let&#8217;s first try it out by entering <code>http://localhost:3000/articles/</code> into your web browser. You should get an error message that looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Unknown action
</span><span class='line'>No action responded to index. Actions:</span></code></pre></td></tr></table></div></figure>

<p>The router tried to call the <code>index</code> action, but the articles controller doesn&#8217;t have a method with that name. It then lists available actions, but there aren&#8217;t any. This is because our controller is still blank. Let&#8217;s add the following method inside the controller:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">def</span> <span class="nf">index</span>
</span><span class='line'>    <span class="vi">@articles</span> <span class="o">=</span> <span class="no">Article</span><span class="o">.</span><span class="n">all</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<h4>Instance Variables</h4>

<p>What is that &quot;at&quot; sign doing on the front of <code>@articles</code>?  That marks this variable as an &quot;instance level variable&quot;. We want the list of articles to be accessible from both the controller and the view that we&#8217;re about to create. In order for it to be visible in both places it has to be an instance variable. If we had just named it <code>articles</code>, that local variable would only be available within the <code>index</code> method of the controller.</p>

<h3>Creating the Template</h3>

<p>Now refresh your browser. The error message changed, but you&#8217;ve still got an error, right?  </p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Template is missing
</span><span class='line'>Missing template articles/index.erb in view path app/views</span></code></pre></td></tr></table></div></figure>

<p>The error message is pretty helpful here. It tells us that the app is looking for a (view) template in <code>/app/views/articles/</code> but it can&#8217;t find one named <code>index.erb</code>. Rails has <em>assumed</em> that our <code>index</code> action in the controller should have a corresponding <code>index.erb</code> view template in the views folder. We didn&#8217;t have to put any code in the controller to tell it what view we wanted, Rails just figures it out.</p>

<p>In your editor, find the folder <code>app/views/articles</code> and, in that folder, create a file named <code>index.html.erb</code>.</p>

<h4>Naming Templates</h4>

<p>Why did we choose <code>index.html.erb</code> instead of the <code>index.erb</code> that the error message said it was looking for?  Putting the HTML in the name makes it clear that this view is for generating HTML. In later versions of our blog we might create an RSS feed which would just mean creating an XML view template like <code>index.xml.erb</code>. Rails is smart enough to pick the right one based on the browser&#8217;s request, so when we just ask for <code>http://localhost:3000/articles/</code> it will find the <code>index.html.erb</code> and render that file.</p>

<h4>Index Template Content</h4>

<p>Now you&#8217;re looking at a blank file. Enter in this view template code which is a mix of HTML and what are called ERB tags:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="no">All</span> <span class="no">Articles</span><span class="o">&lt;</span><span class="sr">/h1&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;ul&gt;</span>
</span><span class='line'><span class="sr">  &lt;% @articles.each do |article| %&gt;</span>
</span><span class='line'><span class="sr">    &lt;li&gt;</span>
</span><span class='line'><span class="sr">      &lt;%= article.title %&gt;</span>
</span><span class='line'><span class="sr">    &lt;/</span><span class="n">li</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="sx">% end %&gt;</span>
</span><span class='line'><span class="sx">&lt;/ul&gt;</span>
</span></code></pre></td></tr></table></div></figure>

<p>ERB is a templating language that allows us to mix Ruby into our HTML. There are only a few things to know about ERB:</p>

<ul>
<li>An ERB clause starts with <code>&lt;%</code> or <code>&lt;%=</code> and ends with <code>%&gt;</code></li>
<li>If the clause started with <code>&lt;%</code>, the result of the ruby code will be hidden</li>
<li>If the clause started with <code>&lt;%=</code>, the result of the ruby code will be output in place of the clause</li>
</ul>

<p>Save the file and refresh your web browser. You should see a listing of the articles you created in the console. We&#8217;ve got the start of a web application!</p>

<h3>Adding Navigation to the Index</h3>

<p>Right now our article list is very plain, let&#8217;s add some links.</p>

<p>When writing view templates we&#8217;ll use the <code>link_to</code> helper. It works like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">link_to</span> <span class="s2">&quot;Text You Want the Link to Say&quot;</span><span class="p">,</span> <span class="n">where_the_link_should_point</span>
</span></code></pre></td></tr></table></div></figure>

<h4>Looking at the Routing Table</h4>

<p>Remember when we looked at the Routing Table using <code>rake routes</code> from the command line? Look at the left-most column and you&#8217;ll see the route names. These are useful when creating links.</p>

<p>In the code above we have <code>where_the_link_should_point</code>. In that spot we&#8217;ll typically use a &quot;route helper&quot;. We want this link to display the single article which happens in the <code>show</code> action. Looking at the table, the name for that route is <code>article</code> and it requires a parameter <code>id</code> in the URL. The route helper we&#8217;ll use works like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">article_path</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>

<p>Would generate the string <code>&quot;/articles/1&quot;</code>. Give the method a different parameter and you&#8217;ll change the ID on the end.</p>

<h4>Completing the Article Links</h4>

<p>Back in <code>/app/views/articles/index.html.erb</code>, find where we have this line:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&lt;%=</span> <span class="n">article</span><span class="o">.</span><span class="n">title</span> <span class="o">%&gt;</span>
</span></code></pre></td></tr></table></div></figure>

<p>Instead, let&#8217;s use the <code>link_to</code> helper like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&lt;%=</span> <span class="n">link_to</span> <span class="n">article</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="n">article_path</span><span class="p">(</span><span class="n">article</span><span class="p">)</span> <span class="o">%&gt;</span>
</span></code></pre></td></tr></table></div></figure>

<p>When the template is rendered, it will output HTML like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;/articles/1&quot;</span><span class="nt">&gt;</span>First Sample Article<span class="nt">&lt;/a&gt;</span>
</span></code></pre></td></tr></table></div></figure>

<h4>New Article Link</h4>

<p>At the very bottom of the template, let&#8217;s add a link to the &quot;Create a New Article&quot; page.</p>

<p>We&#8217;ll use the <code>link_to</code> helper, we want it to display the text <code>&quot;Create a New Article&quot;</code>, and where should it point? Look in the routing table for the <code>new</code> action, that&#8217;s where the form to create a new article will live. You&#8217;ll find the name <code>new_article</code>, so the helper is <code>new_article_path</code>. Assemble those three parts and write the link in your template.</p>

<p>But wait, there&#8217;s one more thing. Our stylesheet for this project is going to look for a certain class on the link to make it look fancy. To add HTML attributes to a link, we include them in a Ruby hash style on the end like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&lt;</span><span class="sx">%= link_to article.title, article_path(article), :class =</span><span class="o">&gt;</span> <span class="s1">&#39;article_title&#39;</span> <span class="o">%&gt;</span>
</span></code></pre></td></tr></table></div></figure>

<p>Or, if you wanted to also have a CSS ID attribute:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&lt;</span><span class="sx">%= link_to article.title, article_path(article), </span>
</span><span class='line'><span class="sx">    :class =</span><span class="o">&gt;</span> <span class="s1">&#39;article_title&#39;</span><span class="p">,</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="s2">&quot;article_</span><span class="si">#{</span><span class="n">article</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">%&gt;</span>
</span></code></pre></td></tr></table></div></figure>

<p>Use that technique to add the CSS class <code>new_article</code> to your &quot;Create a New Article&quot; link.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&lt;</span><span class="sx">%= link_to &quot;New Article&quot;, new_article_path, :class =</span><span class="o">&gt;</span> <span class="s2">&quot;new_article&quot;</span> <span class="o">%&gt;</span>
</span></code></pre></td></tr></table></div></figure>

<h4>Review the Results</h4>

<p>Refresh your browser and each sample article title should be a link. If you click the link, you&#8217;ll get an error as we haven&#8217;t implemented the <code>show</code> method yet. Similarly, the new article link will lead you to a dead end. Let&#8217;s tackle the <code>show</code> next.</p>

<h3>Creating the SHOW Action</h3>

<p>Click the title link for one of your sample articles and you&#8217;ll get the &quot;Unknown Action&quot; error we saw before. Remember how we moved forward?</p>

<p>An &quot;action&quot; is just a method of the controller. Here we&#8217;re talking about the <code>ArticleController</code>, so our next step is to open <code>app/controllers/articles_controller.rb</code> and add a <code>show</code> method:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">show</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Refresh the browser and you&#8217;ll get the &quot;Template is Missing&quot; error. Let&#8217;s pause here before creating the view template.</p>

<h4>A Bit on Parameters</h4>

<p>Look at the URL: <code>http://localhost:3000/articles/1</code>. When we added the <code>link_to</code> in the index and pointed it to the <code>article_path</code> for this <code>article</code>, the router created this URL. Following the RESTful convention, this URL goes to a SHOW method which would display the Article with ID number <code>1</code>. Your URL might have a different number depending on which article title you clicked in the index.</p>

<p>So what do we want to do when the user clicks an article title?  Find the article, then display a page with its title and body. We&#8217;ll use the number on the end of the URL to find the article in the database. </p>

<p>Within the controller, we have access to a method named <code>params</code> which returns us a hash of the request parameters. Often we&#8217;ll refer to it as &quot;the <code>params</code> hash&quot;, but technically it&#8217;s &quot;the <code>params</code> method which returns a hash&quot;. </p>

<p>Within that hash we can find the <code>:id</code> from the URL by accessing the key <code>params[:id]</code>. Use this inside the <code>show</code> method of <code>ArticlesController</code> along with the class method <code>find</code> on the <code>Article</code> class:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="vi">@article</span> <span class="o">=</span> <span class="no">Article</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>

<h4>What is <code>@article</code></h4>

<p>The last line we wrote created an instance variable named <code>@article</code>. A normal Ruby instance variable is available to all methods within an instance.</p>

<p>In Rails&#8217; controllers, there&#8217;s a <em>hack</em> which allows instance variables to be automatically transferred from the controller to the object which renders the view template. So any data we want available in the view template should be promoted to an instance variable by adding a <code>@</code> to the beginning.</p>

<p>There are ways to accomplish the same goals without instance variables, but they&#8217;re not widely used. Check out the <a href="https://github.com/voxdolo/decent_exposure">Decent Exposure</a> gem to learn more.</p>

<h4>Back to the Template</h4>

<p>Refresh your browser and we still have the &quot;Template is Missing&quot; error. Create the file <code>/app/views/articles/show.html.erb</code> and add this code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='erb'><span class='line'><span class="x">&lt;h1&gt;</span><span class="cp">&lt;%=</span> <span class="vi">@article</span><span class="o">.</span><span class="n">title</span> <span class="cp">%&gt;</span><span class="x">&lt;/h1&gt;</span>
</span><span class='line'><span class="x">&lt;p&gt;</span><span class="cp">&lt;%=</span> <span class="vi">@article</span><span class="o">.</span><span class="n">body</span> <span class="cp">%&gt;</span><span class="x">&lt;/p&gt;</span>
</span><span class='line'><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;&lt;&lt; Back to Articles List&quot;</span><span class="p">,</span> <span class="n">articles_path</span> <span class="cp">%&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>

<p>Refresh your browser and your article should show up along with a link back to the index. We can now navigate from the index to a show page and back.</p>

<h3>Styling</h3>

<p>This is not a CSS project, so to make it a bit more fun we&#8217;ve prepared a CSS file you can drop in. It should match up with all the example HTML in the tutorial.</p>

<p>Download the file from <a href="http://tutorials.jumpstartlab.com/assets/jsblogger/screen.css"><a href="http://tutorials.jumpstartlab.com/assets/jsblogger/screen.css">http://tutorials.jumpstartlab.com/assets/jsblogger/screen.css</a></a> and place it in your <code>/app/assets/stylesheets/</code> folder. It will be automatically picked up by your project.</p>

<h2>I1: Form-based Workflow</h2>

<p>We&#8217;ve created sample articles from the console, but that isn&#8217;t a viable long-term solution. The users of our app will expect to add content through a web interface. In this iteration we&#8217;ll create an HTML form to submit the article, then all the backend processing to get it into the database.</p>

<h3>Creating the NEW Action and View</h3>

<p>Previously we setup the @resources :articles@ route in <code>routes.rb</code>, and that told Rails that we were going to follow the RESTful conventions for this model named Article. Following this convention, the URL for creating a new article would be <code>http://localhost:3000/articles/new</code>. From the articles index, click your &quot;Create a New Article&quot; link and it should go to this path. </p>

<p>Then you&#8217;ll see an &quot;Unknown Action&quot; error. The router went looking for an action named <code>new</code> inside the <code>ArticlesController</code> and didn&#8217;t find it. </p>

<p>First let&#8217;s create that action. Open <code>/app/controllers/articles_controller.rb</code> and add this method, making sure it&#8217;s <em>inside</em> the <code>ArticlesController</code> class, but <em>outside</em> the existing <code>index</code> and <code>show</code> methods:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">def</span> <span class="nf">new</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<h4>Starting the Template</h4>

<p>With that defined, refresh your browser and you should get the &quot;Template is Missing&quot; error.</p>

<p>Create a new file <code>/app/views/articles/new.html.erb</code> with these contents:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="no">Create</span> <span class="n">a</span> <span class="no">New</span> <span class="no">Article</span><span class="o">&lt;</span><span class="sr">/h1&gt;</span>
</span></code></pre></td></tr></table></div></figure>

<p>Refresh your browser and you should just see the heading &quot;Create a New Article&quot;.</p>

<div class="note">
<p>Why the name <code>new.html.erb</code>? The first piece, <code>new</code>, matches the name of the controller method. The second, <code>html</code>, specifies the output format sent to the client. The third, <code>erb</code>, specifies the language the template is written in. Under different circumstances, we might use <code>new.json.erb</code> to output JSON or <code>new.html.haml</code> to use the HAML templating language.</p>
</div>

<h3>Writing a Form</h3>

<p>It&#8217;s not very impressive so far &#8211; we need to add a form to the <code>new.html.erb</code> so the user can enter in the article title and body. Because we&#8217;re following the RESTful conventions, Rails can take care of many of the details. Inside that <code>erb</code> file, enter this code below your header:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&lt;</span><span class="sx">%= form_for(@article) do |f| %&gt;</span>
</span><span class='line'><span class="sx">  &lt;p&gt;</span>
</span><span class='line'><span class="sx">    &lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:title</span> <span class="sx">%&gt;&lt;br /&gt;</span>
</span><span class='line'>    <span class="o">&lt;</span><span class="sx">%= f.text_field :title %&gt;</span>
</span><span class='line'><span class="sx">  &lt;/p&gt;</span>
</span><span class='line'><span class="sx">  &lt;p&gt;</span>
</span><span class='line'><span class="sx">    &lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:body</span> <span class="sx">%&gt;&lt;br /&gt;</span>
</span><span class='line'>    <span class="o">&lt;</span><span class="sx">%= f.text_area :body %&gt;</span>
</span><span class='line'><span class="sx">  &lt;/p&gt;</span>
</span><span class='line'><span class="sx">  &lt;p&gt;</span>
</span><span class='line'><span class="sx">    &lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s1">&#39;Create&#39;</span> <span class="sx">%&gt;</span>
</span><span class='line'><span class="sx">  &lt;/p&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="sx">% end </span><span class="o">%&gt;</span>
</span></code></pre></td></tr></table></div></figure>

<p>What is all that?  Let&#8217;s look at it piece by piece:</p>

<ul>
<li><code>form_for</code> is a Rails helper method which takes one parameter, in this case <code>@article</code> and a block with the form fields. The first line basically says &quot;Create a form for the object named <code>@article</code>, refer to the form by the name <code>f</code> and add the following elements to the form&#8230;&quot;</li>
<li>The <code>f.label</code> helper creates an HTML label for a field, this is good usability practice and will have some other benefits for us later</li>
<li>The <code>f.text_field</code> helper creates a single-line text box named <code>title</code></li>
<li>The <code>f.text_area</code> helper creates a multi-line text box named <code>body</code></li>
<li>The <code>f.submit</code> helper creates a button labeled &quot;Create&quot;</li>
</ul>

<h4>Does it Work?</h4>

<p>Refresh your browser and you&#8217;ll see this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>NoMethodError in Articles#new
</span><span class='line'>Showing /Users/jcasimir/Dropbox/Projects/jsblogger_codemash/app/views/articles/new.html.erb where line #3 raised:
</span><span class='line'>undefined method `model_name' for NilClass:Class</span></code></pre></td></tr></table></div></figure>

<p>Huh? We didn&#8217;t call a method <code>model_name</code>?</p>

<p>We didn&#8217;t <em>explicitly</em>, but the <code>model_name</code> method is called by <code>form_for</code>. What&#8217;s happening here is that we&#8217;re passing <code>@article</code> to <code>form_for</code>. Since we haven&#8217;t created an <code>@article</code> in this action, the variable just holds <code>nil</code>. The <code>form_for</code> method calls <code>model_name</code> on <code>nil</code>, generating the error above.</p>

<h4>Setting up for Reflection</h4>

<p>Rails uses some of the <em>reflection</em> techniques that we talked about earlier in order to setup the form. Remember in the console when we called <code>Article.new</code> to see what fields an <code>Article</code> has? Rails wants to do the same thing, but we need to create the blank object for it. Go into your <code>articles_controller.rb</code>, and <em>inside</em> the <code>new</code> method, add this line:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="vi">@article</span> <span class="o">=</span> <span class="no">Article</span><span class="o">.</span><span class="n">new</span>
</span></code></pre></td></tr></table></div></figure>

<p>Then refresh your browser and your form should come up. Enter in a title, some body text, and click CREATE.</p>

<h3>The <code>create</code> Action</h3>

<p>Your old friend pops up again&#8230;</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Unknown action
</span><span class='line'>The action 'create' could not be found for ArticlesController</span></code></pre></td></tr></table></div></figure>

<p>We accessed the <code>new</code> action to load the form, but Rails&#8217; interpretation of REST uses a second action named <code>create</code> to process the data from that form. Inside your <code>articles_controller.rb</code> add this method (again, <em>inside</em> the <code>ArticlesContoller</code> class, but <em>outside</em> the other methods):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">def</span> <span class="nf">create</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Refresh the page and you&#8217;ll get the &quot;Template is Missing&quot; error.</p>

<h4>We Don&#8217;t Always Need Templates</h4>

<p>When you click the &quot;Create&quot; button, what would you expect to happen? Most web applications would process the data submitted then show you the object. In this case, display the article.</p>

<p>We already have an action and template for displaying an article, the <code>show</code>, so there&#8217;s no sense in creating another template to do the same thing.</p>

<h4>Processing the Data</h4>

<p>Before we can send the client to the <code>show</code>, let&#8217;s process the data. The data from the form will be accesible through the <code>params</code> method.</p>

<p>To check out the structure and content of <code>params</code>, I like to use this trick:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">create</span>
</span><span class='line'>  <span class="k">raise</span> <span class="n">params</span><span class="o">.</span><span class="n">inspect</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>The <code>raise</code> method creates a Ruby <code>RuntimeException</code>. The method accepts a string which will be the message displayed for the error. Calling <code>.inspect</code> on any Ruby object gives us the &quot;debugging representation&quot; of that object. All together, this will generate an error where the hash returned by <code>params</code> is displayed as the message. </p>

<p>Refresh/resubmit the page in your browser.</p>

<h4>Understanding Form Parameters</h4>

<p>The page will say &quot;RuntimeError&quot;, but the interesting part is the message. Mine looks like this (I&#8217;ve inserted line breaks for readability):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="p">{</span><span class="s2">&quot;utf8&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;✓&quot;</span><span class="p">,</span> <span class="s2">&quot;authenticity_token&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;UDbJdVIJjK+qim3m3N9qtZZKgSI0053S7N8OkoCmDjA=&quot;</span><span class="p">,</span>
</span><span class='line'> <span class="s2">&quot;article&quot;</span><span class="o">=&gt;</span><span class="p">{</span><span class="s2">&quot;title&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;Fourth Sample&quot;</span><span class="p">,</span> <span class="s2">&quot;body&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;This is my fourth sample article.&quot;</span><span class="p">},</span>
</span><span class='line'> <span class="s2">&quot;commit&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;Create&quot;</span><span class="p">,</span> <span class="s2">&quot;action&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;create&quot;</span><span class="p">,</span> <span class="s2">&quot;controller&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;articles&quot;</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>What are all those? We see the <code>{</code> and <code>}</code> on the outside, representing a <code>Hash</code>. Within the hash we see keys:</p>

<ul>
<li><code>utf8</code> : This meaningless checkmark is a hack to force Internet Explorer to submit the form using UTF-8. <a href="http://stackoverflow.com/questions/3222013/what-is-the-snowman-param-in-rails-3-forms-for">Read more on StackOverflow</a></li>
<li><code>authenticity_token</code> : Rails has some built-in security mechanisms to resist &quot;cross-site request forgery&quot;. Basically, this value proves that the client fetched the from from your site before submitting the data.</li>
<li><code>article</code> : Points to a nested hash with the data from the form itself

<ul>
<li><code>title</code> : The title from the form</li>
<li><code>body</code> : The body from the form</li>
</ul></li>
<li><code>commit</code> : This key holds the text of the button they clicked. From the server side, clicking a &quot;Save&quot; or &quot;Cancel&quot; button look exactly the same except for this parameter.</li>
<li><code>action</code> : Which controller action is being activated for this request</li>
<li><code>controller</code> : Which controller class is being activated for this request</li>
</ul>

<h4>Pulling Out Form Data</h4>

<p>Now that we&#8217;ve seen the structure, we can access the form data to mimic the way we created sample objects in the console. In the <code>create</code> action, remove the <code>raise</code> instruction and, instead, try this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">create</span>
</span><span class='line'>  <span class="vi">@article</span> <span class="o">=</span> <span class="no">Article</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>  <span class="vi">@article</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:article</span><span class="o">][</span><span class="ss">:title</span><span class="o">]</span>
</span><span class='line'>  <span class="vi">@article</span><span class="o">.</span><span class="n">save</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>If you refresh the page in your browser you&#8217;ll still get the template error. Add one more line to the action, the redirect:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">redirect_to</span> <span class="n">article_path</span><span class="p">(</span><span class="vi">@article</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>

<p>Refresh the page and you should go to the show for your new article. (<em>NOTE</em>: You&#8217;ve now created the same sample article twice)</p>

<h4>More Body</h4>

<p>The <code>show</code> page has the title, but where&#8217;s the body? Add a line to the action to pull out the <code>:body</code> key from the <code>params</code> hash and store it into <code>@article</code>.</p>

<p>Then try it again in your browser. Both the <code>title</code> and <code>body</code> should show up properly.</p>

<h4>Fragile Controllers</h4>

<p>Controllers are middlemen in the MVC framework. They should know as little as necessary about the other components to get the job done. This controller action knows too much about our model.</p>

<p>To clean it up, let me first show you a second way to create an instance of <code>Article</code>. You can call <code>new</code> and pass it a hash of attributes, like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">def</span> <span class="nf">create</span>
</span><span class='line'>    <span class="vi">@article</span> <span class="o">=</span> <span class="no">Article</span><span class="o">.</span><span class="n">new</span><span class="p">(</span>
</span><span class='line'>      <span class="ss">:title</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:article</span><span class="o">][</span><span class="ss">:title</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>      <span class="ss">:body</span>  <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:article</span><span class="o">][</span><span class="ss">:body</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@article</span><span class="o">.</span><span class="n">save</span>
</span><span class='line'>    <span class="n">redirect_to</span> <span class="n">article_path</span><span class="p">(</span><span class="vi">@article</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Try that in your app, if you like, and it&#8217;ll work just fine.</p>

<p>But look at what we&#8217;re doing. <code>params</code> gives us back a hash, <code>params[:article]</code> gives us back the nested hash, and <code>params[:article][:title]</code> gives us the string from the form. We&#8217;re hopping into <code>params[:article]</code> to pull its data out and stick it right back into a hash with the same keys/structure.</p>

<p>There&#8217;s no point in that! Instead, just pass the whole hash:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">def</span> <span class="nf">create</span>
</span><span class='line'>    <span class="vi">@article</span> <span class="o">=</span> <span class="no">Article</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:article</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@article</span><span class="o">.</span><span class="n">save</span>
</span><span class='line'>    <span class="n">redirect_to</span> <span class="n">article_path</span><span class="p">(</span><span class="vi">@article</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Test and you&#8217;ll find that it still works just the same. So what&#8217;s the point?</p>

<p>This is less <em>fragile</em>. If we add a new field to our model, say <code>author_name</code>, then we just have to add it to the form. Nothing needs to change about the controller. There&#8217;s less to go wrong.</p>

<h3>Deleting Articles</h3>

<p>We can create articles and we can display them, but when we eventually deliver this to less perfect people than us, they&#8217;re going to make mistakes. There&#8217;s no way to remove an article, let&#8217;s add that next.</p>

<p>We could put delete links on the index page, but instead let&#8217;s add them to the <code>show.html.erb</code> template. Let&#8217;s figure out how to create the link.</p>

<p>We&#8217;ll start with the <code>link_to</code> helper, and we want it to say the word &quot;delete&quot; on the link. So that&#8217;d be:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='erb'><span class='line'><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;delete&quot;</span><span class="p">,</span> <span class="n">some_path</span> <span class="cp">%&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>

<p>But what should <code>some_path</code> be? Look at the routes table with <code>rake routes</code>. The <code>destroy</code> action will be the last row, but it has no name in the left column. In this table the names &quot;trickle down,&quot; so look up two lines and you&#8217;ll see the name <code>article</code>. </p>

<p>The helper method for the destroy-triggering route is <code>article_path</code>. It needs to know which article to delete since there&#8217;s an <code>:id</code> in the path, so our link will look like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='erb'><span class='line'><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;delete&quot;</span><span class="p">,</span> <span class="n">article_path</span><span class="p">(</span><span class="vi">@article</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>

<p>Go to your browser, load the show page, click the link, and observe what happens.</p>

<h4>REST is about Path and Verb</h4>

<p>Why isn&#8217;t the article being deleted? If you look at the server window, this is the response to our link clicking:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Started GET "/articles/3" for 127.0.0.1 at 2012-01-08 13:05:39 -0500
</span><span class='line'>  Processing by ArticlesController#show as HTML
</span><span class='line'>  Parameters: {"id"=&gt;"3"}
</span><span class='line'>  Article Load (0.1ms)  SELECT "articles".* FROM "articles" WHERE "articles"."id" = ? LIMIT 1  [["id", "3"]]
</span><span class='line'>Rendered articles/show.html.erb within layouts/application (5.2ms)
</span><span class='line'>Completed 200 OK in 13ms (Views: 11.2ms | ActiveRecord: 0.3ms)</span></code></pre></td></tr></table></div></figure>

<p>Compare that to what we see in the routes table:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>         DELETE /articles/:id(.:format)      {:action=&gt;"destroy", :controller=&gt;"articles"}</span></code></pre></td></tr></table></div></figure>

<p>The path <code>&quot;/articles/3&quot;</code> matches the route pattern <code>/articles/:id</code>, but look at the verb. The server is seeing a <code>GET</code> request, but the route needs a <code>DELETE</code> verb. How do we make our link trigger a <code>DELETE</code>?</p>

<p>You can&#8217;t, exactly. Browsers should implement all four verbs, <code>GET</code>, <code>PUT</code>, <code>POST</code>, and <code>DELETE</code>. But they don&#8217;t, most only use <code>GET</code> and <code>POST</code>. So what are we to do?</p>

<p>Rails&#8217; solution to this problem is to <em>fake</em> a <code>DELETE</code> verb. In your view template, you can add another attribute to the link like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='erb'><span class='line'><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;delete&quot;</span><span class="p">,</span> <span class="n">article_path</span><span class="p">(</span><span class="vi">@article</span><span class="p">),</span> <span class="ss">:method</span> <span class="o">=&gt;</span> <span class="ss">:delete</span> <span class="cp">%&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>

<p>Through some JavaScript tricks, Rails can now pretend that clicking this link triggers a <code>DELETE</code>. Try it in your browser.</p>

<h4>The <code>destroy</code> Action</h4>

<p>Now that the router is recognizing our click as a delete, we need the action. The HTTP verb is <code>DELETE</code>, but the Rails method is <code>destroy</code>, which is a bit confusing.</p>

<p>Let&#8217;s define the <code>destroy</code> method in our <code>ArticlesController</code> so it:</p>

<ol>
<li>Uses <code>params[:id]</code> to find the article in the database</li>
<li>Calls <code>.destroy</code> on that object</li>
<li>Redirects to the articles index page</li>
</ol>

<p>Do that now on your own and test it.</p>

<h4>Confirming Deletion</h4>

<p>There&#8217;s one more parameter you might want to add to your <code>link_to</code> call:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="ss">:confirm</span> <span class="o">=&gt;</span> <span class="s2">&quot;Really delete the article?&quot;</span>
</span></code></pre></td></tr></table></div></figure>

<p>This will popup a JavaScript dialog when the link is clicked. The cancel button will stop the request, while the OK will submit it for deletion.</p>

<h3>Creating an Edit Action &amp; View</h3>

<p>Sometimes we don&#8217;t want to destroy an entire object, we just want to make some changes. We need an edit workflow.</p>

<p>In the same way that we used <code>new</code> to display the form and <code>create</code> to process that form&#8217;s data, we&#8217;ll use <code>edit</code> to display the edit form and <code>update</code> to save the changes.</p>

<h4>Adding the Edit Link</h4>

<p>Again in <code>show.html.erb</code>, let&#8217;s add this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='erb'><span class='line'><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;edit&quot;</span><span class="p">,</span> <span class="n">edit_article_path</span><span class="p">(</span><span class="vi">@article</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>

<p>Trigger the <code>edit_article</code> route and pass in the <code>@article</code> object. Try it!</p>

<h4>Implementing the <code>edit</code> Action</h4>

<p>The router is expecting to find an action in <code>ArticlesController</code> named <code>edit</code>, so let&#8217;s add this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">def</span> <span class="nf">edit</span>
</span><span class='line'>    <span class="vi">@article</span> <span class="o">=</span> <span class="no">Article</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>All the <code>edit</code> action does is find the object and display the form. Refresh and you&#8217;ll see the template missing error. </p>

<h4>An Edit Form</h4>

<p>Create a file <code>/app/views/articles/edit.html.erb</code> but <em>hold on before you type anything</em>. Below is what the edit form would look like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="no">Edit</span> <span class="n">an</span> <span class="no">Article</span><span class="o">&lt;</span><span class="sr">/h1&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;%= form_for(@article) do|f| %&gt;</span>
</span><span class='line'><span class="sr">  &lt;%= f.error_messages %&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">  &lt;p&gt;</span>
</span><span class='line'><span class="sr">    &lt;%= f.label :title %&gt;&lt;br /</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="o">&lt;</span><span class="sx">%= f.text_field :title %&gt;</span>
</span><span class='line'><span class="sx">  &lt;/p&gt;</span>
</span><span class='line'><span class="sx">  &lt;p&gt;</span>
</span><span class='line'><span class="sx">    &lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:body</span> <span class="sx">%&gt;&lt;br /&gt;</span>
</span><span class='line'>    <span class="o">&lt;</span><span class="sx">%= f.text_area :body %&gt;</span>
</span><span class='line'><span class="sx">  &lt;/p&gt;</span>
</span><span class='line'><span class="sx">  &lt;p&gt;</span>
</span><span class='line'><span class="sx">    &lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s1">&#39;Update&#39;</span> <span class="sx">%&gt;</span>
</span><span class='line'><span class="sx">  &lt;/p&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="sx">% end </span><span class="o">%&gt;</span>
</span></code></pre></td></tr></table></div></figure>

<p>In the Ruby community there is a mantra of &quot;Don&#8217;t Repeat Yourself&quot; &#8211; but that&#8217;s exactly what I&#8217;ve done here. This view is basically the same as the <code>new.html.erb</code> &#8211; the only changes are the H1 and the name of the button. We can abstract this form into a single file called a <em>partial</em>, then reference this partial from both <code>new.html.erb</code> and <code>edit.html.erb</code>.</p>

<h4>Creating a Form Partial</h4>

<p>Partials are a way of packaging reusable view template code. We&#8217;ll pull the common parts out from the form into the partial, then render that partial from both the new template and the edit template.</p>

<p>Create a file <code>/app/views/articles/_form.html.erb</code> and, yes, it has to have the underscore at the beginning of the filename. Partials always start with an underscore. </p>

<p>Open your <code>/app/views/articles/new.html.erb</code> and CUT all the text from and including the <code>form_for</code> line all the way to its <code>end</code>. The only thing left will be your H1 line. </p>

<p>Add the following code to that view:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&lt;</span><span class="sx">%= render :partial =</span><span class="o">&gt;</span> <span class="s1">&#39;form&#39;</span> <span class="o">%&gt;</span>
</span></code></pre></td></tr></table></div></figure>

<p>Now go back to the <code>_form.html.erb</code> and paste the code from your clipboard. Change the text on the <code>submit</code> button to say &quot;Save&quot; so it makes sense both when creating a new article and editing and existing one.</p>

<h4>Writing the Edit Template</h4>

<p>Then look at your <code>edit.html.erb</code> file. You already have an H1 header, so add the line which renders the partial.</p>

<h4>Testing the Partial</h4>

<p>Go back to your articles list and try creating a new article &#8211; it should work just fine. Try editing an article and you should see the form with the existing article&#8217;s data &#8211; it works OK until you click SAVE.</p>

<h4>Implementing Update</h4>

<p>The router is looking for an action named <code>update</code>. Just like the <code>new</code> action sends its form data to the <code>create</code> action, the <code>edit</code> action sends its form data to the <code>update</code> action. In fact, within our <code>articles_controller.rb</code>, the <code>update</code> method will look very similar to <code>create</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">def</span> <span class="nf">update</span>
</span><span class='line'>    <span class="vi">@article</span> <span class="o">=</span> <span class="no">Article</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@article</span><span class="o">.</span><span class="n">update_attributes</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:article</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>    <span class="n">redirect_to</span> <span class="n">article_path</span><span class="p">(</span><span class="vi">@article</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>The only new bit here is the <code>update_attributes</code> method. It&#8217;s very similar to <code>Article.new</code> where you can pass in the hash of form data. It changes the values in the object to match the values submitted with the form. One differece from <code>new</code> is that <code>update_attributes</code> automatically saves the changes.</p>

<p>Now try editing and saving some of your articles.</p>

<h3>Adding a Flash</h3>

<p>Our operations are working, but it would be nice if we gave the user some kind of status message about what took place. When we create an article the message might say &quot;Article &#8216;the-article-title&#8217; was created&quot;, or &quot;Article &#8216;the-article-title&#8217; was removed&quot; for the remove action. We can accomplish this with the <code>flash</code>.</p>

<p>The controller provides you two methods to interact with the <code>flash</code>. Calling <code>flash[:notice]</code> will fetch a value from the flash, or <code>flash[:notice] = &quot;Your Message&quot;</code> will store the string in the <code>flash</code>. So it looks and acts just like a hash.</p>

<h4>Flash for Update</h4>

<p>Let&#8217;s look first at the <code>update</code> method we just worked on. It currently looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">def</span> <span class="nf">update</span>
</span><span class='line'>    <span class="vi">@article</span> <span class="o">=</span> <span class="no">Article</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@article</span><span class="o">.</span><span class="n">update_attributes</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:article</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>    <span class="n">redirect_to</span> <span class="n">article_path</span><span class="p">(</span><span class="vi">@article</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>We can add a flash message by inserting one line:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">def</span> <span class="nf">update</span>
</span><span class='line'>    <span class="vi">@article</span> <span class="o">=</span> <span class="no">Article</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@article</span><span class="o">.</span><span class="n">update_attributes</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:article</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>    <span class="n">flash</span><span class="o">[</span><span class="ss">:message</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Article &#39;</span><span class="si">#{</span><span class="vi">@article</span><span class="o">.</span><span class="n">title</span><span class="si">}</span><span class="s2">&#39; Updated!&quot;</span>
</span><span class='line'>    <span class="n">redirect_to</span> <span class="n">article_path</span><span class="p">(</span><span class="vi">@article</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<h4>Testing the Flash</h4>

<p>Try editing and saving an article through your browser. Does anything show up?</p>

<p>We need to add the flash to our view templates. The <code>update</code> method redirects to the <code>show</code>, so we <em>could</em> just add the display to our show template.</p>

<p>However, we will use the flash in many actions of the application. Most of the time, it&#8217;s preferred to add it to our layout.</p>

<h4>Flash in the Layout</h4>

<p>If you look in <code>/app/views/layouts/application.html.erb</code> you&#8217;ll find what is called the &quot;application layout&quot;. A layout is used to wrap multiple view templates in your application. You can create layouts specific to each controller, but most often we&#8217;ll just use one layout that wraps every view template in the application.</p>

<p>Looking at the default layout, you&#8217;ll see this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='erb'><span class='line'><span class="x">&lt;!DOCTYPE html&gt;</span>
</span><span class='line'><span class="x">&lt;html&gt;</span>
</span><span class='line'><span class="x">&lt;head&gt;</span>
</span><span class='line'><span class="x">  &lt;title&gt;JsbloggerCodemash&lt;/title&gt;</span>
</span><span class='line'><span class="x">  </span><span class="cp">&lt;%=</span> <span class="n">stylesheet_link_tag</span>    <span class="s2">&quot;application&quot;</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">  </span><span class="cp">&lt;%=</span> <span class="n">javascript_include_tag</span> <span class="s2">&quot;application&quot;</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">  </span><span class="cp">&lt;%=</span> <span class="n">csrf_meta_tags</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">&lt;/head&gt;</span>
</span><span class='line'><span class="x">&lt;body&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="cp">&lt;%=</span> <span class="k">yield</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class='line'>
</span><span class='line'><span class="x">&lt;/body&gt;</span>
</span><span class='line'><span class="x">&lt;/html&gt;</span>
</span></code></pre></td></tr></table></div></figure>

<p>The <code>yield</code> is where the view template content will be injected. Just <em>above</em> that yield, let&#8217;s display the flash by adding this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='erb'><span class='line'><span class="x">&lt;p class=&quot;flash&quot;&gt;</span><span class="cp">&lt;%=</span> <span class="n">flash</span><span class="o">[</span><span class="ss">:message</span><span class="o">]</span> <span class="cp">%&gt;</span><span class="x">&lt;/p&gt;</span>
</span></code></pre></td></tr></table></div></figure>

<p>This outputs the value stored in the <code>flash</code> object with the key <code>:message</code>.</p>

<h4>More Flash Testing</h4>

<p>With the layout modified, try changing your article, clicking save, and you should see the flash message appear at the top of the <code>show</code> page.</p>

<h4>Adding More Messages</h4>

<p>Typical controllers will set flash messages in the <code>update</code>, <code>create</code>, and <code>destroy</code> actions. Insert messages into the latter two actions now.</p>

<p>Test out each action/flash, then you&#8217;re done with I1.</p>

<div class="note">
<p>This is as far as we&#8217;ve revised for Rails 3.1. Later sections should still be &#8220;good&#8221;, but they&#8217;re not going to be perfect. We&#8217;ll continue working on it this month, January 2012.</p>
</div>

<h2>I2: Adding Comments</h2>

<p>Most blogs allow the reader to interact with the content by posting comments. Let&#8217;s add some simple comment functionality.</p>

<h3>Designing the Comment Model</h3>

<p>First, we need to brainstorm what a comment <em>is</em>&#8230;what kinds of data does it have&#8230;</p>

<ul>
<li>It&#8217;s attached to an article</li>
<li>It has an author name</li>
<li>It usually has an author email address</li>
<li>It usually has an optional URL</li>
<li>It has a body</li>
</ul>

<p>With that understanding, let&#8217;s create a Comment model. Switch over to your terminal and enter this line:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>rails generate model Comment</span></code></pre></td></tr></table></div></figure>

<p>We&#8217;ve already gone through what files this generator creates, we&#8217;ll be most interested in the migration file and the <code>comment.rb</code>.</p>

<h3>Setting up the Migration</h3>

<p>Open the migration file that the generator created, <code>/db/migrate/some-timestamp_create_comments.rb</code>. Inside the <code>change</code> you need to add one line for each of the pieces of data we just brainstormed. It&#8217;ll start off with these&#8230;</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">t</span><span class="o">.</span><span class="n">integer</span> <span class="ss">:article_id</span>
</span><span class='line'><span class="n">t</span><span class="o">.</span><span class="n">string</span> <span class="ss">:author_name</span>
</span></code></pre></td></tr></table></div></figure>

<p>Then keep adding lines that create strings named <code>:author_email</code>, <code>:author_url</code>, and a text field named <code>:body</code>.</p>

<p>Once that&#8217;s complete, go to your terminal and run the migration with @rake db:migrate@.</p>

<h3>Relationships</h3>

<p>The power of SQL databases is the ability to express relationships between elements of data. We can join together the information about an order with the information about a customer. Or in our case here, join together an article (in the articles table) with its comments (in the comments table). We do this by using foreign keys.</p>

<p>Foreign keys are a way of marking one-to-one and one-to-many relationships. An article might have zero, five, or one hundred comments. But a comment only belongs to one article. These objects have a one-to-many relationship &#8211; one article connects to many comments.</p>

<p>Part of the big deal with Rails is that it makes working with these relationships very easy. When we created the migration for comments we started with an <code>integer</code> field named <code>article_id</code>. The Rails convention is that, for a one-to-many relationship, the objects on the &quot;many&quot; end should have a foreign key referencing the &quot;one&quot; object. And that foreign key should be titled with the name of the &quot;one&quot; object, then an underscore, then &quot;id&quot;. So in this case one article has many comments, so each comment has a field named <code>article_id</code> which tracks which article they belong to. Similarly, a store&#8217;s customer might have many orders, so each order would have a <code>customer_id</code> specifying which customer they belong to.</p>

<p>Following this convention will get us a lot of functionality &quot;for free.&quot;  Open your <code>/app/models/comment.rb</code> and add the middle line so it looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Comment</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">belongs_to</span> <span class="ss">:article</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>A comment relates to a single article, it &quot;belongs to&quot; an article. We then want to declare the other side of the relationship inside <code>/app/models/article.rb</code> like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Article</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">has_many</span> <span class="ss">:comments</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>How an article &quot;has many&quot; comments, and a comment &quot;belongs to&quot; an article. We have explained to Rails that these objects have a one-to-many relationship.</p>

<h3>Testing in the Console</h3>

<p>Let&#8217;s use the console to test how this relationship works in code. If you don&#8217;t have a console open, go to your terminal and enter @rails console@ from your project directory. If you have a console open already, enter the command <code>reload!</code> to refresh any code changes.</p>

<p>Run the following commands one at a time and observe the output:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>a = Article.first
</span><span class='line'>a.comments
</span><span class='line'>Comment.new
</span><span class='line'>a.comments.new</span></code></pre></td></tr></table></div></figure>

<p>When you called the <code>comments</code> method on object <code>a</code>, it gave you back a blank array because that article doesn&#8217;t have any comments. When you executed <code>Comment.new</code> it gave you back a blank Comment object with those fields we defined in the migration. But, if you look closely, when you did <code>a.comments.new</code> the comment object you got back wasn&#8217;t quite blank &#8211; it has the <code>article_id</code> field already filled in with the ID number of article <code>a</code>.</p>

<p>Try creating a few comments for that article like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>c = a.comments.new
</span><span class='line'>c.author_name = "Daffy Duck"
</span><span class='line'>c.author_url = "http://daffyduck.com"
</span><span class='line'>c.body = "I think this article is thhh-thhh-thupid!"
</span><span class='line'>c.save
</span><span class='line'>d = a.comments.create(:author_name =&gt; "Chewbacca", :body =&gt; "RAWR!")</span></code></pre></td></tr></table></div></figure>

<p>For the first comment, <code>c</code>, I used a series of commands like we&#8217;ve done before. For the second comment, <code>d</code>, I used the <code>create</code> method. When you use <code>new</code> it doesn&#8217;t go to the database until you call <code>save</code>. With <code>create</code> you usually pass in the attributes then the object is created, those attributes set, and the object saved to the database all in one step.</p>

<p>Now that you&#8217;ve created a few comments, try executing <code>a.comments</code> again. Did your comments all show up?  When I did it, only one comment came back. The console tries to minimize the number of times it talks to the database, so sometimes if you ask it to do something it&#8217;s already done, it&#8217;ll get the information from the cache instead of really asking the database &#8211; giving you the same answer it gave the first time. That can be annoying. To force it to clear the cache and lookup the accurate information, try this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>reload!
</span><span class='line'>a = Article.first
</span><span class='line'>a.comments</span></code></pre></td></tr></table></div></figure>

<p>So you&#8217;ll see that the article has comments &#8211; great. Now we need to integrate them into the article display.</p>

<h3>Displaying Comments for an Article</h3>

<p>We want to display any comments underneath their parent article. Because we&#8217;ve setup the relationships between those models, this is very easy. Open <code>/app/views/articles/show.html.erb</code> and add the following lines right before the link to the articles list:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&lt;</span><span class="n">h3</span><span class="o">&gt;</span><span class="no">Comments</span><span class="o">&lt;</span><span class="sr">/h3&gt;</span>
</span><span class='line'><span class="sr">&lt;%= render :partial =&gt; &#39;comment&#39;, :collection =&gt; @article.comments %&gt;</span>
</span></code></pre></td></tr></table></div></figure>

<p>This says that we want to render a partial named &quot;comment&quot; and that we want to do it once for each element in the collection <code>@article.comments</code>. We saw in the console that when we call the <code>.comments</code> method on an article we&#8217;ll get back an array of its associated comment objects. So this render line will pass each element of that array one at a time into the partial named &quot;comment&quot;. Now we need to create the file <code>/app/views/articles/_comment.html.erb</code> and add this code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&lt;</span><span class="n">div</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;comment&quot;</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="n">h4</span><span class="o">&gt;</span><span class="no">Comment</span> <span class="n">by</span> <span class="o">&lt;</span><span class="sx">%=h comment.author_name %&gt;&lt;/h4&gt;</span>
</span><span class='line'><span class="sx">  &lt;p&gt;&lt;%=</span><span class="n">h</span> <span class="n">comment</span><span class="o">.</span><span class="n">body</span> <span class="sx">%&gt;&lt;/p&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="sr">/div&gt;</span>
</span></code></pre></td></tr></table></div></figure>

<p>With that in place, try clicking on your articles and find the one where you created the comments. Did they show up?  What happens when an article doesn&#8217;t have any comments?</p>

<h3>Web-Based Comment Creation</h3>

<p>Good start, but our users (hopefully) can&#8217;t get into the console to create their comments. We&#8217;ll need to create a web interface. We&#8217;ll go through some of the same steps that we did when creating the web interface for creating articles.</p>

<p>Let&#8217;s start with the form. The comment form should be embedded into the article&#8217;s <code>show</code> template. So let&#8217;s add this code right above the &quot;Back to Articles List&quot; in the articles <code>show.html.erb</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&lt;</span><span class="sx">%= render :partial =</span><span class="o">&gt;</span> <span class="s1">&#39;comment_form&#39;</span> <span class="o">%&gt;</span>
</span></code></pre></td></tr></table></div></figure>

<p>Obviously this is expecting a file <code>/app/views/articles/_comment_form.html.erb</code>, so create that and add this content for now:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&lt;</span><span class="n">h3</span><span class="o">&gt;</span><span class="no">Post</span> <span class="n">a</span> <span class="no">Comment</span><span class="o">&lt;</span><span class="sr">/h3&gt;</span>
</span><span class='line'><span class="sr">&lt;p&gt;(Comment form will go here)&lt;/</span><span class="nb">p</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure>

<p>Look at an article in your browser to make sure that partial is showing up. Then we can start figuring out the details of the form.</p>

<p>Ok, now look at your <code>articles_controller.rb</code> in the <code>new</code> method. Remember how we had to create a blank Article object so Rails could figure out which fields an article has?  We need to do the same thing before we create a form for the comment. But when we view the article and display the comment form we&#8217;re not running the article&#8217;s <code>new</code> method, we&#8217;re running the <code>show</code> method. So we&#8217;ll need to create a blank Comment object inside that <code>show</code> method like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="vi">@comment</span> <span class="o">=</span> <span class="vi">@article</span><span class="o">.</span><span class="n">comments</span><span class="o">.</span><span class="n">new</span>
</span></code></pre></td></tr></table></div></figure>

<p>This is just like we did it in the console. Now we can create a form inside our <code>_comment_form.html.erb</code> partial like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&lt;</span><span class="n">h3</span><span class="o">&gt;</span><span class="no">Post</span> <span class="n">a</span> <span class="no">Comment</span><span class="o">&lt;</span><span class="sr">/h3&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;%= form_for @comment do |f| %&gt;</span>
</span><span class='line'><span class="sr">  &lt;%= f.hidden_field :article_id, :value =&gt; @article.id %&gt;</span>
</span><span class='line'><span class="sr">  &lt;p&gt;</span>
</span><span class='line'><span class="sr">    &lt;%= f.label :author_name %&gt;&lt;br/</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="o">&lt;</span><span class="sx">%= f.text_field :author_name %&gt;</span>
</span><span class='line'><span class="sx">  &lt;/p&gt;</span>
</span><span class='line'><span class="sx">  &lt;p&gt;</span>
</span><span class='line'><span class="sx">    &lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:author_email</span> <span class="sx">%&gt;&lt;br/&gt;</span>
</span><span class='line'>    <span class="o">&lt;</span><span class="sx">%= f.text_field :author_email %&gt;</span>
</span><span class='line'><span class="sx">  &lt;/p&gt;</span>
</span><span class='line'><span class="sx">  &lt;p&gt;</span>
</span><span class='line'><span class="sx">    &lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:author_url</span> <span class="sx">%&gt;&lt;br/&gt;</span>
</span><span class='line'>    <span class="o">&lt;</span><span class="sx">%= f.text_field :author_url %&gt;</span>
</span><span class='line'><span class="sx">  &lt;/p&gt;</span>
</span><span class='line'><span class="sx">  &lt;p&gt;</span>
</span><span class='line'><span class="sx">    &lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:body</span> <span class="sx">%&gt;&lt;br/&gt;</span>
</span><span class='line'>    <span class="o">&lt;</span><span class="sx">%= f.text_area :body %&gt;</span>
</span><span class='line'><span class="sx">  &lt;/p&gt;</span>
</span><span class='line'><span class="sx">  &lt;p&gt;</span>
</span><span class='line'><span class="sx">    &lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s1">&#39;Submit&#39;</span> <span class="sx">%&gt;</span>
</span><span class='line'><span class="sx">  &lt;/p&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="sx">% end </span><span class="o">%&gt;</span>
</span></code></pre></td></tr></table></div></figure>

<p>The only new thing here is the hidden field helper. This hidden field will hold the ID of the article to help when creating the comment object.</p>

<p>Save then refresh in your web browser and&#8230;well&#8230;you&#8217;ll get an error like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>NoMethodError in Articles#show
</span><span class='line'>Showing app/views/articles/_comment_form.html.erb where line #3 raised:
</span><span class='line'>undefined method `comments_path' for #&lt;ActionView::Base:0x10446e510&gt;</span></code></pre></td></tr></table></div></figure>

<p>The <code>form_for</code> helper is trying to build the form so that it submits to <code>comments_path</code>, but we haven&#8217;t told the router anything about Comments yet. Open <code>/config/routes.rb</code> and add this line at the top:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">resources</span> <span class="ss">:comments</span>
</span></code></pre></td></tr></table></div></figure>

<p>Then refresh your browser and your form should show up. Try filling out the comments form and click SUBMIT &#8211; you&#8217;ll get an error about @uninitialized constant CommentsController@.</p>

<h3>Creating a Comments Controller</h3>

<p>Just like we needed an <code>articles_controller.rb</code> to manipulate our Articles, we&#8217;ll need a <code>comments_controller.rb</code>. Switch over to your terminal to generate it with this line:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>rails generate controller comments index create destroy</span></code></pre></td></tr></table></div></figure>

<p>What&#8217;s up with those extra parameters?  Anything after the name of the controller (in this case &quot;comments&quot;) will cause Rails to create stubs for methods with those names. Now open your <code>/app/controllers/comments_controller.rb</code> and you&#8217;ll see it has the three method stubs already.</p>

<p>The one we&#8217;re interested in first is <code>create</code>. You can cheat by looking at the <code>create</code> method in your <code>articles_controller.rb</code>. For your <code>comments_controller.rb</code>, everything should be the same just replace article with comment. Then the redirect is a little different, use this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">redirect_to</span> <span class="n">article_path</span><span class="p">(</span><span class="vi">@comment</span><span class="o">.</span><span class="n">article</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>

<p>Test out your form to create another comment now &#8211; and it should work!</p>

<h3>Cleaning Up</h3>

<p>We&#8217;ve got some decent comment functionality, but there are a few things we should add and tweak.</p>

<h4>Comments Count</h4>

<p>Let&#8217;s make it so where the view template has the &quot;Comments&quot; header it displays how many comments there are, like &quot;Comments (3)&quot;. Open up your article&#8217;s <code>show.html.erb</code> and change the comments header so it looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&lt;</span><span class="n">h3</span><span class="o">&gt;</span><span class="no">Comments</span> <span class="p">(</span><span class="o">&lt;%=</span> <span class="vi">@article</span><span class="o">.</span><span class="n">comments</span><span class="o">.</span><span class="n">count</span> <span class="sx">%&gt;)&lt;/h3&gt;</span>
</span></code></pre></td></tr></table></div></figure>

<h4>Form Labels</h4>

<p>The comments form looks a little silly with &quot;Author Name&quot; and &quot;Author URL&quot; and such. It should probably say &quot;Your Name&quot; and &quot;Your URL (optional)&quot;, right?  To change the text that the label helper prints out, you just pass in the desired text as a second parameter, like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:author_name</span><span class="p">,</span> <span class="s2">&quot;Your Name&quot;</span>  <span class="o">%&gt;</span>
</span></code></pre></td></tr></table></div></figure>

<p>Change your <code>_comment_form.html.erb</code> so it prints out &quot;Your Name&quot;, &quot;Your Email Address&quot;, &quot;Your URL (optional)&quot;, and &quot;Your Comment&quot;.</p>

<h4>Add Timestamp to the Comment Display</h4>

<p>We should add something about when the comment was posted. Rails has a really neat helper named <code>distance_of_time_in_words</code> which takes two dates and creates a text description of their difference like &quot;32 minutes later&quot;, &quot;3 months later&quot;, and so on. You can use it in your <code>_comment.html.erb</code> partial like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;</span><span class="no">Posted</span> <span class="o">&lt;%=</span> <span class="n">distance_of_time_in_words</span><span class="p">(</span><span class="n">comment</span><span class="o">.</span><span class="n">article</span><span class="o">.</span><span class="n">created_at</span><span class="p">,</span> <span class="n">comment</span><span class="o">.</span><span class="n">created_at</span><span class="p">)</span> <span class="sx">%&gt; later&lt;/p&gt;</span>
</span></code></pre></td></tr></table></div></figure>

<p>With that, you&#8217;re done with I2!</p>

<h2>I3: Tagging</h2>

<p>In this iteration we&#8217;ll add the ability to tag articles for organization and navigation.</p>

<p>First we need to think about what a tag is and how it&#8217;ll relate to the Article model. If you&#8217;re not familiar with tags, they&#8217;re commonly used in blogs to assign the article to one or more categories. For instance, if I write an article about a feature in Ruby on Rails, I might want it tagged with all of these categories: ruby, rails, programming, features. That way if one of my readers is looking for more articles about one of those topics they can click on the tag and see a list of my articles with that tag.</p>

<h3>Understanding the Relationship</h3>

<p>What is a tag?  We need to figure that out before we can create the model. First, a tag must have a relationship to an article so they can be connected. A single tag, like &quot;ruby&quot; for instance, should be able to relate to <em>many</em> articles. On the other side of the relationship, the article might have multiple tags (like &quot;ruby&quot;, &quot;rails&quot;, and &quot;programming&quot; as above) - so it&#8217;s also a <em>many</em> relationship. Articles and tags have a <em>many-to-many</em> relationship.</p>

<p>Many-to-many relationships are tricky because we&#8217;re using an SQL database. If an Article &quot;has many&quot; tags, then we would put the foreign key <code>article_id</code> inside the <code>tags</code> table - so then a Tag would &quot;belong to&quot; an Article. But a tag can connect to <em>many</em> articles, not just one. We can&#8217;t model this relationship with just the <code>articles</code> and <code>tags</code> tables.</p>

<p>When we start thinking about the database modeling, there are a few ways to achieve this setup. One way is to create a &quot;join table&quot; that just tracks which tags are connected to which articles. Traditionally this table would be named <code>articles_tags</code> and Rails would express the relationships by saying that the Article model <code>has_and_belongs_to_many</code> Tags, while the Tag model <code>has_and_belongs_to_many</code> Articles.</p>

<p>Most of the time this isn&#8217;t the best way to really model the relationship. The connection between the two models usually has value of its own, so we should promote it to a real model. For our purposes, we&#8217;ll introduce a model named &quot;Tagging&quot; which is the connection between Articles and Tags. The relationships will setup like this:</p>

<ul>
<li>An Article <code>has_many</code> Taggings</li>
<li>A Tag <code>has_many</code> Taggings</li>
<li>A Tagging <code>belongs_to</code> an Article and <code>belongs_to</code> a Tag</li>
</ul>

<h3>Making Models</h3>

<p>With those relationships in mind, let&#8217;s design the new models:</p>

<ul>
<li>Tag
*<code>name</code>: A string</li>
<li>Tagging
*<code>tag_id</code>: Integer holding the foreign key of the related Tag
*<code>article_id</code>: Integer holding the foreign key of the related Article</li>
</ul>

<p>Note that there are no changes necessary to Article because the foreign key is stored in the Tagging model. So now lets generate these models in your terminal:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>rails generate model Tag name:string
</span><span class='line'>rails generate model Tagging tag_id:integer article_id:integer
</span><span class='line'>rake db:migrate</span></code></pre></td></tr></table></div></figure>

<h3>Expressing Relationships</h3>

<p>Now that our model files are generated we need to tell Rails about the relationships between them. For each of the files below, add these lines:</p>

<p>In <code>/app/models/article.rb</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="n">has_many</span> <span class="ss">:taggings</span>
</span></code></pre></td></tr></table></div></figure>

<p>In <code>/app/models/tag.rb</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="n">has_many</span> <span class="ss">:taggings</span>
</span></code></pre></td></tr></table></div></figure>

<p>Then in <code>/app/models/tagging.rb</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="n">belongs_to</span> <span class="ss">:article</span>
</span><span class='line'>  <span class="n">belongs_to</span> <span class="ss">:tag</span>
</span></code></pre></td></tr></table></div></figure>

<p>After Rails had been around for awhile, developers were finding this kind of relationship very common. In practical usage, if I had an object named <code>article</code> and I wanted to find its Tags, I&#8217;d have to run code like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">tags</span> <span class="o">=</span> <span class="n">article</span><span class="o">.</span><span class="n">taggings</span><span class="o">.</span><span class="n">collect</span><span class="p">{</span><span class="o">|</span><span class="n">tagging</span><span class="o">|</span> <span class="n">tagging</span><span class="o">.</span><span class="n">tag</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>That&#8217;s a pain for something that we need commonly. The solution was to augment the relationship with &quot;through&quot;. We&#8217;ll add a second relationship now to the Article and Tag classes:</p>

<p>In <code>/app/models/article.rb</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="n">has_many</span> <span class="ss">:taggings</span>
</span><span class='line'>  <span class="n">has_many</span> <span class="ss">:tags</span><span class="p">,</span> <span class="ss">:through</span> <span class="o">=&gt;</span> <span class="ss">:taggings</span>
</span></code></pre></td></tr></table></div></figure>

<p>In <code>/app/models/tag.rb</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="n">has_many</span> <span class="ss">:taggings</span>
</span><span class='line'>  <span class="n">has_many</span> <span class="ss">:articles</span><span class="p">,</span> <span class="ss">:through</span> <span class="o">=&gt;</span> <span class="ss">:taggings</span>
</span></code></pre></td></tr></table></div></figure>

<p>Now if we have an object like <code>article</code> we can just ask for <code>article.tags</code> or, conversely, if we have an object named <code>tag</code> we can ask for <code>tag.articles</code>.</p>

<h3>An Interface for Tagging Articles</h3>

<p>The first interface we&#8217;re interested in is within the article itself. When I write an article, I want to have a text box where I can enter a list of zero or more tags separated by commas. When I save the article, my app should associate my article with the tags with those names, creating them if necessary.</p>

<p>Adding the text field will take place in the file <code>/app/views/articles/_form.html.erb</code>. Add in a set of paragraph tags underneath the body fields like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="o">&lt;</span><span class="sx">%= f.label :tag_list %&gt;&lt;br /&gt;</span>
</span><span class='line'><span class="sx">    &lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:tag_list</span> <span class="sx">%&gt;</span>
</span><span class='line'><span class="sx">  &lt;/p&gt;</span>
</span></code></pre></td></tr></table></div></figure>

<p>With that added, try to create an new article in your browser and your should see this error:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>NoMethodError in Articles#new
</span><span class='line'>Showing app/views/articles/_form.html.erb where line #14 raised:
</span><span class='line'>undefined method `tag_list' for #&lt;Article:0x10499bab0&gt;</span></code></pre></td></tr></table></div></figure>

<p>An Article doesn&#8217;t have a thing named <code>tag_list</code> &#8211; we made it up. In order for the form to display, we need to add a method to the <code>article.rb</code> file like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">def</span> <span class="nf">tag_list</span>
</span><span class='line'>    <span class="k">return</span> <span class="nb">self</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Your form should now show up and there&#8217;s a text box at the bottom named &quot;Tag list&quot;. Enter content for another sample article and in the tag list enter @ruby, <a href="mailto:technology@">technology@</a>. Click SAVE and you&#8217;ll get an error like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ActiveRecord::UnknownAttributeError in ArticlesController#create
</span><span class='line'>unknown attribute: tag_list</span></code></pre></td></tr></table></div></figure>

<p>What is this all about?  Let&#8217;s start by looking at the form data that was posted when we clicked SAVE. This data is in the production.log file which should be in the &quot;Console&quot; frame at the bottom of the RubyMine window. Look for the line that starts &quot;Processing ArticlesController#create&quot;, here&#8217;s what mine looks like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Processing ArticlesController#create (for 127.0.0.1) [POST]
</span><span class='line'>  Parameters: {"article"=&gt;{"body"=&gt;"Yes, the samples continue!", "title"=&gt;"My Sample", "tag_list"=&gt;"ruby, technology"}, "commit"=&gt;"Save", "authenticity_token"=&gt;"xxi0A3tZtoCUDeoTASi6Xx39wpnHt1QW/6Z1jxCMOm8="}</span></code></pre></td></tr></table></div></figure>

<p>The field that&#8217;s interesting there is the @&quot;tag_list&quot;=&gt;&quot;technology, ruby&quot;@. Those are the tags as I typed them into the form. The error came up in the <code>create</code> method, so let&#8217;s peek at <code>/app/controllers/articles_controller.rb</code> in the <code>create</code> method. See the first line that calls <code>Article.new(params[:article])</code>?  This is the line that&#8217;s causing the error as you could see in the middle of the stack trace.</p>

<p>Since the <code>create</code> method passes all the parameters from the form into the <code>Article.new</code> method, the tags are sent in as the string @&quot;technology, ruby&quot;@. The <code>new</code> method will try to set the new Article&#8217;s <code>tag_list</code> equal to @&quot;technology, ruby&quot;@ but that method doesn&#8217;t exist because there is no attribute named <code>tag_list</code>. </p>

<p>There are several ways to solve this problem, but the simplest is to pretend like we have an attribute named <code>tag_list</code>. We can define the <code>tag_list=</code> method inside <code>article.rb</code> like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">def</span> <span class="nf">tag_list</span><span class="o">=</span><span class="p">(</span><span class="n">tags_string</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Just leave it blank for now and try to resubmit your sample article with tags. It goes through!</p>

<h3>Not So Fast</h3>

<p>Did it really work?  It&#8217;s hard to tell. Let&#8217;s jump into the console and have a look.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>a = Article.last
</span><span class='line'>a.tags</span></code></pre></td></tr></table></div></figure>

<p>I bet the console reported that <code>a</code> had <code>[]</code> tags &#8211; an empty list. So we didn&#8217;t generate an error, but we didn&#8217;t create any tags either.</p>

<p>We need to return to that <code>tag_list=</code> method in <code>article.rb</code> and do some more work. We&#8217;re taking in a parameter, a string like @&quot;tag1, tag2, tag3&quot;@ and we need to associate the article with tags that have those names. The pseudo-code would look like this:</p>

<ul>
<li>Cut the parameter into a list of strings with leading and trailing whitespace removed (so @&quot;tag1, tag2, tag3&quot;@ would become <code>[&quot;tag1&quot;,&quot;tag2&quot;,&quot;tag3&quot;]</code></li>
<li>For each of those strings&#8230;
*Look for a Tag object with that name. If there isn&#8217;t one, create it.
*Create a Tagging object that connects this Article with that Tag</li>
</ul>

<p>The first step is something that Ruby does very easily using the <code>.split</code> method. Go into your console and try @&quot;tag1, tag2, tag3&quot;<a href="mailto:.split@">.split@</a>. By default it split on the space character, but that&#8217;s not what we want. You can force split to work on any character by passing it in as a parameter, like this: @&quot;tag1, tag2, tag3&quot;.split(&quot;,&quot;)@. </p>

<p>Look closely at the output and you&#8217;ll see that the second element is @&quot; tag2&quot;@ instead of <code>&quot;tag2&quot;</code> &#8211; it has a leading space. We don&#8217;t want our tag system to end up with different tags because of some extra (non-meaningful) spaces, so we need to get rid of that. Ruby&#8217;s String class has a <code>strip</code> method that pulls off leading or trailing whitespace &#8211; try it with @&quot; my sample &quot;<a href="mailto:.strip@">.strip@</a>. You&#8217;ll see that the space in the center is preserved.</p>

<p>So to combine that with our <code>strip</code>, try this code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="s2">&quot;tag1, tag2, tag3&quot;</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">{</span><span class="o">|</span><span class="n">s</span><span class="o">|</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="o">.</span><span class="n">downcase</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>The <code>.split(&quot;,&quot;)</code> will create the list with extra spaces as before, then the <code>.collect</code> will take each element of that list and send it into the following block where the string is named <code>s</code> and the <code>strip</code> and <code>downcase</code> methods are called on it. The <code>downcase</code> method is to make sure that &quot;ruby&quot; and &quot;Ruby&quot; don&#8217;t end up as different tags. This line should give you back @[&quot;tag1&quot;, &quot;tag2&quot;, &quot;tag3&quot;]@.</p>

<p>Now, back inside our <code>tag_list=</code> method, let&#8217;s add this line:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">tag_names</span> <span class="o">=</span> <span class="n">tags_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">{</span><span class="o">|</span><span class="n">s</span><span class="o">|</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>So looking at our pseudo-code, the next step is to go through <code>each</code> of those <code>tag_names</code> and find or create a tag with that name. Rails has a built in method to do just that, like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">tag</span> <span class="o">=</span> <span class="no">Tag</span><span class="o">.</span><span class="n">find_or_create_by_name</span><span class="p">(</span><span class="n">tag_name</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>

<p>Once we find or create the <code>tag</code>, we need to create a <code>tagging</code> which connects this article (here <code>self</code>) to the tag like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">self</span><span class="o">.</span><span class="n">taggings</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="ss">:tag</span> <span class="o">=&gt;</span> <span class="n">tag</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>

<p>The <code>build</code> method is a special creation method. It doesn&#8217;t need an explicit save, Rails will wait to save the Tagging until the Article itself it saved. So, putting these pieces together, your <code>tag_list=</code> method should look like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">def</span> <span class="nf">tag_list</span><span class="o">=</span><span class="p">(</span><span class="n">tags_string</span><span class="p">)</span>
</span><span class='line'>    <span class="n">tag_names</span> <span class="o">=</span> <span class="n">tags_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">{</span><span class="o">|</span><span class="n">s</span><span class="o">|</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="o">.</span><span class="n">downcase</span><span class="p">}</span>
</span><span class='line'>    <span class="n">tag_names</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">tag_name</span><span class="o">|</span>
</span><span class='line'>      <span class="n">tag</span> <span class="o">=</span> <span class="no">Tag</span><span class="o">.</span><span class="n">find_or_create_by_name</span><span class="p">(</span><span class="n">tag_name</span><span class="p">)</span>
</span><span class='line'>      <span class="nb">self</span><span class="o">.</span><span class="n">taggings</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="ss">:tag</span> <span class="o">=&gt;</span> <span class="n">tag</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<h3>Testing in the Console</h3>

<p>Go back to your console and try these commands:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">reload!</span>
</span><span class='line'><span class="n">a</span> <span class="o">=</span> <span class="no">Article</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:title</span> <span class="o">=&gt;</span> <span class="s2">&quot;A Sample Article for Tagging!&quot;</span><span class="p">,</span><span class="ss">:body</span> <span class="o">=&gt;</span> <span class="s2">&quot;Great article goes here&quot;</span><span class="p">,</span> <span class="ss">:tag_list</span> <span class="o">=&gt;</span> <span class="s2">&quot;ruby, technology&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">a</span><span class="o">.</span><span class="n">save</span>
</span><span class='line'><span class="n">a</span><span class="o">.</span><span class="n">tags</span>
</span></code></pre></td></tr></table></div></figure>

<p>You should get back a list of the two tags. If you&#8217;d like to check the other side of the Article-Tagging-Tag relationship, try this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>t = a.tags.first
</span><span class='line'>t.articles</span></code></pre></td></tr></table></div></figure>

<p>And you&#8217;ll see that this Tag is associated with just one Article.</p>

<h3>Adding Tags to our Display</h3>

<p>According to our work in the console, articles can now have tags, but we haven&#8217;t done anything to display them in the article pages. Let&#8217;s start with <code>/app/views/articles/show.html.erb</code>. Right below the line that displays the <code>article.title</code>, add this line:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Tags</span><span class="p">:</span> <span class="o">&lt;%=</span> <span class="n">tag_links</span><span class="p">(</span><span class="vi">@article</span><span class="o">.</span><span class="n">tags</span><span class="p">)</span> <span class="sx">%&gt;&lt;br /&gt;</span>
</span></code></pre></td></tr></table></div></figure>

<p>This line calls a helper named <code>tag_links</code> and sends the <code>article.tags</code> array as a parameter. We need to then create the <code>tag_links</code> helper. Open up <code>/app/helpers/articles_helper.rb</code> and add this method inside the <code>module@/@end</code> keywords:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">tag_links</span><span class="p">(</span><span class="n">tags</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>The desired outcome is a list of comma separated tags, where each one links to that tag&#8217;s <code>show</code> action &#8211; the page where we&#8217;ll list all the articles with that tag.</p>

<p>A helper method has to return a string which will get rendered into the HTML. In this case we&#8217;ll use the <code>collect</code> method to create a list of links, one for each Tag, where the link is created by the <code>link_to</code> helper. Then we&#8217;ll <code>return</code> back the <code>links</code> connected by a comma and a space:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">def</span> <span class="nf">tag_links</span><span class="p">(</span><span class="n">tags</span><span class="p">)</span>
</span><span class='line'>    <span class="n">links</span> <span class="o">=</span> <span class="n">tags</span><span class="o">.</span><span class="n">collect</span><span class="p">{</span><span class="o">|</span><span class="n">tag</span><span class="o">|</span> <span class="n">link_to</span> <span class="n">tag</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">tag_path</span><span class="p">(</span><span class="n">tag</span><span class="p">)}</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">links</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Refresh your view and&#8230;BOOM:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>NoMethodError in Articles#show
</span><span class='line'>Showing app/views/articles/index.html.erb where line #6 raised:
</span><span class='line'>undefined method `tag_path' for #&lt;ActionView::Base:0x104aaa460&gt;</span></code></pre></td></tr></table></div></figure>

<p>The <code>link_to</code> helper is trying to use <code>tag_path</code> from the router, but the router doesn&#8217;t know anything about our Tag object. We created a model, but we never created a controller or route. There&#8217;s nothing to link to &#8211; so let&#8217;s generate that controller from your terminal:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>rails generate controller tags index show</span></code></pre></td></tr></table></div></figure>

<p>Then we need to add it to our <code>/config/routes.rb</code> like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">resources</span> <span class="ss">:tags</span>
</span></code></pre></td></tr></table></div></figure>

<p>Now refresh your view and you should see your linked tags showing up on the individual article pages.</p>

<p>Lastly, use similar code in <code>/app/views/articles/index.html.erb</code> to display the tags on the article listing page.</p>

<h3>Avoiding Repeated Tags</h3>

<p>Try editing one of your article that already has some tags. Save it and look at your article list. You&#8217;ll probably see that tags are getting repeated, which is obviously not what we want. </p>

<p>When we wrote our <code>tag_list=</code> method inside of <code>article.rb</code>, we were just thinking about it running when creating a new article. Thus we always built a new tagging for each tag in the list. But when we&#8217;re editing, we might get the string &quot;ruby, technology&quot; into the method while the Article was already linked to the tags &quot;ruby&quot; and &quot;technology&quot; when it was created. As it is currently written, the method will just &quot;retag&quot; it with those tags, so we&#8217;ll end up with a list like &quot;ruby, technology, ruby, technology&quot;.</p>

<p>There are a few ways we could fix this &#8211; the first thing I want to do is remove any repeated tags in the parameter list by using the Ruby method <code>uniq</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">tag_names</span> <span class="o">=</span> <span class="n">tags_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">{</span><span class="o">|</span><span class="n">s</span><span class="o">|</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="o">.</span><span class="n">downcase</span><span class="p">}</span><span class="o">.</span><span class="n">uniq</span>
</span></code></pre></td></tr></table></div></figure>

<p>This is a good start but it doesn&#8217;t solve everything. We&#8217;d still get repeated tags each time we edit an article.</p>

<p>If we edit an article and <em>remove</em> a tag from the list, this method as it stands now isn&#8217;t going to do anything about it. Since we don&#8217;t have anything valuable in the Tagging object besides the connection to the article and tag, they&#8217;re disposible. We can just destroy all the taggings at the beginning of the method. Any tags that aren&#8217;t in the <code>tags_string</code> won&#8217;t get re-linked. This will both avoid removed tags and prevent the &quot;double tagging&quot; behavior. Putting that all together, here&#8217;s my final <code>tag_list=</code> method:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">def</span> <span class="nf">tag_list</span><span class="o">=</span><span class="p">(</span><span class="n">tags_string</span><span class="p">)</span>
</span><span class='line'>    <span class="nb">self</span><span class="o">.</span><span class="n">taggings</span><span class="o">.</span><span class="n">destroy_all</span>
</span><span class='line'>    <span class="n">tag_names</span> <span class="o">=</span> <span class="n">tags_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">{</span><span class="o">|</span><span class="n">s</span><span class="o">|</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="o">.</span><span class="n">downcase</span><span class="p">}</span><span class="o">.</span><span class="n">uniq</span>
</span><span class='line'>    <span class="n">tag_names</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">tag_name</span><span class="o">|</span>
</span><span class='line'>      <span class="n">tag</span> <span class="o">=</span> <span class="no">Tag</span><span class="o">.</span><span class="n">find_or_create_by_name</span><span class="p">(</span><span class="n">tag_name</span><span class="p">)</span>
</span><span class='line'>      <span class="nb">self</span><span class="o">.</span><span class="n">taggings</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="ss">:tag</span> <span class="o">=&gt;</span> <span class="n">tag</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>It prevents duplicates and allows you to remove tags from the edit form. Test it out and make sure things are working!</p>

<h3>Listing Articles by Tag</h3>

<p>The links for our tags are showing up, but if you click on them you&#8217;ll get our old friend, the &quot;No action responded to show. Actions:&quot; error. Open up your <code>/app/controllers/tags_controller.rb</code> and add a a <code>show</code> method like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">def</span> <span class="nf">show</span>
</span><span class='line'>    <span class="vi">@tag</span> <span class="o">=</span> <span class="no">Tag</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Then create a file <code>/app/views/tags/show.html.erb</code> like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="no">Articles</span> <span class="no">Tagged</span> <span class="n">with</span> <span class="o">&lt;</span><span class="sx">%= @tag.name %&gt;&lt;/h1&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sx">&lt;ul&gt;</span>
</span><span class='line'><span class="sx">  &lt;% @tag.articles.each do |article| %&gt;</span>
</span><span class='line'><span class="sx">    &lt;li&gt;&lt;%=</span> <span class="n">link_to</span> <span class="n">article</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="n">article_path</span><span class="p">(</span><span class="n">article</span><span class="p">)</span> <span class="sx">%&gt;&lt;/li&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="sx">% end %&gt;</span>
</span><span class='line'><span class="sx">&lt;/ul&gt;</span>
</span></code></pre></td></tr></table></div></figure>

<p>Refresh your view and you should see a list of articles with that tag. Keep in mind that there might be some abnormalities from articles we tagged before doing our fixes to the <code>tag_list=</code> method. For any article with issues, try going to its <code>edit</code> screen, saving it, and things should be fixed up. If you wanted to clear out all taggings you could do <code>Tagging.destroy_all</code> from your console.</p>

<h3>Listing All Tags</h3>

<p>We&#8217;ve built the <code>show</code> action, but the reader should also be able to browse the tags available at <code>http://localhost:3000/tags/</code>. I think you can do this on your own. Create an <code>index</code> action in your <code>tags_controller.rb</code> and an <code>index.html.erb</code> in the corresponding views folder. Look at your <code>articles_controller.rb</code> and Article <code>index.html.erb</code> if you need some clues.</p>

<p>If that&#8217;s easy, try creating a <code>destroy</code> method in your <code>tags_controller.rb</code> and adding a destroy link to the tag list. If you do this, change the association in your <code>tag.rb</code> so that it says @has_many :taggings, :dependent =&gt; :<a href="mailto:destroy@">destroy@</a>. That&#8217;ll prevent orphaned Tagging objects from hanging around.</p>

<p>With that, a long Iteration 3 is complete!</p>

<h2>I4: Installing Plugins</h2>

<p>In this iteration we&#8217;ll learn how to take advantage of the many plugins and libraries available to quickly add features to your application. First we&#8217;ll work with <em>paperclip</em>, a library that manages file attachments and uploading.</p>

<h3>Using the <em>Gemfile</em> to Setup a RubyGem</h3>

<p>In the past Rails plugins were distributed a zip or tar files that got stored into your application&#8217;s file structure. One advantage of this method is that the plugin could be easily checked into your source control system along with everything you wrote in the app. The disadvantage is that it made upgrading to newer versions of the plugin, and dealing with the versions at all, complicated.</p>

<p>Most Rails plugins are now moving toward RubyGems. RubyGems is a package management system for Ruby, similar to how Linux distributions use Apt or RPM. There are central servers that host libraries, and we can install those libraries on our machine with a single command. RubyGems takes care of any dependencies, allows us to pick an options if necessary, and installs the library.</p>

<p>Let&#8217;s see it in action. If you have your server running in RubyMine, click the red square button to STOP it. If you have a console session open, type <code>exit</code> to exit. Then open up <code>/Gemfile</code> and look for the lines like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="c1"># gem &#39;bj&#39;</span>
</span><span class='line'>  <span class="c1"># gem &#39;nokogiri&#39;</span>
</span><span class='line'>  <span class="c1"># gem &#39;sqlite3-ruby&#39;, :require =&gt; &#39;sqlite3&#39;</span>
</span></code></pre></td></tr></table></div></figure>

<p>These lines are commented out because they start with the <code>#</code> character. By specifying a RubyGem with the <code>gem</code> command, we&#8217;ll tell the Rails application &quot;Make sure this gem is loaded when you start up. If it isn&#8217;t available, freak out!&quot;  Here&#8217;s how we&#8217;ll require the paperclip gem, add this near those commented lines:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="n">gem</span> <span class="s2">&quot;paperclip&quot;</span>
</span></code></pre></td></tr></table></div></figure>

<p>When you&#8217;re writing a production application, you might specify additional parameters that require a specific version or a custom source for the library. With that config line declared, click the green arrow in RubyMine to startup your server. You should get an error like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  Could not find gem 'paperclip (&gt;= 0, runtime)' in any of the gem sources listed in your Gemfile.
</span><span class='line'>  Try running `bundle install`.</span></code></pre></td></tr></table></div></figure>

<p>The last line is key &#8211; since our config file is specifying which gems it needs, the <code>bundle</code> command can help us install those gems. Go to your terminal and:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>bundle</span></code></pre></td></tr></table></div></figure>

<p>It should then install the paperclip RubyGem with a version like 2.3.8. In some projects I work on, the config file specifies upwards of 18 gems. With that one <code>bundle</code> command the app will check that all required gems are installed with the right version, and if not, install them. </p>

<p>Now we can start using the library in our application!</p>

<h3>Setting up the Database for Paperclip</h3>

<p>We want to add images to our articles. To keep it simple, we&#8217;ll say that a single article could have zero or one images. In later versions of the app maybe we&#8217;d add the ability to upload multiple images and appear at different places in the article, but for now the one will show us how to work with paperclip.</p>

<p>First we need to add some fields to the Article model that will hold the information about the uploaded image. Any time we want to make a change to the database we&#8217;ll need a migration. Go to your terminal and execute this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>rails generate migration add_paperclip_fields_to_article</span></code></pre></td></tr></table></div></figure>

<p>That will create a file in your <code>/db/migrate/</code> folder that ends in <code>_add_paperclip_fields_to_article.rb</code>. Open that file now.</p>

<p>Remember that the code inside the <code>change</code> method is to migrate the database forward, while the <code>self.down</code> should undo those changes. We&#8217;ll use the <code>add_column</code> and <code>remove_column</code> methods to setup the fields paperclip is expecting:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">AddPaperclipFieldsToArticle</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">change</span>
</span><span class='line'>      <span class="n">add_column</span> <span class="ss">:articles</span><span class="p">,</span> <span class="ss">:image_file_name</span><span class="p">,</span>    <span class="ss">:string</span>
</span><span class='line'>      <span class="n">add_column</span> <span class="ss">:articles</span><span class="p">,</span> <span class="ss">:image_content_type</span><span class="p">,</span> <span class="ss">:string</span>
</span><span class='line'>      <span class="n">add_column</span> <span class="ss">:articles</span><span class="p">,</span> <span class="ss">:image_file_size</span><span class="p">,</span>    <span class="ss">:integer</span>
</span><span class='line'>      <span class="n">add_column</span> <span class="ss">:articles</span><span class="p">,</span> <span class="ss">:image_updated_at</span><span class="p">,</span>   <span class="ss">:datetime</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">down</span>
</span><span class='line'>      <span class="n">remove_column</span> <span class="ss">:articles</span><span class="p">,</span> <span class="ss">:image_file_name</span>
</span><span class='line'>      <span class="n">remove_column</span> <span class="ss">:articles</span><span class="p">,</span> <span class="ss">:image_content_type</span>
</span><span class='line'>      <span class="n">remove_column</span> <span class="ss">:articles</span><span class="p">,</span> <span class="ss">:image_file_size</span>
</span><span class='line'>      <span class="n">remove_column</span> <span class="ss">:articles</span><span class="p">,</span> <span class="ss">:image_updated_at</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>The go to your terminal and run @rake db:<a href="mailto:migrate@">migrate@</a>. The rake command should show you that the migration ran and added columns to the database.</p>

<h3>Adding to the Model</h3>

<p>The gem is loaded, the database is ready, but we need to tell our Rails application about the image attachment we want to add. Open <code>/app/models/article.rb</code> and just below the existing <code>has_many</code> lines, add this line:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">has_attached_file</span> <span class="ss">:image</span>
</span></code></pre></td></tr></table></div></figure>

<p>This <code>has_attached_file</code> method is part of the paperclip library. With that declaration, paperclip will understand that this model should accept a file attachment and that there are fields to store information about that file which start with <code>image_</code> in this model&#8217;s database table.</p>

<h3>Modifying the Form Template</h3>

<p>First we&#8217;ll add the ability to upload the file when editing the article, then we&#8217;ll add the image display to the article show template. Open your <code>/app/views/articles/_form.html.erb</code> view template. We need to make two changes&#8230;</p>

<p>In the very first line, we need to specify that this form needs to accept &quot;multipart&quot; data. This is an instruction to the browser about how to submit the form. Change your top line so it looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&lt;</span><span class="sx">% form_for(@article, </span><span class="ss">:html</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="ss">:multipart</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">})</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="o">%&gt;</span>
</span></code></pre></td></tr></table></div></figure>

<p>Then further down the form, right before the paragraph with the save button, let&#8217;s add a label and field for the file uploading:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="o">&lt;</span><span class="sx">%= f.label :image, &quot;Attach an Image&quot; %&gt;&lt;br /&gt;</span>
</span><span class='line'><span class="sx">    &lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">file_field</span> <span class="ss">:image</span> <span class="sx">%&gt;</span>
</span><span class='line'><span class="sx">  &lt;/p&gt;</span>
</span></code></pre></td></tr></table></div></figure>

<h3>Trying it Out</h3>

<p>If your server isn&#8217;t running, start it up with the green play button in RubyMine. Then go to <code>http://localhost:3000/articles/</code> and click EDIT for your first article. The file field should show up towards the bottom. Click the @Choose a File@ and select one of the small images that I&#8217;ve distributed to you. Click SAVE and you&#8217;ll return to the article index. Click the title of the article you just modified. What do you see?  Did the image attach to the article?</p>

<p>When I first did this, I wasn&#8217;t sure it worked. Here&#8217;s how I checked:</p>

<h1>Open a console session (@rails console@ from terminal)</h1>

<h1>Find the ID number of the article by looking at the URL. In my case, the url was <code>http://localhost:3000/articles/1</code> so the ID number is just <code>1</code></h1>

<h1>In console, enter @a = Article.find(1)@</h1>

<h1>Right away I see that the article has data in the <code>image_file_name</code> and other fields, so I think it worked.</h1>

<h1>Enter <code>a.image</code> to see even more data about the file</h1>

<p>Ok, it&#8217;s in there, but we need it to actually show up in the article. Open the <code>/app/views/articles/show.html.erb</code> view template. In between the line that displays the title and the one that displays the body, let&#8217;s add this line:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&lt;%=</span> <span class="n">image_tag</span> <span class="vi">@article</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">url</span> <span class="o">%&gt;</span>
</span></code></pre></td></tr></table></div></figure>

<p>Then refresh the article in your browser. Tada!</p>

<h3>Improving the Form</h3>

<p>When first working with the edit form I wasn&#8217;t sure the upload was working because I expected the <code>file_field</code> to display the name of the file that I had already uploaded. Go back to the edit screen in your browser for the article you&#8217;ve been working with. See how it just says &quot;Choose File, no file selected&quot; &#8211; nothing tells the user that a file already exists for this article. Let&#8217;s add that information in now.</p>

<p>So open that <code>/app/views/articles/_form.html.erb</code> and look at the paragraph where we added the image upload field. We&#8217;ll add in some new logic that works like this:</p>

<ul>
<li>If the article has an image filename
*Display the image</li>
<li>Then display the <code>file_field</code> button with the label &quot;Attach a New Image&quot;</li>
</ul>

<p>So, turning that into code&#8230;</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="o">&lt;</span><span class="sx">% if </span><span class="vi">@article</span><span class="o">.</span><span class="n">image_file_name</span> <span class="sx">%&gt;</span>
</span><span class='line'><span class="sx">        &lt;%= image_tag @article.image.url %&gt;</span><span class="o">&lt;</span><span class="n">br</span><span class="o">/&gt;</span>
</span><span class='line'>    <span class="o">&lt;</span><span class="sx">% end %&gt;</span>
</span><span class='line'><span class="sx">    &lt;%= f.label :image, &quot;Attach a New Image&quot; %&gt;</span><span class="o">&lt;</span><span class="n">br</span><span class="sr"> /&gt;</span>
</span><span class='line'><span class="sr">    &lt;%= f.file_field :image %&gt;</span>
</span><span class='line'><span class="sr">  &lt;/</span><span class="nb">p</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure>

<p>Test how that looks both for articles that already have an image and ones that don&#8217;t.</p>

<p>When you &quot;show&quot; an article that doesn&#8217;t have an image attached it&#8217;ll have an ugly broken link. Go into your <code>/app/views/articles/show.html.erb</code> and add a condition like we did in the form so the image is only displayed if it actually exists.</p>

<p>Now our articles can have an image and all the hard work was handled by paperclip!</p>

<h3>Further Notes about Paperclip</h3>

<p>Yes, a model (in our case an article) could have many attachments instead of just one. To accomplish this you&#8217;d create a new model, let&#8217;s call it &quot;Attachment&quot;, where each instance of the model can have one file using the same fields we put into Article above as well as an <code>article_id</code> field. The Attachment would then <code>belong_to</code> an article, and an article would <code>have_many</code> attachments.</p>

<p>Paperclip supports automatic image resizing and it&#8217;s easy. In your model, you&#8217;d add an option like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">as_attached_file</span> <span class="ss">:image</span><span class="p">,</span> <span class="ss">:styles</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:medium</span> <span class="o">=&gt;</span> <span class="s2">&quot;300x300&gt;&quot;</span><span class="p">,</span> <span class="ss">:thumb</span> <span class="o">=&gt;</span> <span class="s2">&quot;100x100&gt;&quot;</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>This would automatically create a &quot;medium&quot; size where the largest dimension is 300 pixels and a &quot;thumb&quot; size where the largest dimension is 100 pixels. Then in your view, to display a specific version, you just pass in an extra parameter like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&lt;%=</span> <span class="n">image_tag</span> <span class="vi">@article</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">url</span><span class="p">(</span><span class="ss">:medium</span><span class="p">)</span> <span class="o">%&gt;</span>
</span></code></pre></td></tr></table></div></figure>

<p>If it&#8217;s so easy, why don&#8217;t we do it right now?  The catch is that paperclip doesn&#8217;t do the image manipulation itself, it relies on a package called <em>imagemagick</em>. Image processing libraries like this are notoriously difficult to install. If you&#8217;re on Linux, it might be as simple as @sudo apt-get install <a href="mailto:imagemagick@">imagemagick@</a>. On OS X, if you have Mac Ports installed, it&#8217;d just be @sudo port install <a href="mailto:imagemagick@">imagemagick@</a>. On windows you need to download an copy some EXEs and DLLs. It can be a hassle, which is why we won&#8217;t do it during this class. </p>

<h3>Installing HAML/SASS</h3>

<p>Another plugin that I use in every project is actually two libraries in one. HAML is an alternative templating style to the default ERB (which you&#8217;ve been using, hence all the view templates ending in <code>.erb</code>). SASS is a library for writing CSS and it makes CSS much, much easier to work with.</p>

<p>Open your <code>Gemfile</code> and add a <code>gem</code> line for the gem <code>haml</code>. Go to your terminal and <code>bundle</code> and it should pull down the gem library for you. Stop (with the red square) then restart (green play button) your server within RubyMine. Both HAML and SASS are installed and ready to use.</p>

<p>Look in RubyMine&#8217;s left navigation pane for the folder <code>/public/stylesheets/</code>. Right click on this folder, click NEW, then DIRECTORY, and name it <code>sass</code>. Then right click on the <code>sass</code> folder, click NEW, FILE, then enter the name <code>styles.sass</code></p>

<h3>A Few Sass Examples</h3>

<p>All the details about Sass can be found here: &quot;<a href="http://sass-lang.com/":http://sass-lang.com/">http://sass-lang.com/&quot;:http://sass-lang.com/</a></p>

<p>We&#8217;re not focusing on CSS development, so here are a few styles that you can copy &amp; paste and modify to your heart&#8217;s content:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">!</span><span class="n">primary_color</span> <span class="o">=</span> <span class="c1">#AAA</span>
</span><span class='line'>
</span><span class='line'><span class="n">body</span>
</span><span class='line'>  <span class="ss">:background</span><span class="o">-</span><span class="n">color</span> <span class="o">=</span> <span class="o">!</span><span class="n">primary_color</span>
</span><span class='line'>  <span class="ss">:font</span>
</span><span class='line'>    <span class="ss">:family</span> <span class="no">Verdana</span><span class="p">,</span> <span class="no">Helvetica</span><span class="p">,</span> <span class="no">Arial</span>
</span><span class='line'>    <span class="ss">:size</span> <span class="mi">14</span><span class="n">px</span>
</span><span class='line'>
</span><span class='line'><span class="n">a</span>
</span><span class='line'>  <span class="ss">:color</span> <span class="c1">#0000FF</span>
</span><span class='line'>  <span class="n">img</span>
</span><span class='line'>    <span class="ss">:border</span> <span class="n">none</span>
</span><span class='line'>
</span><span class='line'><span class="o">.</span><span class="n">clear</span>
</span><span class='line'>  <span class="ss">:clear</span> <span class="n">both</span>
</span><span class='line'>  <span class="ss">:height</span> <span class="mi">0</span>
</span><span class='line'>  <span class="ss">:overflow</span> <span class="n">hidden</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#container</span>
</span><span class='line'>  <span class="ss">:width</span> <span class="mi">75</span><span class="o">%</span>
</span><span class='line'>  <span class="ss">:margin</span> <span class="mi">0</span> <span class="n">auto</span>
</span><span class='line'>  <span class="ss">:background</span> <span class="c1">#fff</span>
</span><span class='line'>  <span class="ss">:padding</span> <span class="mi">20</span><span class="n">px</span> <span class="mi">40</span><span class="n">px</span>
</span><span class='line'>  <span class="ss">:border</span> <span class="n">solid</span> <span class="mi">1</span><span class="n">px</span> <span class="n">black</span>
</span><span class='line'>  <span class="ss">:margin</span><span class="o">-</span><span class="n">top</span> <span class="mi">20</span><span class="n">px</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#content</span>
</span><span class='line'>  <span class="ss">:clear</span> <span class="n">both</span>
</span><span class='line'>  <span class="ss">:padding</span><span class="o">-</span><span class="n">top</span> <span class="mi">20</span><span class="n">px</span>
</span></code></pre></td></tr></table></div></figure>

<p>But our application isn&#8217;t setup to load that stylesheet yet. We need to make a change to our view templates.</p>

<h3>Working with Layouts</h3>

<p>We&#8217;ve created about a dozen view templates between our different models. We <em>could</em> go into each of those templates and add a line like this at the top:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&lt;%=</span> <span class="n">stylesheet_link_tag</span> <span class="s1">&#39;styles&#39;</span> <span class="o">%&gt;</span>
</span></code></pre></td></tr></table></div></figure>

<p>Which would find the Sass file we just wrote. That&#8217;s a lame job, imagine if we had 100 view templates. What if we want to change the name of the stylesheet later?  Ugh.</p>

<p>Rails and Ruby both emphasize the idea of &quot;D.R.Y.&quot; &#8211; Don&#8217;t Repeat Yourself. In the area of view templates, we can achieve this by creating a <em>layout</em>. A layout is a special view template that wraps other views. Look in your navigation pane for <code>/app/views/layouts/</code>, right click on that folder, click NEW and FILE then give it the name <code>application.html.haml</code>.</p>

<p>In this layout we&#8217;ll put the view code that we want to render for every view template in the application. Just so you can see what HAML looks like, I&#8217;ve used it to implement this layout. You&#8217;ll notice that HAML uses fewer marking characters than ERB, but you must maintain the proper whitespace/indentation. All indentations are two spaces from the containing element. Add this code to your <code>application.html.haml</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">!!!</span> <span class="no">Strict</span>
</span><span class='line'><span class="o">%</span><span class="n">html</span>
</span><span class='line'>  <span class="o">%</span><span class="n">head</span>
</span><span class='line'>    <span class="o">%</span><span class="n">title</span>
</span><span class='line'>      <span class="no">JSBlogger</span>
</span><span class='line'>    <span class="o">=</span> <span class="n">stylesheet_link_tag</span> <span class="s1">&#39;styles&#39;</span>
</span><span class='line'>
</span><span class='line'>  <span class="o">%</span><span class="n">body</span>
</span><span class='line'>    <span class="c1">#container</span>
</span><span class='line'>      <span class="c1">#content</span>
</span><span class='line'>        <span class="o">=</span> <span class="k">yield</span>
</span></code></pre></td></tr></table></div></figure>

<p>Now refresh your article listing page and you should see the styles take effect. Whatever code is in the individual view template gets inserted into the layout where you see the <code>yield</code>. Using layouts makes it easy to add site-wide elements like navigation, sidebars, and so forth.</p>

<p><em>NOTE</em>: If you don&#8217;t see any change, look at your server log in RubyMine to see if there were any errors. At first I had a typo in one of the filenames so it wasn&#8217;t being picked up properly. You might also need to stop &amp; restart your server if you didn&#8217;t do that after installing the <code>haml</code> gem.</p>

<p>Now that you&#8217;ve tried out three plugin libraries (Paperclip, HAML, and SASS), Iteration 4 is complete!</p>

<h2>I5: Authentication</h2>

<p>Authentication is an important part of almost any web application and there are several approaches to take. Thankfully some of these have been put together in plugins so we don&#8217;t have to reinvent the wheel. </p>

<p>The &quot;flavor-of-the-week&quot; is one named AuthLogic and I wrote up an iteration using it for the &quot;JSMerchant&quot;:<a href="http://jumpstartlab.com/resources/rails-jumpstart/jsmerchant/">http://jumpstartlab.com/resources/rails-jumpstart/jsmerchant/</a> tutorial, but I think it is a little complicated for a Rails novice. You have to create several different models, controllers, and views manually. The documentation is kind of confusing, and I don&#8217;t think my tutorial is that much better.</p>

<p>So, instead, we&#8217;ll use the most common authentication plugin, &quot;restful_authentication&quot;:<a href="http://github.com/technoweenie/restful-authentication">http://github.com/technoweenie/restful-authentication</a>.</p>

<h3>Installing restful_authentication</h3>

<p>In the previous iteration we installed libraries using RubyGems. This is the preferred way of managing plugins, but restful_authentication isn&#8217;t available through RubyGems. We&#8217;ll have to use the older method of installing a plugin.</p>

<p>At your terminal, enter the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">ruby</span> <span class="n">git</span> <span class="nb">clone</span> <span class="n">git</span><span class="ss">:/</span><span class="o">/</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">technoweenie</span><span class="o">/</span><span class="n">restful</span><span class="o">-</span><span class="n">authentication</span><span class="o">.</span><span class="n">git</span> <span class="n">restful_authentication</span>
</span></code></pre></td></tr></table></div></figure>

<p>If you aren&#8217;t able to pull down the code from GitHub, you&#8217;ll need to download the code in a zip file &quot;from github&quot;:<a href="http://github.com/technoweenie/restful-authentication/zipball/afa61fece60a3cd53a9c894d74b883889b440913">http://github.com/technoweenie/restful-authentication/zipball/afa61fece60a3cd53a9c894d74b883889b440913</a>, then extract the zip into <code>/vendor/plugins/restful_authentication/</code>. </p>

<p>Once you&#8217;ve installed the plugin, you can test that it&#8217;s available with this command at your terminal:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>rails generate</span></code></pre></td></tr></table></div></figure>

<p>In the output is a section title &quot;Installed Generators&quot;. It should have a line that says @Plugins (vendor/plugins): <a href="mailto:authenticated@">authenticated@</a>. If it&#8217;s there, you&#8217;re ready to go!</p>

<h3>Running the Generator</h3>

<p>This plugin makes it easy to get up an running because one generator creates most of the code you&#8217;ll need. Run this from your terminal:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>rails generate authenticated user sessions</span></code></pre></td></tr></table></div></figure>

<p>Take a look at the output and you&#8217;ll see it created about 16 files and added a few routes to the <code>routes.rb</code> file. The generator has a note that you shouldn&#8217;t forget to add the routes to <code>routes.rb</code>, but it&#8217;s already done that for you.</p>

<p>Let&#8217;s look at the CreateUsers migration that the generator created before we migrate the database. If you wanted your User models to have any additional information (like &quot;deparment<em>name&quot; or &quot;favorite</em>color&quot;) you could add columns for that. For our purposes these fields look alright and, thanks to the flexibility of migrations, if we want to add columns later it&#8217;s easy. So go to your terminal and enter:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>rake db:migrate</span></code></pre></td></tr></table></div></figure>

<h3>Creating a First Account</h3>

<p>First, stop then restart your server in RubyMine to make sure it&#8217;s picked up the plugin. Then go to <code>http://localhost:3000/users/new</code> and the new user form should popup.</p>

<p>Go ahead and create yourself an account. If you&#8217;re successful it will just bounce you to the <code>http://localhost:3000/</code> root page. There isn&#8217;t any information about our login status in our views, though, so it&#8217;s hard to tell if we&#8217;re really logged in.</p>

<p>Let&#8217;s open <code>/app/views/layouts/application.html.haml</code> and add a little footer so the whole <code>%body%</code> chunk looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="o">%</span><span class="n">body</span>
</span><span class='line'>    <span class="c1">#container</span>
</span><span class='line'>      <span class="c1">#content</span>
</span><span class='line'>        <span class="o">=</span> <span class="k">yield</span>
</span><span class='line'>        <span class="o">%</span><span class="n">hr</span>
</span><span class='line'>        <span class="o">%</span><span class="n">h6</span>
</span><span class='line'>          <span class="o">-</span> <span class="k">if</span> <span class="n">current_user</span>
</span><span class='line'>            <span class="o">=</span> <span class="s2">&quot;Logged in as </span><span class="si">#{</span><span class="n">current_user</span><span class="o">.</span><span class="n">login</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>            <span class="o">=</span> <span class="n">link_to</span> <span class="s2">&quot;(logout)&quot;</span><span class="p">,</span> <span class="n">logout_path</span>
</span><span class='line'>          <span class="o">-</span> <span class="k">else</span>
</span><span class='line'>            <span class="o">=</span> <span class="n">link_to</span> <span class="s2">&quot;(login)&quot;</span><span class="p">,</span> <span class="n">login_path</span>
</span></code></pre></td></tr></table></div></figure>

<p>The go to <code>http://localhost:3000/articles/</code> and you&#8217;ll get this error:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>NameError in Articles#index
</span><span class='line'>Showing app/views/layouts/application.html.haml where line #14 raised:
</span><span class='line'>undefined local variable or method `current_user' for #&lt;ActionView::Base:0x103147400&gt;</span></code></pre></td></tr></table></div></figure>

<p>We tried to use the <code>current_user</code> helper that comes with the restful_authentication plugin, but Rails isn&#8217;t recognizing it. We need to do one more setup step. Open <code>/app/controllers/application_controller.rb</code>, and underneath the <code>protect_from_forgery</code> line, add this: @include <a href="mailto:AuthenticatedSystem@">AuthenticatedSystem@</a>. </p>

<p>Now refresh your browser and your articles list should come up along with the new footer at the bottom.</p>

<h3>An Aside on the Site Root</h3>

<p>It&#8217;s annoying me that we keep going to <code>http://localhost:3000/</code> and seeing the Rails starter page. Let&#8217;s make the root show our articles index page.</p>

<p>First, delete the file <code>/public/index.html</code>. Files in the public directory will take precedence over routes in our application, so as long as that file exists we can&#8217;t route the root address anywhere.</p>

<p>Second, open <code>/config/routes.rb</code> and right above the other routes add in this one:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">match</span> <span class="s1">&#39;/&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;articles#index&#39;</span>
</span></code></pre></td></tr></table></div></figure>

<p>Now visit <code>http://localhost:3000</code> and you should see your article list.</p>

<h3>Securing New Users</h3>

<p>It looks like we can create a new user, but right away I want to make some changes. We&#8217;re just going to use one layer of security for the app &#8211; a user who is logged in has access to all the commands and pages, while a user who isn&#8217;t logged in can only post comments and try to login. But that scheme will breakdown if just anyone can go to this URL and create an account, right?</p>

<p>Let&#8217;s add in a protection scheme like this to the new users form:</p>

<ul>
<li>If there are zero users in the system, let anyone access the form</li>
<li>If there are more than zero users registered, only users already logged in can access this form</li>
</ul>

<p>That way when the app is first setup we can create an account, then new users can only be created by a logged in user.</p>

<p>We can create a <code>before_filter</code> which will run <em>before</em> the <code>new</code> and <code>create</code> actions of our <code>users_controller.rb</code>. Open that controller and on the second line you&#8217;ll see @include <a href="mailto:AuthenticatedSystem@">AuthenticatedSystem@</a>. You can remove that since we put it in the <code>application_controller</code> and, in its place, put all this code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="n">before_filter</span> <span class="ss">:zero_users_or_authenticated</span><span class="p">,</span> <span class="ss">:only</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:new</span><span class="p">,</span> <span class="ss">:create</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">zero_users_or_authenticated</span>
</span><span class='line'>    <span class="k">unless</span> <span class="no">User</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">current_user</span>
</span><span class='line'>      <span class="n">redirect_to</span> <span class="n">root_path</span>
</span><span class='line'>      <span class="k">return</span> <span class="kp">false</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>The first line declares that we want to run a before filter named <code>zero_or_authenticated</code> when either the <code>new</code> or <code>create</code> methods are accessed. Then we define that filter, checking if there are either zero registered users OR if there is a user already logged in. If neither of those is true, we redirect to the root path (our articles list) and return false. If either one of them is true this filter won&#8217;t do anything, allowing the requested user registration form to be rendered.</p>

<p>With that in place, try accessing <code>/users/new</code> when you logged in and when your logged out. If you want to test that it works when no users exist, try this at your console:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>User.destroy_all</span></code></pre></td></tr></table></div></figure>

<p>Then try to reach the registration form and it should work!  Create yourself an account if you&#8217;ve destroyed it.</p>

<h3>Securing the Rest of the Application</h3>

<p>The first thing we need to do is sprinkle <code>before_filters</code> on most of our controllers:</p>

<ul>
<li>In <code>users_controller</code>, add a before filter to protect the actions besides <code>new</code> and <code>create</code> like this:<br/>@before<em>filter :login</em>required, :except =&gt; [:new, :create]@</li>
<li>In <code>tags_controller</code>, we don&#8217;t have any methods that need to be protected.</li>
<li>In <code>sessions_controller</code> all the methods need to be accessible to allow login and logout</li>
<li>In <code>comments_controller</code>, we never implemented <code>index</code> and <code>destroy</code>, but just in case we do let&#8217;s allow unauthenticated users to only access <code>create@:&lt;br/&gt;</code>before<em>filter :login</em>required, :except =&gt; [:create]@</li>
<li>In <code>articles_controller</code> authentication should be required for <code>new</code>, <code>create</code>, <code>edit</code>, <code>update</code> and <code>destroy</code>. Figure out how to write the before filter using either <code>:only</code> or <code>:except</code></li>
</ul>

<p>Now our app is pretty secure, but we should hide all those edit, destroy, and new article links from unauthenticated users.</p>

<p>Open <code>/app/views/articles/index.html.erb</code> and find the section where we output the &quot;Actions&quot;. Wrap that whole section in an <code>if</code> clause like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&lt;</span><span class="sx">% if </span><span class="n">current_user</span> <span class="sx">%&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sx">&lt;% end %&gt;</span>
</span></code></pre></td></tr></table></div></figure>

<p>Look at the article listing in your browser when you&#8217;re logged out and make sure those links disappear. Then use the same technique to hide the &quot;Create a New Article&quot; link.</p>

<p>If you look at the <code>show</code> view template, you&#8217;ll see that we never added an edit link!  Add that link now, but protect it to only show up when a user is logged in.</p>

<p>Your basic authentication is done, and Iteration 5 is complete!
&#8220;`</p>

<h2>I6: Extras</h2>

<p>Here are some ideas for extension exercises:</p>

<ul>
<li>Add a site-wide sidebar that holds navigation links</li>
<li>Create date-based navigation links. For instance, there would be a list of links with the names of the months and when you click on the month it shows you all the articles published in that month.</li>
<li>Track the number of times an article has been viewed. Add a <code>view_count</code> column to the article, then in the <code>show</code> method of <code>articles_controller.rb</code> just increment that counter. Or, better yet, add a method in the <code>article.rb</code> model that increments the counter and call that method from the controller.</li>
<li>Once you are tracking views, create a list of the three &quot;most popular&quot; articles</li>
<li>Create a simple RSS feed for articles using the <code>respond_to</code> method and XML view templates</li>
</ul>

  
    <footer>
      
      
        <div class="sharing">
  
  
</div>

      
    </footer>
  
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
  </ul>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2012 - Jumpstart Lab -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  


  

  

  

  <div class="slide-out-div">
  <a class="handle" href="#">Feedback</a>
  <h3>Have Feedback?</h3>
  <p>Did you find an error? Something confusing? We'd love your help:</p>
  <ul>
    <li><a href="#" id="edit_source">Edit the source code of this page directly on Github</a></li>
    <li><a href="https://github.com/JumpstartLab/curriculum/issues">Create a new issue on the project's Github page</a></li>
  </ul>
  <p>Thanks!</p>
</div>

<script>
  var pathname = window.location.pathname.replace( ".html", ".markdown" );
  var github_url = "https://github.com/JumpstartLab/curriculum/blob/master/source" + pathname;
  $("a#edit_source").attr('href', github_url);
</script>

</body>
</html>
