
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>JSContact - Jumpstart Lab Curriculum</title>
  <meta name="author" content="Jumpstart Lab">

  
  <meta name="description" content="In this advanced Rails project, you&#8217;ll create a contact manager. The tools that you will use include the following:	Testing with RSpec to dri...">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://yoursite.com/projects/jscontact.html">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection, print" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="http://s3.amazonaws.com/ender-js/jeesh.min.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Jumpstart Lab Curriculum" type="application/atom+xml">
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.3/jquery.min.js" type="text/javascript"></script>
  <script src="http://tab-slide-out.googlecode.com/files/jquery.tabSlideOut.v1.3.js"></script>

  <script type="text/javascript">
    $(function(){
      $('.slide-out-div').tabSlideOut({
        tabHandle: '.handle',                     //class of the element that will become your tab
        pathToTabImage: '/images/feedback_tab.png', //path to the image for the tab //Optionally can be set using css
        imageHeight: '150px',                     //height of tab image           //Optionally can be set using css
        imageWidth: '50px',                       //width of tab image            //Optionally can be set using css
        tabLocation: 'left',                      //side of screen where tab lives, top, right, bottom, or left
        speed: 300,                               //speed of animation
        action: 'click',                          //options: 'click' or 'hover', action to trigger animation
        topPos: '200px',                          //position from the top/ use if tabLocation is left or right
        leftPos: '20px',                          //position from left/ use if tabLocation is bottom or top
        fixedPosition: true                      //options: true makes it stick(fixed position) on scroll
        });
      });
  </script>

  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

</head>

<body  >
  <header role="banner"><hgroup>
  <h1><a href="/">Jumpstart Lab Curriculum</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:yoursite.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
<ul class="main-navigation">
  <li><a href="/">Curriculum Index</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <p>In this advanced Rails project, you&#8217;ll create a contact manager. The tools that you will use include the following:</p>
<ul>
	<li>Testing with <a href="http://relishapp.com/rspec/">RSpec</a> to drive your development</li>
	<li>Creating view templates with <a href="http://haml-lang.com/"><span class="caps">HAML</span></a> and <a href="http://sass-lang.com/"><span class="caps">SASS</span></a></li>
	<li>Generating code with <a href="http://github.com/ryanb/nifty-generators">Nifty Generators</a></li>
	<li>Building complex forms with <a href="http://github.com/plataformatec/simple_form">Simple Form</a></li>
	<li>Building Rails3/<span class="caps">AREL</span> queries and scopes</li>
	<li>Handling file attachments with <a href="http://github.com/jnicklas/carrierwave">Carrierwave</a></li>
	<li>Building reusable view code with helpers and partials</li>
	<li>Refactoring</li>
	<li>Managing authentication and authorization</li>
	<li>Server and client-side validations</li>
	<li>Deployment and monitoring</li>
</ul>
<p>This project assumes you have already completed the <a href="http://jumpstartlab.com/resources/general/environment/">general Ruby setup</a> and I&#8217;m using <strong>Ruby 1.9.2</strong>. We&#8217;ll rely on the Bundler system to install other gems for us along the way.</p>
<p>In addition, I recommend you use the RubyMine <span class="caps">IDE</span> 3.1 available <a href="http://www.jetbrains.com/ruby/download/">from JetBrains here</a>.</p>
<p>We&#8217;ll use an iterative approach to develop one feature at a time. Here goes!</p>
<h2>I0: Up and Running</h2>
<p>Let&#8217;s lay the groundwork for our project. In your terminal, switch to the directory where you&#8217;d like your project to be stored. I&#8217;ll use <code>~/Projects</code>.</p>
<p>Run the <code>rails -v</code> command and you should see your current Rails version, mine is <strong>3.0.9</strong>. Let&#8217;s create a new Rails project:</p>
<pre class='console'>
  rails new JSContact
</pre>
<p>Then <code>cd</code> into your project directory and open the project in your editor of choice.</p>
<h3>Veering Off the &#8220;Golden Path&#8221; with RSpec</h3>
<p>With our project created, we will veer off the Rails defaults for both the testing and JavaScript libraries. First, let&#8217;s setup RSpec as our testing framework. Open your project&#8217;s <code>Gemfile</code> and add this dependency:</p>
<pre class='brush:ruby'>
  gem 'rspec-rails'
</pre>
<p>Then, in your terminal window that&#8217;s in the project directory, run bundle:</p>
<pre class='console'>
  bundle
</pre>
<p>Now rspec-rails is available, but we still need to do some setup to make it all work. Running this generator will perform the setup for you:</p>
<pre class='console'>
  rails generate rspec:install
</pre>
<p>You should see output like this:</p>
<pre class='console'>
  create  .rspec
  create  spec
  create  spec/spec_helper.rb
</pre>
<p>Now your project is set to use RSpec and the generators will use RSpec by default. You still have Rails&#8217; default <code>test</code> folder hanging around &#8212; let&#8217;s delete that with:</p>
<pre class='console'>
  rm -rf test
</pre>
<p>Or on Windows try:</p>
<pre class='console'>
  rd /r test
</pre>
<p>Now you&#8217;re free of <code>Test::Unit</code> and ready to rock with RSpec.</p>
<h3>Replacing Prototype with jQuery</h3>
<p>Go back to your <code>Gemfile</code> and add this dependency:</p>
<pre class='brush:ruby'>
  gem 'jquery-rails'
</pre>
<p>Run <code>bundle</code> again and then run this generator from your project directory:</p>
<pre class='console'>
  rails generate jquery:install
</pre>
<p>As it installs the files you&#8217;ll get a question about the conflicting <code>rails.js</code> file &#8212; enter <code>y</code> to overwrite it:</p>
<pre class='console'>
      remove  public/javascripts/controls.js
      remove  public/javascripts/dragdrop.js
      remove  public/javascripts/effects.js
      remove  public/javascripts/prototype.js
    fetching  jQuery (1.5)
      create  public/javascripts/jquery.js
      create  public/javascripts/jquery.min.js
    fetching  jQuery UJS adapter (github HEAD)
    conflict  public/javascripts/rails.js
Overwrite /Users/jcasimir/Projects/JSContact/public/javascripts/rails.js? (enter "h" for help) [Ynaqdh] y
       force  public/javascripts/rails.js
</pre>
<p>The <code>jquery-rails</code> gem does everything for you&#8230; well, almost. Your layout needs to know which JavaScript libraries you want to load.</p>
<p>To tell it to use jQuery, open <code>/config/application.rb</code> and uncomment this line:</p>
<pre class="brush:ruby">
  config.action_view.javascript_expansions[:defaults] = %w(jquery rails)
</pre>
<p>It&#8217;s currently the third section from the bottom, but <span class="caps">YMMV</span>.</p>
<h3>Startup Your Local Server</h3>
<p>Open a second terminal window, <code>cd</code> into your project directory, then start your server with:</p>
<pre class="console">
  rails server
</pre>
<p>This will, by default, use the Webrick server which is slow as molasses. Hit Ctrl-C to stop it. Some of the alternative servers are <strong>mongrel</strong> and <strong>unicorn</strong>. Here&#8217;s how to setup unicorn.</p>
<p>Add this the dependency to your <code>Gemfile</code>:</p>
<pre class='brush:ruby'>
  gem 'unicorn'
</pre>
<p>Run <code>bundle</code> from your project directory and wait for the installation to complete. Start the server like this:</p>
<pre class="console">
  unicorn
</pre>
<p>Load <a href="http://0.0.0.0:8080">http://0.0.0.0:8080</a> in your browser and you should see the Rails splash screen. Click the &#8220;About Your Application&#8221; link and you should see all your library versions. If your database were not installed properly or inaccessible, you&#8217;d see an error here.</p>
<h3>Setup Git Repository</h3>
<p>I&#8217;ll assume that you&#8217;ve already setup Git on your system. From within your project directory, create a new repository with:</p>
<pre class="console">
  git init .
</pre>
<p>Then add all of the files in your current working directory to the repository and commit it:</p>
<pre class="console">
  git add .
  git commit -m "Initial project generated"
</pre>
<p>At this point if you&#8217;re using GitHub, you could add that remote and push to it. For purposes of this tutorial, we&#8217;ll just manage the code locally.</p>
<h3>Ship It</h3>
<p>Next let&#8217;s integrate <a href="http://www.heroku.com/">Heroku</a>.</p>
<p>If you don&#8217;t already have one, you&#8217;ll need to create a Heroku account. The <code>heroku</code> gem will ask for your username and password the first time you run <code>heroku create</code>, but after that you&#8217;ll be using an <span class="caps">SSH</span> key for authentication.</p>
<p>Open up that <code>Gemfile</code> and add this dependency:</p>
<pre class='brush:ruby'>
  gem 'heroku'
</pre>
<p>Run the <code>bundle</code> command again and now you&#8217;ll have command-line access to Heroku.</p>
<pre class="console">
  heroku create
</pre>
<p>After running that command, you&#8217;ll get back the <span class="caps">URL</span> where the app is accessible. Try loading the <span class="caps">URL</span> in your browser and you&#8217;ll see the generic Heroku splash screen. It&#8217;s not running your code yet so push your project up like this:</p>
<pre class="console">
  git push heroku master
</pre>
<p>It&#8217;ll take a minute, then you should see a message that your application was successfully deployed like this:</p>
<pre class="console">
  -----&gt; Launching... done
         http://jscontact.heroku.com deployed to Heroku
</pre>
<p>Refresh your browser and you should see the Rails splash screen. Click &#8220;About your application&#8217;s environment&#8221; again, and&#8230;wait, what happened?  When your app is running on Heroku it&#8217;s in <strong>production</strong> mode. This diagnostic info isn&#8217;t available when the server is running in production, so you&#8217;ll see a default error message. Don&#8217;t worry, everything should be running fine.</p>
<h3>Dependency Cleanup</h3>
<p>We&#8217;ve added several gems to our <code>Gemfile</code>, but several of them are only useful for development or testing. It doesn&#8217;t make sense, then, to have Heroku install and load them in production. It costs <span class="caps">RAM</span> and slows down our deployment. The Bundler system can handle this with environment blocks. I also like to remove all the comments from the <code>Gemfile</code>, leaving me with just this:</p>
<pre class='brush:ruby'>
  source 'http://rubygems.org'

  gem 'rails', '3.0.9'
  gem 'sqlite3'

  group :development, :test do
    gem 'rspec-rails'
    gem 'jquery-rails'
    gem 'heroku'
    gem 'unicorn'
  end
</pre>
<p>Now the RSpec, Heroku, Unicorn, and Unicorn gems will only be loaded in development and test environments. If you&#8217;re wondering, the jQuery gem doesn&#8217;t have any role in production because we&#8217;ve already stored the jQuery JavaScript files into our <code>public</code> directory using the generator. Similarly, though we&#8217;re deploying to Heroku, the <code>heroku</code> gem is only used during development. Save your new Gemfile and ship it:</p>
<pre class="console">
  git add .
  git commit -m "Added dev and test blocks to Gemfile"
  git push heroku master
</pre>
<p>Now we&#8217;re ready to actually build our app!</p>
<h2>I1: Building People</h2>
<p>We&#8217;re building a contact manager, so let&#8217;s start with modeling people. Since this is an advanced tutorial we won&#8217;t slog through the details of implementing a Person model, controller, and views. Instead we&#8217;ll take advantage of scaffolding tools.</p>
<h3>A Feature Branch</h3>
<p>But first, let&#8217;s make a feature branch in git:</p>
<pre class="console">
  git branch build_people
  git checkout build_people
</pre>
<p>Now all our changes will be made on the <code>build_people</code> branch. As we finish the iteration we&#8217;ll merge the changes back into master and ship it.</p>
<h3>Nifty Scaffold</h3>
<p>I want to use the scaffold generator to create a model named <code>Person</code>, but I don&#8217;t care for some of the conventions used in the default Rails scaffold generator. Instead, I prefer the <code>nifty-generators</code> created by <a href="http://railscasts.com">RailsCasts author Ryan Bates</a>.</p>
<p>In the development section of your <code>Gemfile</code>, add a dependency for <code>"nifty-generators"</code>, run <code>bundle</code> from the command prompt, then run this generator, answering <code>yes</code> to the conflict:</p>
<pre class="console">
  rails generate nifty:layout
</pre>
<p>That sets us up to use his &#8220;nifty&#8221; scaffolding. Let&#8217;s then generate a scaffolded model named <code>Person</code> that just has a <code>first_name</code> and <code>last_name</code>:</p>
<pre class="console">
  rails generate nifty:scaffold Person first_name:string last_name:string
</pre>
<p>The first line of the output shows Ryan sneaking the <code>"mocha"</code> gem into our Gemfile. Let&#8217;s move the gem dependency into the development/test block we already have and run <code>bundle</code> and then run the migration with <code>rake db:migrate</code>.</p>
<p>The generators created test-related files for us. They saw that we&#8217;re using RSpec and created corresponding controller and model test files. Let&#8217;s run those tests now:</p>
<pre class="console">
  rake
</pre>
<p>Assuming those test&#8217;s pass use <code>git add .</code> to add all current changes to your repository and commit them with a short message like <code>git commit -m "Setup nifty_scaffold and used it to generate Person model"</code></p>
<p>Try creating a few sample people at <code>http://localhost:8080/people</code> through your browser.</p>
<h3>Starting with Testing</h3>
<p>Models are the place to start your testing. The model is the application&#8217;s representation of the data layer, the foundation of any functionality. In the same way we&#8217;ll build low-level tests on the models which will be the foundation of our test suite.</p>
<p>Open <code>spec/models/person_spec.rb</code> and you&#8217;ll see this:</p>
<pre class="brush: ruby">
require File.dirname(__FILE__) + '/../spec_helper'

describe Person do
  it "should be valid" do
    Person.new.should be_valid
  end
end
</pre>
<p>The <code>describe</code> block will wrap all of our tests or &#8220;examples&#8221; in RSpec parlance. Each <code>it</code> block is an example. Add a second one like this:</p>
<pre class="brush: ruby">
  require File.dirname(__FILE__) + '/../spec_helper'

  describe Person do
    it "should be valid" do
      Person.new.should be_valid
    end

    it "should not be valid without a first name"
  end
</pre>
<p>Now go to your terminal, enter the command <code>rake</code>, and you should see output like this:</p>
<pre class="console">
  ..........*

  Pending:
    Person should not be valid without a first name
      # Not Yet Implemented
      # ./spec/models/person_spec.rb:8

  Finished in 0.23891 seconds
  11 examples, 0 failures, 1 pending
</pre>
<p>Awesome! We can see that it found the spec we wrote, <code>"should not be valid without a first_name"</code>, tried to execute it, and found that the test wasn&#8217;t yet implemented. We have one example, zero failures, and one implementation pending. We&#8217;re ready to start testing!</p>
<h3>Testing for Data Presence</h3>
<p>First we&#8217;ll implement the existing example to actually check that <code>first_name</code> can&#8217;t be blank. Make your <code>person_spec.rb</code> look like this:</p>
<pre class="brush:ruby">
  it "should not be valid without a first name" do
    person = Person.new(:first_name =&gt; nil)
    person.should_not be_valid
  end
</pre>
<p>Run your tests with <code>rake</code> and you should now get this:</p>
<pre class="console">
..........F

Failures:

  1) Person should not be valid without a first name
     Failure/Error: person.should_not be_valid
       expected valid? to return false, got true
     # ./spec/models/person_spec.rb:10:in `block (2 levels) in &lt;top (required)&gt;'

Finished in 0.23345 seconds
11 examples, 1 failure
</pre>
<p>The test failed because it expected a person with no first name to be invalid, but instead it <strong>was</strong> valid. We can fix that by adding a validation inside the model:</p>
<pre class="brush:ruby">
  class Person &lt; ActiveRecord::Base
    attr_accessible :first_name, :last_name

    validates :first_name, :presence =&gt; true
  end  
</pre>
<p>If you run <code>rake</code> here you&#8217;ll see that the tests are <em>still</em> failing. Huh?  Try running it like this:</p>
<pre class="console">
  rspec spec/models/person_spec.rb
</pre>
<p>Now the first test fails because it&#8217;s blank <code>Person</code> isn&#8217;t valid. Rewrite the test like this:</p>
<pre class="brush:ruby">
it "should be valid" do
  person = Person.new(:first_name =&gt; "Sample", :last_name =&gt; "Person")
  person.should be_valid
end
</pre>
<p>Now both tests will pass if you run <code>rspec spec/models/person_spec.rb</code>. Run just <code>rake</code> and the second test will still fail. This doesn&#8217;t make any sense!</p>
<p>Open up the generated <code>/spec/controllers/people_controller_spec.rb</code>. On about line 46 there should be this instruction:</p>
<pre class="brush:ruby">
  Person.any_instance.stubs(:valid?).returns(true)
</pre>
<p>The Nifty Generator has created these controller tests using the Mocha gem for stubbing out method calls. He has stubbed calls to the <code>valid?</code> method to simplify the controller tests. But, these stubs are affecting our later model tests giving odd results.</p>
<p>When we run the model test directly, everything works. When we run just <code>rake</code>, it&#8217;s running these controller tests, setting up the mocking, then our model test is breaking. We&#8217;ll come back to controller testing later, but for now let&#8217;s <strong>comment out the whole <code>/spec/controllers/people_controller_spec.rb</code></strong>.</p>
<p>Then run <code>rake</code> and your tests should pass.</p>
<p>Following that example for <code>:first_name</code>, let&#8217;s add a validation for <code>:last_name</code> to the model then write a test checking that a person is not valid without a last name.</p>
<p>Run <code>rake</code> and make sure you get <code>0 failures</code>.</p>
<h3>Experimenting with Our Tests</h3>
<p>Go into the <code>person.rb</code> model and temporarily remove <code>:last_name</code> from the <code>validates_presence_of</code> line. Run your tests with <code>rake</code>. What happened?</p>
<p>This is what&#8217;s called a false positive. The <code>is not valid without a last_name</code> test is passing, but not for the right reason. Even though we&#8217;re not validating <code>last_name</code>, the test is passing because the model it&#8217;s building doesn&#8217;t have a valid <code>first_name</code> either. That causes the validation to fail and our test to pass. We need to improve the object created in the test so that the other attributes are valid and only the one being tested is invalid. Let&#8217;s refactor.</p>
<p>First, just below the <code>describe</code> line of our <code>person_spec</code>, let&#8217;s add this code which will get executed before <code>each</code> of our examples:</p>
<pre class="brush:ruby">
  before(:each) do
    @person = Person.new(:first_name =&gt; "John",
                           :last_name =&gt; "Doe")
  end
</pre>
<p>Then update your first name and last name tests to a format like this:</p>
<pre class="brush:ruby">
  it "is not valid without a first_name" do
    @person.first_name = nil
    @person.should_not be_valid
  end
</pre>
<p>Run your tests and now the <code>is not valid without a last name</code> test should fail. Read the output that RSpec gives you to help find the problem. In this case, it&#8217;s easy &#8212; just add <code>:last_name</code> back where you removed it from the validation in <code>person.rb</code>.</p>
<h3>Checking the Checkers</h3>
<p>The <code>before(:each)</code> clause we wrote will make writing test examples a lot easier, but we had better write a test to ensure that what we&#8217;re calling <code>@person</code> is actually valid!  Write an example that just asserts that <code>@person.should_be valid</code>.</p>
<p>Run the tests to make sure they work and you should now have 3 examples, 0 failures.</p>
<h3>Ship It</h3>
<p>Hop over to your command prompt and let&#8217;s work with git. First, ensure that everything is committed on our branch:</p>
<pre class="console">
  git status
  git add .
  git commit -m "Finished implementing basic person functionality"
</pre>
<p>Then this branch is done. Let&#8217;s go back to the master branch and merge it in:</p>
<pre class="console">
  git checkout master
  git merge build_people
</pre>
<p>Now it&#8217;s ready to send to Heroku and run our migrations:</p>
<pre class="console">
  git push heroku master
  heroku rake db:migrate
</pre>
<p>Open up your production app in your browser and you should be able to create sample people.</p>
<h2>I2: Phone Numbers</h2>
<p>We&#8217;ve created a few tests to demonstrate the validations we already had in place. We wrote the validations first then the tests second. This process is better than no testing, but it isn&#8217;t Test Driven Development. Now we&#8217;ll experiment with writing the tests first, then writing just enough code to make the tests pass.</p>
<h3>A Feature Branch</h3>
<p>Let&#8217;s again make a feature branch in git:</p>
<pre class="console">
  git branch build_phone_numbers
  git checkout build_phone_numbers
</pre>
<p>Now all our changes will be made on the <code>build_phone_numbers</code> branch. As we finish the iteration we&#8217;ll merge the changes back into master and ship it.</p>
<h3>Modeling The Objects</h3>
<p>First, let&#8217;s think about the data relationship. A person is going to have multiple phone numbers, and a phone number is going to attach to one person. In the database world, this is a one-to-many relationship, one person has many phone numbers.</p>
<h4>One-to-Many Relationship</h4>
<p>The way this is traditionally implemented in a relational database is that the &#8220;many&#8221; table holds a foreign key pointing back to the row from the &#8220;one&#8221; table that it belongs to. So we might have a person with ID number 6, then there would be phone numbers that have a foreign key <code>person_id</code> with the value 6.</p>
<h4>Test First: A Person Should Have Phone Numbers</h4>
<p>With that understanding, let&#8217;s write a test. We just want to check that a person is capable of having phone numbers. In your <code>person_spec.rb</code> let&#8217;s add this test:</p>
<pre class="brush:ruby">
  it "should have an array of phone numbers" do
    @person.phone_numbers.class.should == Array    
  end
</pre>
<p>Run <code>rake</code> and make sure the test fails with <code>undefined method 'phone_numbers'</code>. Now we&#8217;re ready to create a <code>PhoneNumber</code> model and corresponding association in the <code>Person</code> model.</p>
<h4>Scaffolding the Phone Number Model</h4>
<p>We&#8217;ll use the <code>nifty_scaffold</code> generator again to save us a little time. For now we&#8217;ll keep the phone number simple, it&#8217;ll just have a <code>number</code> column that holds the number and a <code>person_id</code> column that refers to the owning person model. Generate it with this command at the terminal:</p>
<pre class="console">
rails generate nifty:scaffold PhoneNumber number:string person_id:integer
</pre>
<p>This will generate a new <code>/spec/controllers/phone_number_spec.rb</code> which you should comment out.</p>
<p>Run <code>rake db:migrate</code> to execute the generated migration. Run <code>rake</code> again and make sure the test isn&#8217;t passing yet.</p>
<h4>Setting Relationships</h4>
<p>Next open the <code>person.rb</code> model and add the association <code>has_many :phone_numbers</code>. Run <code>rake</code> and your tests should all pass.</p>
<p>Try it out yourself by going into the console via <code>rails console</code> and adding a phone number manually:</p>
<pre class="console">
p = Person.first
p.phone_numbers.create(:number =&gt; '2024605555')  
</pre>
<h4>Validating Phone Numbers</h4>
<p>Right now the phone number is just stored as a string, so maybe the user enters a good-looking one like &#8220;2024600772&#8221; or maybe they enter &#8220;please-don&#8217;t-call-me&#8221;. Let&#8217;s add some validations to make sure the phone number can&#8217;t be blank.</p>
<p>Go into <code>phone_number_spec.rb</code> and mimic some of the same things we did in <code>person_spec</code>. We can start off by writing a <code>before(:each)</code> block to setup our <code>PhoneNumber</code> object. Enter this just below the <code>describe</code> line:</p>
<pre class="brush:ruby">
  before(:each) do
    @phone_number = PhoneNumber.new()
  end
</pre>
<p>Let&#8217;s also change the <code>"should be valid"</code> test to use that variable:</p>
<pre class="brush:ruby">
  it "should be valid" do
    @phone_number.should be_valid
  end
</pre>
<p>Then write a test ensuring that a <code>PhoneNumber</code> is connected to a <code>Person</code>:</p>
<pre class="brush:ruby">
  it "should be associated with a person" do
    @phone_number.should respond_to(:person)
  end
</pre>
<p>Run your tests with <code>rake</code> and that last one will <strong>fail</strong>.</p>
<p>Go into the <code>phone_number.rb</code> model and add the relationship <code>belongs_to :person</code>. Run <code>rake</code> again and they they should all pass.</p>
<p>We want to start working on valid formats for a phone number, so let&#8217;s write a failing test first that checks if a phone number can be blank:</p>
<pre class="brush:ruby">
  it "should not be valid without a number" do
    @phone_number.number = nil
    @phone_number.should_not be_valid
  end
</pre>
<p>Run <code>rake</code> and you should have one failing test. Once you see red, go into the <code>phone_number.rb</code> model and add a validation checking the existence of the <code>number</code>, run your tests again, and make sure they&#8217;re green.</p>
<p>A <code>PhoneNumber</code> shouldn&#8217;t be allowed to float out in space, so let&#8217;s require that it be attached to a <code>Person</code>:</p>
<pre class="brush:ruby">
  it "should not be valid without a person" do
    @phone_number.person = nil
    @phone_number.should_not be_valid
  end
</pre>
<p>Run <code>rake</code> and your new test should fail. Add a validation that checks the presence of <code>person</code>. Then run <code>rake</code>.</p>
<p>Still have one test failing? Look carefully at <strong>which</strong> test is failing. It&#8217;s now the <code>"should_be_valid"</code> test. We need to modify our <code>before</code> block to actually make a valid <code>PhoneNumber</code>. Try this:</p>
<pre class="brush:ruby">
  before(:each) do
    @person = Person.create(:first_name =&gt; "Sample", :last_name =&gt; "Name")
    @phone_number = @person.phone_numbers.create(:number =&gt; "2024605555")
  end
</pre>
<p>A lot of work for two validations, but these are an important part of our testing base. If somehow one of the validations got deleted accidentally, we&#8217;d know it right away.</p>
<h4>Commit</h4>
<p>Since your tests are passing it&#8217;s a good time to commit your changes to the git repository:</p>
<pre class="console">
  git add .
  git commit -m "Built phone numbers with simple validations"
</pre>
<h3>Building a Web Display</h3>
<p>We can create phone numbers in the console but that&#8217;s not very useful, let&#8217;s work on the views and forms. We&#8217;ll make use of the simpleform gem to help our forms.</p>
<p>Visit <code>localhost:8080/people</code> and you&#8217;ll see any sample people you&#8217;ve created so far. Let&#8217;s add a column that displays their phone numbers. Open the <code>app/views/people/index.html.erb</code> view. In that view:</p>
<ul>
	<li>Add another <code>th</code> header with the text &#8220;Phone Numbers&#8221;</li>
	<li>Add another <code>td</code> where we&#8217;ll display the numbers</li>
	<li>To output the actual numbers we&#8217;ll use a helper like this: <code>print_numbers person.phone_numbers</code></li>
</ul>
<p>Refresh your browser and it should give you an error message about the undefined helper method <code>print_numbers</code>.</p>
<h4>When do we write helpers?</h4>
<p>We should write a helper to encapsulate view-related code that involves logic. A partial template is for reusing view chunks that are mostly <span class="caps">HTML</span>, helpers are useful for view chunks that are mostly computation.</p>
<p>We want to output a comma-separated list of the person&#8217;s phone numbers. It&#8217;s a perfect candidate for a helper.</p>
<h4>Testing Helpers</h4>
<p>Many developers don&#8217;t test helpers, but I find they&#8217;re one of the most common failure points in production applications. Devs don&#8217;think they need to write tests for them because they&#8217;re &#8220;just little presentation methods&#8221; but then you see weird presentation artifacts in the application as the helpers get changed.</p>
<p>Writing tests for helpers is super easy, here&#8217;s how we can do it.</p>
<p>First, create a folder <code>/spec/helpers/</code>. Within that folder, create a file named <code>phone_numbers_helper_spec.rb</code> and open it. Start off with this frame:</p>
<pre class="brush:ruby">
  require 'spec_helper'

  describe PhoneNumbersHelper do
  end
</pre>
<p>Run <code>rake</code> and, if you look closely you&#8217;ll see your new helper spec file in the executed command.</p>
<p>When we wrote our model spec, it made sense to drop right into an <code>it</code> example. There was a clear &#8220;it&#8221;, the model. In the helper spec, though, we want to set a context of an individual method named &#8220;print_numbers&#8221;. Then within that context we&#8217;ll write examples of how the method should operation.</p>
<p>We add the context by nesting another <code>describe</code> block inside the existing one like this:</p>
<pre class="brush:ruby">
  require 'spec_helper'

  describe PhoneNumbersHelper do
    describe "print_numbers" do
      # Examples go here
    end
  end
</pre>
<p>Now, inside the inner <code>describe</code> block, let&#8217;s write an example. Name it <code>should output a comma-separated list of phone numbers</code>. Within that example, make two <code>PhoneNumber</code> objects, pass them as an array into <code>print_numbers</code> and check that the output is the first number, a comma, a space, then the second number. Or, in code&#8230;</p>
<pre class="brush:ruby">
describe "print_numbers" do
  it "should output a comma-separated list of phone numbers" do
    number_a = PhoneNumber.new(:number =&gt; "1234567")
    number_b = PhoneNumber.new(:number =&gt; "7654321")
    phone_numbers = [number_a, number_b]
    print_numbers(phone_numbers).should == "1234567, 7654321"
  end
end
</pre>
<p>Run <code>rake</code> and the example will fail complaining that the method <code>print_numbers</code> doesn&#8217;t exist. Now you get to implement it!</p>
<h4>Writing the <code>print_numbers</code> helper</h4>
<p>Open the <code>/app/helpers/phone_numbers_helper.rb</code> file and add a method named <code>print_numbers</code>. It should take in one parameter which is an array of <code>PhoneNumber</code> objects, then use <code>collect</code> to gather the <code>number</code> from each of them. Finally, join the collected numbers by a comma and a space, returning the result.</p>
<p>When that works, run <code>rake</code> and your example should pass.</p>
<h4>Considering other cases for <code>print_numbers</code></h4>
<p>One of the common visual defects I see on the web are unnecessary trailing commas. If we pass an array with just one <code>PhoneNumber</code>, will we get back &#8220;thenumber&#8221; or &#8220;thenumber,&#8221;?  It had better be the first one, so let&#8217;s write a test!</p>
<p>I wrote an example named <code>"should output just a phone number"</code> and called <code>print_numbers</code> passing in an array of just a single number and validated the output. I ran <code>rake</code> and it succeeded.</p>
<p>There&#8217;s a documentation issue, though. The <code>"should output just a single number"</code> name only makes sense in the <strong>context</strong> when there is only one <code>PhoneNumber</code> object. It&#8217;s time to next a new <code>describe</code> block.</p>
<p>Refactor your examples to express more reasonable contexts. Here is my final structure with the actual test bodies removed &#8212; figure that part on your own:</p>
<pre class="brush:ruby">
  require 'spec_helper'

  describe PhoneNumbersHelper do
    describe "print_numbers" do
      describe "when there is more than one phone number" do
        before(:each)

        it "should output a comma-separated list of phone numbers"
      end

      describe "when there is only one phone number" do
        it "should output a just the phone number"
      end
    end
  end
</pre>
<h4>Why Devs Hate Testing Helpers</h4>
<p>The presentation layer is probably the most likely to change while an application is being built. We&#8217;ve written great tests that exercise a simple helper, then requirements change.</p>
<p>Now, instead of just a comma separated list, we need to implement an unordered (bullet) list where each number is its own bullet.</p>
<p>Let&#8217;s start with the tests. In the <code>"when there is more than one phone number"</code> context the <code>before</code> block still makes sense. The only thing that needs to change is the <code>.should==</code> , we need it to equal <code>"&lt;ul&gt;&lt;li&gt;thenumber&lt;/li&gt;&lt;li&gt;secondnumber&lt;/li&gt;&lt;/ul&gt;"</code> where <code>firstnumber</code> and <code>secondnumber</code> are your sample values.</p>
<p>Once that test fails for the right reason, you can try changing the helper itself. Use the <code>content_tag</code> helper to generate your <code>ul</code> and <code>li</code> elements. For example <code>content_tag :li, "Number1"</code> would output <code>&lt;li&gt;Number1&lt;/li&gt;</code>. If you see that your strings are getting escaped, try tacking <code>.html_safe</code> onto the end.</p>
<p>Once it&#8217;s working for the first test you need to deal with the <code>"should output just the phone number"</code> test. What should you see when there&#8217;s just one number?  Implement the test and verify it works.</p>
<p>This process is probably <strong>very frustrating</strong> and that&#8217;s ok. When you have a robust test suite it can exercise your app better than a full-time QA person. But building them up is not easy.</p>
<h4>Commit</h4>
<p>Your tests should all be passing, so check-in those changes!</p>
<h3>Building a Web-based Workflow</h3>
<p>Up to this point we&#8217;ve created phone numbers through the console. Let&#8217;s build up a web-based workflow.</p>
<h4>What You Got From Scaffolding</h4>
<p>When the scaffold generator ran it gave us a controller and some view templates. Check out the <strong>new</strong> form by loading up <code>/phone_numbers/new</code> in your browser.</p>
<p>It&#8217;s not that bad, but it&#8217;s not good enough.</p>
<h4>Person-centric Workflow</h4>
<p>Here&#8217;s what the customer wants:</p>
<p><em>&#8220;When I am looking at a single person&#8217;s page, I click an add link that takes me to the page where I enter the phone number. I click save, then I see the person and their updated information&#8221;</em></p>
<p>Go back to a person&#8217;s show page like <code>/people/1</code>. Our show page doesn&#8217;t even list the existing phone numbers. Let&#8217;s add that in real quick. Use your existing <code>print_numbers</code> helper to output the bullet list of the person&#8217;s numbers.</p>
<p>Then add a link under the list that says <strong>Add a Phone Number</strong> and points to the <code>new_phone_number_path</code>. See that the link displays in your browser and try clicking it.</p>
<h4>Passing in the Person</h4>
<p>When you look at the form you&#8217;ll see the <strong>Person</strong> text field, expecting the user to add the <code>person_id</code> manually. Obviously that&#8217;s ridiculous, let&#8217;s pass it in from the previous link.</p>
<p>When you write a path like <code>new_phone_number_path()</code> you can pass in extra data. Anything you put into the parentheses will be sent as <span class="caps">GET</span>-style parameters in the <span class="caps">URL</span>. Back on the person&#8217;s <code>show</code> page, let&#8217;s change the link to it includes the person&#8217;s ID:</p>
<pre class="brush:ruby">
&lt;%= link_to "Add a New Phone Number", new_phone_number_path(:person_id =&gt; @person.id ) %&gt;
</pre>
<p>Go back to the show page in your browser, refresh, and click the link. See how the <code>person_id</code> is now embedded in the <span class="caps">URL</span>?  We&#8217;re part way there, but the value isn&#8217;t in the &#8220;Person&#8221; text box yet.</p>
<h4>Utilizing the Person ID Parameter</h4>
<p>To make this work, we need to open <code>app/controllers/phone_numbers_controller.rb</code> and find the <code>new</code> action. By default it&#8217;s just creating a blank <code>PhoneNumber</code> by calling <code>PhoneNumber.new</code>. Instead, rewrite the method like this:</p>
<pre class="brush:ruby">
  def new
    @phone_number = PhoneNumber.new(:person_id =&gt; params[:person_id])
  end
</pre>
<p>Then refresh your form and the <code>person_id</code> should be filled in.</p>
<h4>Hiding the Person ID Input</h4>
<p>Since our user doesn&#8217;t need to change the <code>person_id</code>, we should make it hidden. Open <code>app/views/phone_numbers/_form.html.haml</code>. Change the <code>:person_id</code> from using <code>text_field</code> to <code>hidden_field</code>. Refresh the form and the text box will disappear.</p>
<p>You can then rip out the <code>label</code> and the paragraph tags.</p>
<h4>Processing the Form Data</h4>
<p>Fill in the form with a phone number and click the save button. It should save then take you to the <code>PhoneNumber</code> show page. That&#8217;s the default scaffold behavior, but our customer wanted to return to the phone number&#8217;s person&#8217;s page. Open up <code>/app/controllers/phone_numbers_controller.rb</code> and look at the <code>create</code> action. When the phone number successfully saves, redirect to the phone number&#8217;s attached person.</p>
<p>Go back to the form, make another phone number, and you should end up on the person&#8217;s show page. Test the whole work-flow from clicking the link, entering the number, and arriving back on the show page.</p>
<h4>Commit</h4>
<p>Check those changes into the git repository.</p>
<h3>Editing Numbers</h3>
<p>We all make mistakes &#8212; let&#8217;s make those numbers editable. We can insert a simple edit link next to each number in the bullet list. Should we dive into the helper?</p>
<h4>Helper vs. Partial</h4>
<p>Let&#8217;s imagine what this helper is going to output when we add the links. It&#8217;ll have a wrapping UL, then LIs for each phone number which contain both the phone number itself and a link.</p>
<p>We said that helpers are good for computation-style tasks. We&#8217;re not doing any computation here, and as we add more markup with the links it becomes a bigger and bigger pain to write the helper and the tests.</p>
<p>It&#8217;s time to pull our helper and replace it with a partial. We&#8217;ll need a new approach to testing. Let&#8217;s open the <code>phone_numbers_helper_spec.rb</code> and comment the whole thing out. Then go into <code>phone_numbers_helper.rb</code> and comment it out too. On a real project, I&#8217;d delete each.</p>
<h4>How do you test partials?</h4>
<p>We don&#8217;t want to lose the value of testing, so we need a way to test the person&#8217;s show view. We want to see that the rendered <span class="caps">HTML</span> has edit links for each phone number along with the number itself.</p>
<p>When we want to test the output <span class="caps">HTML</span> we&#8217;re talking about an <strong>integration test</strong>. My favorite way to build those is using the Capybara gem with RSpec. Let&#8217;s get Capybara setup by opening your <code>Gemfile</code> and adding this line:</p>
<pre class="brush:ruby">
  gem "capybara"
</pre>
<p>Then run <code>bundle</code> from your command line and it&#8217;ll install the gem.</p>
<h4>Setup an Integration Test</h4>
<p>Create a new folder named <code>/spec/integration/</code>. In that folder let&#8217;s make a file named <code>people_views_spec.rb</code>. Then here&#8217;s how I&#8217;d write the examples:</p>
<pre class="brush:ruby">
  require 'spec_helper'
  require 'capybara/rspec'

  describe "the views for people", :type =&gt; :request do
    before(:all) do
      @person = Person.create(:first_name =&gt; "John", :last_name =&gt; "Doe")
      number_a = @person.phone_numbers.create(:number =&gt; "1234567")
      number_b = @person.phone_numbers.create(:number =&gt; "7654321")
    end

    describe "when looking at a single person" do
      before(:all) do
        visit person_path(@person)
      end

      it "should have edit links for each phone number" do        
        @person.phone_numbers.each do |phone_number|
          page.should have_link("edit", :href =&gt; edit_phone_number_path(phone_number))
        end
      end
    end
  end
</pre>
<p>With that in place, run <code>rake</code> and the example should fail as the edit links aren&#8217;t present.</p>
<h4>Replacing the Helper with a Partial</h4>
<p>Open the <code>/views/people/show.html.erb</code> template and replace&#8230;</p>
<pre class="brush:ruby">
  &lt;%= print_numbers(@person.phone_numbers) %&gt;
</pre>
<p>With a call to <code>render</code> and a partial&#8230;</p>
<pre class="brush:ruby">
  &lt;%= render :partial =&gt; 'phone_numbers' %&gt;
</pre>
<p>If you refresh your browser it&#8217;ll crash because there is no partial named &#8220;phone_numbers&#8221;.</p>
<h4>Writing a Phone Numbers Partial</h4>
<p>Now create a file named <code>/views/people/_phone_numbers.html.erb</code>. In that template, render a UL tags that contain LIs for each phone number attached to <code>person</code>. The LI should contain the number and a link that has the text &#8220;edit&#8221; and points to the <code>edit_phone_number_path</code> for that phone number.</p>
<p>Check it out in your browser and, when you think it&#8217;s right, run <code>rake</code> and your integration tests should pass.</p>
<h4>Editing Workflow</h4>
<p>Click one of the edit links and you&#8217;ll jump to the edit form. This form is simplified to just the number because it uses the <code>/view/phone_numbers/_form.html.erb</code> that we modified previously.</p>
<p>Change the phone number, click the update button, and the processing will work fine. But it redirects you to the phone number&#8217;s <code>show</code> page. Instead, modify the <code>phone_numbers_controller.rb</code> so it redirect&#8217;s you to that phone number&#8217;s person&#8217;s <code>show</code> page.</p>
<h4>Fixing the Index</h4>
<p>We were using that helper on the index view, too. Open up <code>/views/people/index.html.erb</code> and replace the call to the helper with a call to <code>render</code>.</p>
<p>Open the index page in the browser and boom, it&#8217;ll crash. The partial is expecting to access a session variable <code>@person</code>, but that doesn&#8217;t exist in the index view.</p>
<p>Instead we need to pass in the phone numbers, just like we did with the helper. Here&#8217;s the Rails 3 way to do it:</p>
<pre class="brush:ruby">
  &lt;%= render :partial =&gt; 'phone_numbers', :object =&gt; person.phone_numbers %&gt;
</pre>
<p>Whatever you pass in as the <code>object</code> argument will get assigned to the local variable with the same name as the partial itself. Then in the partial change the iteration line to use that local like this&#8230;</p>
<pre class="brush:ruby">
  &lt;% phone_numbers.each do |phone_number| %&gt;
</pre>
<p>Now the <strong>index</strong> works fine, but the show will be broken. Make similar changes to the <code>render</code> call in the <strong>show</strong> template to pass in the phone numbers. Then they should both work.</p>
<h4>Commit</h4>
<p>Check those changes into the git repository.</p>
<h3>Destroying Phone Numbers</h3>
<p>Lastly the customer wants a delete link for each phone number. Follow a similar process to&#8230;</p>
<ul>
	<li>Write an example that looks for a delete link for each phone number</li>
	<li>Modify the partial to have that link</li>
	<li>Try it in your browser and destroy a phone number</li>
	<li>Fix the controller to redirect to the phone number&#8217;s person after destroy</li>
</ul>
<p>Then, if that&#8217;s too easy try this <strong>challenge</strong>:</p>
<p>Write an integration test that destroys one of the phone numbers then ensure&#8217;s that it&#8217;s really gone from the database. You&#8217;ll need to use Capybara features like&#8230;</p>
<ul>
	<li><code>page.click_link</code> to activate the destroy link</li>
	<li><code>current_path.should ==</code> to ensure you arrive at the show page</li>
	<li>then check that the object is gone (one idea: verify that there is <strong>no</strong> delete link)</li>
</ul>
<h3>Phone Numbers are Done&#8230;For Now!</h3>
<p>Wow, that was a lot of work, right?  Just to list some phone numbers?  Test-Driven Development (<span class="caps">TDD</span>) is really slow when you first get started, but after a few years you&#8217;ll have the hang of it!  I wish I was joking.</p>
<h4>Let&#8217;s Ship</h4>
<p>Hop over to your command prompt and let&#8217;s work with git. First, ensure that everything is committed on our branch:</p>
<pre class="console">
  git status
  git add .
  git commit -m "Finished implementing phone number functionality"
</pre>
<p>Then this branch is done. Let&#8217;s go back to the master branch and merge it in:</p>
<pre class="console">
  git checkout master
  git merge build_phone_numbers
</pre>
<p>Now it&#8217;s ready to send to Heroku and run our migrations:</p>
<pre class="console">
  git push heroku master
  heroku rake db:migrate
</pre>
<p>Open up your production app in your browser and it should be rockin&#8217;!</p>
<h2>I3: Email Addresses</h2>
<p>What good is a contact manager that doesn&#8217;t track email addresses?  We can take most of the ideas from <code>PhoneNumber</code> and apply them to <code>EmailAddress</code>. This iteration is going to be largely independent because you&#8217;ve seen it all before.</p>
<h3>Start a Feature Branch</h3>
<p>Let&#8217;s practice good source control and start a feature branch:</p>
<pre class="console">
  git branch create_email_addresses
  git checkout create_email_addresses
</pre>
<p>Now we&#8217;re ready to work!</p>
<h3>Writing a Test: A Contact Has Many Email Addresses</h3>
<p>In your <code>person_spec.rb</code> refer to the existing example &#8220;should have an array of phone numbers&#8221; and create a similar example for email addresses. Verify that the test fails when you run <code>rake</code>.</p>
<h3>Creating the Model</h3>
<p>Use the <code>nifty:scaffold</code> generator to scaffold a model named <code>EmailAddress</code> which has a string field named <code>address</code> and an integer field named <code>person_id</code>.</p>
<p>By the way, whenever you use the <code>rails generate</code> command and mess up, just go up a line in your terminal and change <code>rails generate</code> to <code>rails destroy</code>, leaving all the other parameters. The files previously generated will be removed.</p>
<p><strong>Remember</strong> how earlier we commented out the generated <code>phone_numbers_controller_spec.rb</code>?  Let&#8217;s do the same thing with <code>email_addresses_controller_spec.rb</code>.</p>
<p>Run <code>rake db:migrate</code> then ensure that your test still isn&#8217;t passing with <code>rake</code>.</p>
<h3>Setting Relationships</h3>
<p>Open the <code>Person</code> model and declare a <code>has_many</code> relationship for <code>email_addresses</code>. Open the <code>EmailAddress</code> model and declare a <code>belongs_to</code> relationship with <code>Person</code>.</p>
<p>Now run your tests with <code>rake</code> and they should all pass. Since you&#8217;re green it be a good time to <strong>commit your changes</strong>.</p>
<h3>Adding Model Tests and Validations for Email Addresses</h3>
<p>Let&#8217;s add some quality controls to our <code>EmailAddress</code> model.</p>
<ul>
	<li>Open the <code>email_address_spec.rb</code></li>
	<li>Add a <code>before</code> block to create a variable named <code>@email_address</code> like we did for <code>PhoneNumber</code></li>
	<li>Modify the example &#8220;should be valid&#8221; to check that <code>@email_address</code> is valid</li>
	<li>Look at the example &#8220;is not valid without a first_name&#8221; in <code>person_spec.rb</code> and create a similar example in <code>email_address_spec</code> which makes sure an <code>EmailAddress</code> is not valid without an address</li>
	<li>Run rake and make sure it <strong>fails</strong></li>
	<li>Add a <code>validates_presence_of</code> validation for the <code>address</code> attribute <code>EmailAddress</code></li>
	<li>Run rake and make sure it <strong>passes</strong></li>
	<li>Write a test to check that an <code>EmailAddress</code> isn&#8217;t valid unless it has a <code>person_id</code></li>
	<li>Modify your <code>before</code> block so it builds off a <code>Person</code> object like we did in <code>phone_number_spec</code></li>
	<li>Run rake and make sure it <strong>fails</strong></li>
	<li>Add a <code>validates_presence_of</code> for <code>:person_id</code> to the <code>EmailAddress</code> model</li>
	<li>Run rake and make sure it <strong>passes</strong></li>
</ul>
<p>If you&#8217;re green, go ahead and check in those changes.</p>
<h3>Completing Email Addresses</h3>
<p>Now let&#8217;s shift over to the integration tests.</p>
<h4>Displaying Email Addresses</h4>
<p>Before you play with displaying addresses, create a few of them manually in the console.</p>
<ul>
	<li>Open the <code>people_views_spec.rb</code></li>
	<li>Within the single person context, write a test named <code>"should display each of the email addresses"</code> that looks for a UL with LIs for each address. Try using this:<br />
<pre class="brush:ruby"><br />
  page.should have_selector(&#8216;li&#8217;, :text =&gt; email_address.address)<br />
</pre></li>
	<li>Make sure the test <strong>fails</strong>. If it passes unexpectedly, make sure that your person has one or more email addresses.</li>
	<li>Add a paragraph to the person&#8217;s <code>show</code> template that renders a partial named <code>email_addresses</code> which, like <code>phone_numbers</code>, renders a UL with LIs for each <code>EmailAddress</code></li>
</ul>
<p>Tests should be green here, so check in your changes. Then continue&#8230;</p>
<ul>
	<li>Add a new <code>describe</code> block to our <code>people_views_spec</code> which loads the <code>index</code> view</li>
	<li>Write a test checking that the email addresses are displayed</li>
	<li>Verify that it&#8217;s <strong>failing</strong></li>
	<li>Render the partial <code>email_addresses</code> in the <code>index</code> template</li>
	<li>Verify that it&#8217;s passing</li>
</ul>
<p>Check in your changes.</p>
<h4>Create Email Address Link</h4>
<ul>
	<li>Within the single person context, write a test named <code>"should have an add email address link"</code> that looks for a link with ID <code>new_email_address</code></li>
	<li>Verify that it <strong>fails</strong></li>
	<li>Add the link to the <code>show</code></li>
	<li>Verify that it <strong>passes</strong></li>
	<li>Write a test the clicks the add link, and make sure it goes to the <code>new_email_address_path</code></li>
</ul>
<h4>Email Address Creation Workflow</h4>
<ul>
	<li>Create a new integration test file for email addresses. Create a sample person in a <code>before(:all)</code> block</li>
	<li>Write a <code>describe</code> block for the new email address form</li>
	<li>Visit the new email address form for that person</li>
	<li>Change the <code>person_id</code> field to a <code>hidden_field</code></li>
	<li>Write a test that fills in the form with an address, submits it, and validates that&#8230;
	<ul>
		<li>It gets redirected to the person&#8217;s show page</li>
		<li>The show page contains the new email address</li>
		<li>Verify that it <strong>fails</strong>, then make it <strong>pass</strong>!</li>
		<li><strong><span class="caps">TIPS</span></strong>: Remember to tweak the controller&#8217;s <code>new</code> action to build the new email address with the parameter and the <code>create</code> action to redirect to the person&#8217;s show page</li>
	</ul></li>
</ul>
<p>When you&#8217;re green, check in your changes.</p>
<h4>Email Address Editing Workflow</h4>
<p>Try writing a similar test sequence to exercise the edit functionality:</p>
<ul>
	<li>Write a new <code>describe</code> block for the edit page</li>
	<li>Visit that page</li>
	<li>Change the value in the address field</li>
	<li>Submit it</li>
	<li>Verify that&#8230;
	<ul>
		<li>You get redirected to the person&#8217;s show page</li>
		<li>The page displays the edited address</li>
	</ul></li>
</ul>
<p>Make it green, then check it in.</p>
<h4>Email Address Deletion Workflow</h4>
<p>Then, finally, deletion:</p>
<ul>
	<li>In the <code>describe</code> block for the show page, write a test proving that there is a delete link for each email address</li>
	<li>See it <strong>fail</strong>, then add the links to the partial and see it <strong>pass</strong></li>
	<li>Write a test showing that when you click the delete link you end up on the person&#8217;s <code>show</code> page and the email address is gone.</li>
	<li>See it <strong>fail</strong>, then make it <strong>pass</strong></li>
</ul>
<p>When you&#8217;re green, check it in.</p>
<h3>Ship it!</h3>
<p>Let&#8217;s ship this feature:</p>
<ul>
	<li>Switch back to your master branch with <code>git checkout master</code></li>
	<li>Merge in the feature branch with <code>git merge create_email_addresses</code></li>
	<li>Throw it on Heroku with <code>git push heroku master</code></li>
	<li>Run your migrations with <code>heroku rake db:migrate</code></li>
</ul>
<h2>I4: Tracking Companies</h2>
<p>Our app can track people just fine, but what about companies?  What&#8217;s the difference between a company and person?  The main one, for now, is that a person has a first name and last name, while a company will just have one name.</p>
<h3>Thinking about the Model</h3>
<p>As you start to think about the model, it might trigger your instinct for inheritance. The most common inheritance style in Single Table Inheritance (<span class="caps">STI</span>) where you would store both people and companies into a table named <strong>contacts</strong>, then have a model for each that stores data in that table.</p>
<p><span class="caps">STI</span> has always been controversal, and every time I&#8217;ve used it, I&#8217;ve regretted it. For that reason, I ban <span class="caps">STI</span>!</p>
<p>Instead we&#8217;ll build up companies in the most simplistic way: duplicating a lot of code. Once we see where things are duplicated, we&#8217;ll extract them out and get the code <span class="caps">DRY</span>. A robust test suite will permit us be aggressive in our refactoring.</p>
<p>In the end, we&#8217;ll have clean, simple code that follows <em>The Ruby Way</em>.</p>
<h3>Start a Feature Branch</h3>
<p>It&#8217;s always a good practice to develop on a branch:</p>
<ul>
	<li><code>git branch create_companies</code></li>
	<li><code>git checkout create_companies</code></li>
</ul>
<h3>Starting up the Company Model</h3>
<p>Use the <code>nifty:scaffold</code> generator to create a <code>Company</code> that just has the attribute <code>name</code>. After you run the generator, <strong>remember</strong> to comment out or delete the controller tests.</p>
<p>Run <code>rake db:migrate</code> to update your database.</p>
<p>Run <code>rake</code> to make sure your tests are green, then check your code into git.</p>
<h3>Company Phone Numbers</h3>
<p>Then we want to add phone numbers to the companies. We already have a <code>PhoneNumber</code> model, a form, and some views. We can reuse much of this&#8230;with one problem.</p>
<p>Let&#8217;s think about the implementation <strong>second</strong> though. Write your tests first.</p>
<h4>Starting with Model</h4>
<p>Open up the <code>company_spec.rb</code> and you&#8217;ll see the generated <code>"should be valid"</code> example. Take inspiration from the <code>person_spec.rb</code> and&#8230;</p>
<ul>
	<li>Write a <code>before</code> block that sets up a <code>Company</code></li>
	<li>Refactor the <code>"should be valid"</code> example to test the object created in the <code>before</code> block</li>
	<li>Make sure the examples are still passing</li>
	<li>Write an example checking that a <code>Company</code> is not valid without a name</li>
	<li>See that it <strong>fails</strong></li>
	<li>Implement the validation</li>
	<li>See that it <strong>passes</strong></li>
</ul>
<h4>Moving Towards Phone Numbers</h4>
<p>Now we&#8217;re rolling with some tests, so we should just bring <strong>everything</strong> over from <strong>person_spec</strong> to <strong>company_spec</strong>, right?  I wouldn&#8217;t.</p>
<p>Just bring over and adapt the <code>"should have an array of phone numbers"</code> example. Run it and it&#8217;ll fail.</p>
<p><strong>Now</strong> we get to think about implementation. To solve this for <code>Person</code>, we said that the <code>PhoneNumber</code> would <code>belongs_to</code> a <code>Person</code> and the <code>Person</code> would <code>has_many :phone_numbers</code>. Try it again here:</p>
<ul>
	<li>Express the <code>has_many :phone_numbers</code> in the <code>Company</code> model</li>
	<li>Add a <code>belongs_to :company</code> in the <code>PhoneNumber</code> model</li>
	<li>Run your examples and they&#8217;ll <strong>pass</strong></li>
</ul>
<p>So we&#8217;re good &#8212; a <code>Company</code> has a method named <code>phone_numbers</code> and it returns an array.</p>
<h4>Wait a Minute&#8230;</h4>
<p>It should feel like something&#8217;s not right here. Let&#8217;s write a new spec that better exercises the relationship.</p>
<pre class="brush:ruby">
  it "should respond with its phone numbers after they're created" do
    phone_number = @company.phone_numbers.build(:number =&gt; "2223334444")
    @company.phone_numbers.should include(phone_number)
  end
</pre>
<p>Run that example and it will <strong>fail</strong>, thankfully. The <code>phone_numbers</code> method will not find the phone number because the relationships are lying.</p>
<p>When we say that a <code>PhoneNumber</code> <code>belongs_to :company</code> we imply that the <code>phone_numbers</code> table has a column named <code>company_id</code>. This is not the case, it has a <code>person_id</code> but no <code>company_id</code>.</p>
<p>We could add another column for <code>company_id</code>, but that would imply that a single number could be attached to one <code>Person</code> <strong>and</strong> one <code>Company</code>. That doesn&#8217;t make sense for our contact manager.</p>
<p>What we want to do is to abstract the relationship. We&#8217;ll say that a <code>PhoneNumber</code> <code>belongs_to</code> a <em>contact</em>, and that <em>contact</em> could be a <code>Person</code> or a <code>Company</code>.</p>
<h4>Setup for Polymorphism</h4>
<p>Our tests are still red so we&#8217;re allowed to write code. To implement a polymorphic join, the <code>phone_numbers</code> table needs to have the column <code>person_id</code> replaced with <code>contact_id</code>. Then we need a second column named <code>contact_type</code> where Rails will store the class name of the associated contact.</p>
<p>We need a migration. Use <code>rails generate migration</code> to create a migration that does the following to the <code>phone_numbers</code> table:</p>
<ul>
	<li>destroy all the existing <code>PhoneNumbers</code> with <code>PhoneNumber.destroy_all</code></li>
	<li>remove the column <code>person_id</code></li>
	<li>add a column named <code>contact_id</code> that is an <code>:integer</code></li>
	<li>add a column named <code>contact_type</code> that is a <code>:string</code></li>
	<li>in the <code>down</code> method, <code>raise ActiveRecord::IrreversibleMigration</code></li>
</ul>
<p>Then run the migration. Bye-bye, sample phone number data!</p>
<h4>Build the Polymorphic Relationship</h4>
<p>Run your tests and feel comforted by them <strong><span class="caps">BLOWING</span> UP</strong>! If you significantly change your database structure like this and you don&#8217;t cause a bunch of tests to fail, be concerned about your test coverage.</p>
<p>Let&#8217;s start with the <code>Person</code> model, since that had passing tests before the migration. The current relationship says&#8230;</p>
<pre class="brush:ruby">
  has_many :phone_numbers    
</pre>
<p>We just need to tell the relationship which &#8220;polymorphic interface&#8221; to use:</p>
<pre class="brush:ruby">
  has_many :phone_numbers, :as =&gt; :contact    
</pre>
<p>The tests aren&#8217;t any better. We need to tell the <code>PhoneNumber</code> about the polymorphism too. Change these:</p>
<pre class="brush:ruby">
  belongs_to :person
  belongs_to :company
</pre>
<p>To this:</p>
<pre class="brush:ruby">
  belongs_to :contact, :polymorphic =&gt; true
</pre>
<p>Now the models are properly associated, but my tests still look terrible. Maybe they need some revision.</p>
<h4>Revising Phone Number Tests</h4>
<p>Looking at the <code>phone_number_spec.rb</code>, you&#8217;ll see many references to <code>Person</code>. They likely need some tweaking.</p>
<p>I have an example <code>"should not be valid without a person"</code> example. That should be rebuilt like this:</p>
<pre class="brush:ruby">
  it "should not be valid without a contact" do
    @phone_number.contact = nil
    @phone_number.should_not be_valid
  end
</pre>
<p>It still fails because the <code>validates_presence_of</code> is looking for a <code>:person</code>. Change it to <code>:contact</code> and see where the tests stand.</p>
<p>I&#8217;m back to almost all green with just two failing tests.</p>
<h4>Fixing a Person/PhoneNumber Integration Test</h4>
<p>I have one integration test failing when it tries to exercise the delete functionality from the person&#8217;s <code>show</code> page. It&#8217;s failing with&#8230;</p>
<pre class="console">
  NoMethodError: undefined method `person' for #&lt;PhoneNumber:0x000001046a4000&gt;
  ./app/controllers/phone_numbers_controller.rb:39:in `destroy'  
</pre>
<p>Open up the controller and I find it&#8217;s the redirect that&#8217;s crashing. I currently have this:</p>
<pre class="brush:ruby">
  redirect_to @phone_number.person, :notice =&gt; "Successfully destroyed phone number."
</pre>
<p>This kind of issue is <strong>why we do <span class="caps">TDD</span></strong>. A human tester is unlikely to have caught this crash, but the automated tests save our butts. It&#8217;s a simple fix, thanks to Rails&#8217; built in redirect intelligence:</p>
<pre class="brush:ruby">
  redirect_to @phone_number.contact, :notice =&gt; "Successfully destroyed phone number."
</pre>
<p>Rails will <em>automatically</em> figure out what class type <code>contact</code> is and go to the appropriate <code>show</code> page for that object.</p>
<h4>And Finally, Company Phone Numbers</h4>
<p>Now there&#8217;s just one red test, the one that set us down this path: <code>"Company should respond with its phone numbers after they're created"</code>.</p>
<p>Open up the <code>Company</code> model and change the <code>has_many :phone_numbers</code> to reflect the polymorphism.</p>
<p>See <strong>green</strong>, breathe a sigh of relief, and <strong>check-in</strong> your code.</p>
<h3>Integration tests for People</h3>
<p>Check out the <code>people_views_spec.rb</code> and there are several examples that would apply to companies, too.</p>
<p>Create a <code>companies_views_spec.rb</code> and bring over anything related to phone numbers. Refactor the <code>before</code> block and copied tests to reflect companies.</p>
<h4>Implementing Lists, Links, and Partials</h4>
<p>After brining over the tests and updating them to exercise <code>@company</code>, I have two failures:</p>
<ul>
	<li><code>"the views for companies when looking at a single company should have delete links for each phone number"</code></li>
	<li><code>"the views for companies when looking at a single company should show the person after deleting a phone number"</code></li>
</ul>
<p>I peek at the web interface, and that&#8217;s not nearly enough. Other things I&#8217;m missing and don&#8217;t have examples for:</p>
<ul>
	<li><code>"the views for companies when looking at a single company should have an add phone number link"</code></li>
	<li><code>"the views for companies when looking at a single company should display each of the phone numbers"</code></li>
</ul>
<p>You&#8217;ve got this. Use your existing examples and code to guide you, write these two additional tests, and make all four pass!</p>
<p>And when it&#8217;s feeling easy&#8230;</p>
<ul>
	<li><code>"the views for companies when looking at a single company should show the person including the new number after creating a phone number"</code></li>
	<li><code>"the views for companies when looking at a single company should show the person including the updated number after editing a phone number"</code></li>
</ul>
<p>You&#8217;ll need to rebuild the <code>new</code> action in <code>PhoneNumbersController</code>. Here&#8217;s how I&#8217;d do it:</p>
<pre class="brush:ruby">
  def new
    if params[:person_id]
      contact = Person.find params[:person_id]
    else
      contact = Company.find params[:company_id]
    end
    @phone_number = contact.phone_numbers.new
  end
</pre>
<p>You&#8217;ll also run into a <strong>gotcha</strong> with the <code>PhoneNumber</code> model. Change the <code>attr_accesible</code> line from:</p>
<pre class="brush:ruby">
  attr_accessible :number, :person_id
</pre>
<p>To this:</p>
<pre class="brush:ruby">
  attr_accessible :number, :contact_id, :contact_type
</pre>
<p>That will allow the contact attributes to be set by mass assignment, like we use in the <code>create</code> action for <code>PhoneNumber</code>.</p>
<h4>Check It In!</h4>
<p>When you&#8217;ve got everything passing and feel good about your coverage, check your code into the git repository.</p>
<h3>Companies and Email Addresses</h3>
<p>At this point you should feel comfortable writing both model specs and integration tests. Take the same approach you just used to write model specs for the <code>Company</code> related to email addresses.</p>
<p>Implement the polymorphism for <code>EmailAddress</code> to make it work, cleaning up any <code>EmailAddress</code> tests along the way.</p>
<p>Once you&#8217;re green, add integration tests for the company&#8217;s show page to exercise email address functionality. Edit and add to the views and controllers to make it all work.</p>
<p>Here are the steps I took:</p>
<ul>
	<li>Write specs in <code>company_spec</code> to check for the <code>email_addresses</code> method and to make sure a newly inserted email address is included in the list &#8212; Result: <strong>2 red</strong></li>
	<li>Add the <code>has_many</code> relationship for <code>:email_addresses</code> to <code>Company</code> &#8212; Result: <strong>green</strong>??</li>
	<li>Added a line to my <code>"should respond with its email addresses after they're created"</code>: <code>@company.should be_valid</code> &#8212; Result: <strong>1 red</strong></li>
	<li>Generate a migration <code>change_email_addresses_to_relate_to_polymorphic_contacts</code></li>
	<li>Edit the migration to look almost exactly like the one for phone numbers, then <code>rake db:migrate</code> &#8212; Result: <strong>14 red</strong></li>
	<li>Open <code>EmailAddress</code> and change the <code>attr_accessible</code>, <code>belongs_to</code> and <code>validates_presence_of</code> to reflect <code>contact</code> &#8212; Result: <strong>14 red</strong></li>
	<li>Refactor <code>"should not be valid without a person"</code> in <code>email_address_spec</code> to <code>"should not be valid without a contact"</code> &#8212; Result: <strong>13 red</strong></li>
	<li>Open <code>person.rb</code> and update the <code>has_many :email_addresses</code> for the polymorphism &#8212; Result: <strong>5 red</strong></li>
	<li>Switch the <code>before</code> block in <code>company_spec.rb</code> to use <code>create</code> so it&#8217;ll have an ID to help with associated objects &#8212; Result: <strong>4 red</strong></li>
	<li>Update <code>/app/views/email_addresses/_form.html.erb</code> to use the <code>contact_id</code> and <code>contact_type</code> &#8212; Result: <strong>3 red</strong></li>
	<li>Change the redirect in <code>email_addresses_controller#destroy</code> from <code>@email_address.person</code> to <code>@email_address.contact</code> &#8212; Result: <strong>2 red</strong></li>
	<li>Do the same thing in <code>email_addresses_controller#update</code> &#8212; Result: <strong>1 red</strong></li>
	<li>Rebuild the <code>email_addresses_controller#new</code> to handle both <code>person_id</code> and <code>company_id</code> parameters, like we did in <code>phone_numbers_controller#new</code> &#8212; Result: <strong>1 red</strong></li>
	<li>Change the redirect in <code>phone_numbers_controller#create</code> to go to the <code>contact</code> &#8212; Result: <strong>green</strong></li>
</ul>
<p>That&#8217;s <span class="caps">TDD</span> for you. Now before you take a nap, take a look at the web interface. Specifically the <code>show</code> view of a company. More work to do&#8230;</p>
<ul>
	<li>Open <code>companies_views_spec.rb</code> and uncomment/adapt the email address tests I had brought over from <code>person_views_spec.rb</code> &#8212; Result: <strong>6 red</strong></li>
	<li>Create a partial <code>/app/views/companies/_email_addresses.html.erb</code>, copy everything from the similar partial under <code>people</code> &#8212; Result: <strong>6 red</strong></li>
	<li>Create an email display block in <code>views/companies/show.html.erb</code> rendering that partial &#8212; Result: <strong>3 red</strong></li>
	<li>Create the new email link on the company show page &#8212; Result: <strong>1 red</strong></li>
	<li>Open <code>views/companies/index.html.erb</code> and add a column for email addresses, rendering the same partial &#8212; Result: <strong>green</strong></li>
	<li>Realize there should be an integration test checking that the companies index lists the phone numbers, write it &#8212; Result: <strong>1 red</strong></li>
	<li>Edit the companies <code>index</code> view to display the <code>phone_numbers</code> partial &#8212; Result: <strong>green</strong></li>
	<li>In the end, I&#8217;ve got 42 green examples.</li>
</ul>
<p>Poke around in the web interface and I think we&#8217;ve got everything working.</p>
<h3>Ship It</h3>
<ul>
	<li>You&#8217;re green, so check in your code to the feature branch.</li>
	<li>Switch back to your master branch and merge in your feature branch. If your forget the branch&#8217;s name, try <code>git branch</code> to list them.</li>
	<li>Push it to Heroku</li>
	<li>Run your migrations</li>
	<li>&#8230;</li>
	<li>Profit!</li>
</ul>
<h2>I5: Removing Code</h2>
<p>Russ Olsen, in his book &#8220;Eloquent Ruby,&#8221; has a great line: <em>&#8220;The code you don&#8217;t write never stops working.&#8221;</em></p>
<p>Our app has entirely too much code. It works, so we can&#8217;t call it &#8220;bad,&#8221; but we can up the code quality and drop the maintenance load by refactoring.</p>
<p><strong>Refactoring</strong> is the process of taking working code and making it work better. That might mean reducing complexity, isolating dependencies, removing duplication &#8212; anything that leaves the external functionality the same while cleaning up the internals. In my opinion, the art of refactoring is the difference between people who write computer programs and people who are programmers. But there&#8217;s a catch to refactoring&#8230;</p>
<p><em>&#8220;Don&#8217;t change anything that doesn&#8217;t have [good test] coverage, otherwise you aren&#8217;t refactoring &#8212; you&#8217;re just changing [stuff].&#8221;</em></p>
<p>Our app has solid test coverage since most of it was written through <span class="caps">TDD</span>. That coverage gives us permission to refactor.</p>
<h3>Start a feature branch</h3>
<p>You&#8217;re on your <code>master</code> branch. Create an check out a branch named <code>removing_code</code> where we&#8217;ll make all our changes.</p>
<h3>Helper Hitlist</h3>
<p>Running the generators is great, but they create a lot of code. There are several files we can delete right away.</p>
<p>One thing you&#8217;ll see in many Rails projects is a <code>helpers</code> folder full of blank files. One of the things I hate about helpers is the naming convention from the generators is to create one helper for each model. Instead, you most often want your helper files grouping related functions, like a <code>TimeAndDateHelper</code> or <code>CurrencyHelper</code>.</p>
<p>Many developers get tricked into thinking helper classes should be tied to models and every model should have a helper class. That&#8217;s simply not true.</p>
<p>Look through the helpers folder and delete any that don&#8217;t have any methods. Even the <code>PhoneNumbersHelper</code> with its <code>print_numbers</code> method &#8212; we&#8217;re not using the helper anymore so let&#8217;s delete the whole file.</p>
<p>Run your tests and, if you&#8217;re green, check in the changes. To make sure git removes deleted files, use this:</p>
<pre class="console">
  git add -A .
</pre>
<h3>Revising Controllers</h3>
<p>Open up the <code>phone_numbers_controller.rb</code>. There are all the default actions here. Do we ever <code>show</code> a single phone number?  Do we use the index to view all the phone numbers separate from their contacts?  No. So let&#8217;s delete those actions.</p>
<h4>Implementing a Before Filter</h4>
<p>The remaining <code>edit</code>, <code>update</code>, and <code>destroy</code> methods all start with the same line. That&#8217;s not very <strong><span class="caps">DRY</span></strong>. We can take advantage of Rails&#8217; <code>before_filter</code> system to execute a piece of code before each action is triggered.</p>
<p>There are a couple opinions on how to implement <code>before_filters</code>, here&#8217;s the way I think you should do it. Up at the top of the controller, just after the <code>class</code> line, add this:</p>
<pre class="brush:ruby">
  before_filter :lookup_phone_number
</pre>
<p>Then go down to the bottom of the controller file. We want to add a <code>private</code> method to the controller like this:</p>
<pre class="brush:ruby">
  private
    def lookup_phone_number
      @phone_number = PhoneNumber.find(params[:id])
    end
</pre>
<p>Note that <code>private</code> doesn&#8217;t have an <code>end</code> line. Any method defined after the <code>private</code> keyword in a Ruby class will be private to instances of that object. Then within the <code>lookup_phone_number</code> method we just have the same line that was common to the three actions. <strong>Delete</strong> the line from the three actions and run your tests.</p>
<p>Some of them should <strong>fail</strong>. Look at the error messages and backtrace to see the issue.</p>
<h4>Scoping a Before Filter</h4>
<p>This <code>lookup_phone_number</code> method is being run before every action in the controller, but we only removed the line from <code>update</code>, <code>edit</code>, and <code>destroy</code>. When the <code>new</code> action is executed this line is raising and exception because there is no <code>params[:id]</code> data.</p>
<p>We want this before filter to only run for certain actions. Go back to the top of the controller and change&#8230;</p>
<pre class="brush:ruby">
  before_filter :lookup_phone_number
</pre>
<p>&#8230;to run only for the listed actions&#8230;</p>
<pre class="brush:ruby">
  before_filter :lookup_phone_number, :only =&gt; [:edit, :update, :destroy]
</pre>
<p>Or, you can even use the reverse logic:</p>
<pre class="brush:ruby">
  before_filter :lookup_phone_number, :except =&gt; [:new, :create]
</pre>
<p>Run your tests and they should be <strong>passing</strong>.</p>
<h4>Continuing the Before Filters</h4>
<p>You can use the exact same pattern to implement <code>before_filter</code> actions in&#8230;</p>
<ul>
	<li><code>companies_controller</code></li>
	<li><code>people_controller</code></li>
	<li><code>email_addresses_controller</code></li>
</ul>
<p>Go do those now and make sure your tests are still green. If the controller uses the <code>show</code> method, then it&#8217;s probably much shorter to use the <code>except</code> syntax on the <code>before_filter</code>.</p>
<h4>Removing Blank Controller Actions?</h4>
<p>As you remove the lookup line from actions like <code>edit</code>, it&#8217;s likely that your action is now totally blank. You can, then, remove the method from the controller. The <code>before_filter</code> will still be activated and the view template renders so things will work great.</p>
<p>But I don&#8217;t think it&#8217;s worth the developer cost. Not having the method in the file then having it work in the app is <strong>confusing</strong>. I&#8217;d recommend you just leave the stub.</p>
<h4>Playing with <code>ApplicationController</code></h4>
<p>Did you notice that all those controllers inherit from <code>ApplicationController</code>?  We&#8217;ve now got a private method in each controller that&#8217;s almost exactly the same. Could we condense them all into one method in the parent class?</p>
<p>Here&#8217;s what the method would have to do:</p>
<ul>
	<li>Figure out which controller called the method</li>
	<li>Figure out the model name for that controller</li>
	<li>Run the find action of that model</li>
	<li>Store it into an instance variable with the right name (like <code>@person</code> or <code>@company</code>)</li>
</ul>
<p>It&#8217;s a bit of metaprogramming that took me some experimenting, and here&#8217;s what I ended up with in my <code>ApplicationController</code>:</p>
<pre class="brush:ruby">
  def find_resource
    class_name = params[:controller].singularize
    klass = class_name.camelize.constantize
    self.instance_variable_set "@" + class_name, klass.find(params[:id])
  end
</pre>
<p>Then I call that method from <code>before_filter</code> lines in each controller. The <code>before_filter</code> call could be pulled up here, but I think that makes the individual controllers too opaque.</p>
<h4>Removing Unused Views for EmailAddresses and PhoneNumbers</h4>
<p>We pulled out controller methods for both our <code>phone_numbers</code> and <code>email_addresses</code> controllers, hop over to their view folders and delete any unnecessary views.</p>
<p>Run your tests and make sure they&#8217;re still passing. If you&#8217;re green, <strong>check in your code</strong>.</p>
<h3>Removing Model Duplication</h3>
<p>If you look at the <code>Person</code> and <code>Company</code> models you&#8217;ll see there are two lines exactly duplicated in each:</p>
<pre class="brush:ruby">
  has_many :phone_numbers, :as =&gt; :contact  
  has_many :email_addresses, :as =&gt; :contact  
</pre>
<p>Essentially each of these models shares the concept of a &#8220;contact,&#8221; but we decided not to go down the dark road of <span class="caps">STI</span>. Instead, we should abstract their common code into a module. Right now it&#8217;s only two lines, but over time the common code will likely increase. The module will be the place for common code to live.</p>
<p>There are many opinions about where modules should live in your application tree. In this case we&#8217;re going to create a <code>Contact</code> module and it&#8217;s almost like a model, so let&#8217;s drop the file right into the models folder.</p>
<ul>
	<li>Create a file <code>/app/models/contact.rb</code></li>
	<li>In it, define a module like this:</li>
</ul>
<pre class="brush:ruby">
  module Contact
    
  end
</pre>
<ul>
	<li>Move the two <code>has_many</code> lines from the <code>Person</code> model into that <code>module</code></li>
	<li>In their place within the <code>Person</code>, add this line:</li>
</ul>
<pre class="brush:ruby">
  include Contact
</pre>
<p>Run your tests and everything will be broken. When we write a module we need to distinguish between three types of code:</p>
<ul>
	<li>code that should be run in the containing class when the module is included</li>
	<li>methods that should be defined on the including class (like Person.first)</li>
	<li>methods that should be defined for instances of the including class (like Person.first.name)</li>
</ul>
<p>The normal Ruby syntax to accomplish these jobs is a little ugly. In Rails 3 there&#8217;s a new feature library that cleans up the implementation of modules. We use it like this:</p>
<pre class="brush:ruby">
  module Contact
    extend ActiveSupport::Concern

    included do
    end

    module ClassMethods
    end

    module InstanceMethods
    end
  end
</pre>
<p>Any code defined inside the <code>included</code> block will be run on the class when the module is included. Any methods defined in the <code>ClassMethods</code> submodule will be defined on the including class. And methods defined in the <code>InstanceMethods</code> submodule will be attached to instances of the class.</p>
<p>Where should your two <code>has_many</code> lines go?  Figure it out on your own and use your tests to prove that it works. When you&#8217;re <strong>green</strong>, check it in.</p>
<h3>Cutting Down View Redundancy</h3>
<p>Do you remember copying and pasting some view code?  I told you to do it, so don&#8217;t feel guilty.</p>
<h4>Relocating the Phone Numbers Partial</h4>
<p>If you look in <code>views/companies/_phone_numbers.html.erb</code> you&#8217;ll find the <strong>exact</strong> same code as in <code>views/people/_phone_numbers.html.erb</code>.</p>
<p>Here&#8217;s how to remove the duplication:</p>
<ul>
	<li>Move the phone numbers partial from the companies folder to the <code>views/phone_numbers/</code> folder</li>
	<li>Run your tests and they should freak out &#8212; I had 14 examples go red</li>
	<li>Open both the <code>views/companies/index.html.erb</code> and <code>views/companies/show.html.erb</code>. Each of them renders the partial. You just need to change this:</li>
</ul>
<pre class="brush:ruby">
  &lt;%= render :partial =&gt; "phone_numbers", :object =&gt; company.phone_numbers %&gt;
</pre>
<p>To have the folder in the partial name like this:</p>
<pre class="brush:ruby">
  &lt;%= render :partial =&gt; "phone_numbers/phone_numbers", :object =&gt; company.phone_numbers %&gt;
</pre>
<p>That should bring you back to green. Then&#8230;</p>
<ul>
	<li>Delete the <code>_phone_numbers.html.erb</code> partial from the <code>people</code> folder</li>
	<li>See the tests go red</li>
	<li>Update the <code>render</code> calls in the <code>index</code> and <code>show</code> views</li>
	<li>See the tests go green</li>
</ul>
<h4>Relocating the Email Addresses Partial</h4>
<p>Then repeat the exact same process for the email addresses partial.</p>
<h4>Check It In</h4>
<p>If your tests are green, check in the code and remember to use the <code>-A</code> flag on your <code>add</code> so git removes the deleted files.</p>
<h3>Simplifying Views</h3>
<p>Our views have a ton of markup in them and the output is <strong>ugly</strong>!  Let&#8217;s cut it down.</p>
<h4>Companies &amp; People Index</h4>
<p>Open the <code>views/companies/index.html.erb</code> and&#8230;</p>
<ul>
	<li>change the <code>&lt;table&gt;</code> tag to <code>&lt;div class='companies'&gt;</code></li>
	<li>change the closing <code>table</code> tag to match the <code>div</code></li>
	<li>delete the whole row with the headings</li>
	<li>The <code>for x in y</code> style of iteration is less preferred. Rewrite it with <code>@companies.each do |company|</code></li>
	<li>Change the <code>tr</code> open and close tags to div tags with the class name <code>"company"</code></li>
	<li>Change the <code>td</code> surrounding the company name to an <code>h4</code></li>
	<li>Remove the <code>td</code> tags around the two partials</li>
	<li>Turn the three <code>td</code> elements with the &#8220;Show&#8221;, &#8220;Edit&#8221;, and &#8220;Destroy&#8221; links into list items inside a <code>ul</code> with the class name <code>actions</code></li>
	<li>Add the id <code>"new_company"</code> to the link for the new company page</li>
</ul>
<p>Run your tests and everything should be green. We dramatically changed the markup, but our tests still run fine. Good integration tests aren&#8217;t bound too closely to the <span class="caps">HTML</span>, they focus on content and functionality &#8212; not tags.</p>
<p>Now go through the <strong>same process</strong> for <code>views/people/index.html.erb</code> just using the word <code>person</code> instead of <code>company</code> where appropriate. Also combine the first name and last name into a single <code>h4</code>.</p>
<p>If everything is green then check it in.</p>
<h4>Company &amp; Person Show</h4>
<p>Let&#8217;s make a similar set of changes to <code>views/companies/show.html.erb</code>&#8230;</p>
<ul>
	<li>Change the <code>title</code> line so it uses the name of the company</li>
	<li>Remove the paragraph with the company name</li>
	<li>String the phone numbers paragraph down so it just renders the partial</li>
	<li>Do the same for the email addresses</li>
	<li>Change the actions so they&#8217;re inside <code>li</code> tags inside a <code>ul</code> with the class name <code>"actions"</code></li>
	<li>Wrap the whole view in a div with class name <code>"company"</code></li>
</ul>
<p>Run your tests and they should be green. Then, <strong>repeat the process</strong> for <code>views/people/show.html.erb</code></p>
<p>When you&#8217;re green, check it in.</p>
<h4>Company &amp; Person Edit</h4>
<p>Just a few small changes to the <code>edit</code> template:</p>
<ul>
	<li>Change the <code>title</code> so it uses the name of the company/person</li>
	<li>Change the links and the bottom to be wrapped in <code>li</code> tags inside a <code>ul</code> with classname <code>"actions"</code></li>
</ul>
<h3>PhoneNumber &amp; Email Address New/Edit</h3>
<p>Open the <code>email_addresses/new.html.erb</code> and change the <code>title</code> line from</p>
<pre class="brush:ruby">
  &lt;% title "New Email Address" %&gt;
</pre>
<p>To this:</p>
<pre class="brush:ruby">
  &lt;% title "New Email Address for #{@email_address.contact}" %&gt;
</pre>
<p>View it in your browser and&#8230;what is that?  You probably see something like this:</p>
<pre class="console">
  New Email Address for #&lt;Person:0x00000103226e70&gt;
</pre>
<p>That person-like thing is what you get when you call the <code>to_s</code> method on an object that doesn&#8217;t have a <code>to_s</code>. This is the version all objects inherit from the <code>Object</code> class.</p>
<h4>Testing a <code>to_s</code> Method</h4>
<p>We want to write some code in our models, but we don&#8217;t have permission to do that without a failing test. Pop open the <code>person_spec.rb</code> file. Then add an example like this:</p>
<pre class="brush:ruby">
  it "should convert to a string with last name, first name" do
    @person.to_s.should == "Doe, John"
  end  
</pre>
<p>The value on the right side will obviously depend on what value you setup in the <code>before</code> block. Run the test and it&#8217;ll go red.</p>
<h4>Implementing a <code>to_s</code></h4>
<p>Now you get to open <code>models/person.rb</code> and define a <code>to_s</code> method like this:</p>
<pre class="brush:ruby">
  def to_s
    "#{last_name}, #{first_name}"
  end
</pre>
<p>That should make your test pass. Go through the same process writing a test for the <code>to_s</code> of <code>Company</code> then implementing the <code>to_s</code> method.</p>
<h4>Did It Work?</h4>
<p>Flip over to your browser and you&#8217;ll see that the <code>title</code> on the new email address page should look much better. It isn&#8217;t making a test go green, though, and that makes me feel guilty. We&#8217;ve knowingly spent time implementing untested code.</p>
<p>Let&#8217;s write a quick integration test. In the <code>email_addresses_views_spec</code> we have a context <code>"when looking at the new email address form"</code>. Within that, add this example:</p>
<pre class="brush:ruby">
  it "should show the contact's name in the title" do
    page.should have_selector("h1", :text =&gt; "#{@person.last_name}, #{@person.first_name}")
  end
</pre>
<p>It&#8217;ll pass because you&#8217;ve already implemented the <code>to_s</code> in <code>person.rb</code>. Try a little <em>&#8220;Comment Driven Development&#8221;</em>:</p>
<ul>
	<li>Comment out the <code>to_s</code> method in <code>person.rb</code></li>
	<li>Run the test and see it <strong>fail</strong></li>
	<li>Un-comment the <code>to_s</code></li>
	<li>See it <strong>pass</strong>!</li>
</ul>
<p>Now in that same integration spec, you have a context named <code>"when looking at the edit email address form"</code>. Implement a similar example there checking for the contact&#8217;s name in the <code>h1</code>, then change the view template to make it work.</p>
<h4>More Form Tests &amp; Tweaks</h4>
<p>Implement the same technique on&#8230;</p>
<ul>
	<li>the <code>new</code> template for phone numbers</li>
	<li>the <code>edit</code> template for phone numbers</li>
</ul>
<p>You probably want to create a <code>phone_numbers_views_spec.rb</code> and write the integration tests there before changing the view templates.</p>
<p>While you&#8217;re in there, I&#8217;m sure you&#8217;ll be tempted to write more integration tests for your phone numbers. Use the &#8220;Comment Driven Development&#8221; style to create the red/green cycle.</p>
<h4>Making Use of the <code>to_s</code> Method</h4>
<p>Lastly, consider searching your other views and simplifying calls to <code>@company.name</code> or <code>@person.first_name</code> with <code>@person.last_name</code> to just use the implicit <code>to_s</code>.</p>
<h3>Write Less Markup</h3>
<p>Writing <span class="caps">HTML</span> by hand is not so fun and mixing in <span class="caps">ERB</span> only makes it more frustrating. To be honest with you, I hate writing <span class="caps">ERB</span>. Let&#8217;s check out an alternative templating language named <span class="caps">HAML</span>.</p>
<p><span class="caps">HAML</span> was created as a response to this question: &#8220;If we adopt whitespace a significant and assume we&#8217;re outputting <span class="caps">HTML</span>, what can we <span class="caps">NOT</span> write?&#8221;  <span class="caps">HAML</span> uses indentation hierarchy to substitute for open/close tags and generally means writing significantly fewer characters on each template.</p>
<h4>Get <span class="caps">HAML</span> Installed</h4>
<p>Open up your <code>Gemfile</code>, add the dependency on the <code>"haml"</code> gem, save it and run <code>bundle</code> from the command prompt. Restart your web server so it loads the new library.</p>
<h4>Refactor a View</h4>
<p>Let&#8217;s see the difference by rebuilding an existing view. Open up your <code>views/companies/index.html.erb</code>. Create a second file in the same directory named <code>views/companies/index.html.haml</code>.</p>
<p>My <span class="caps">ERB</span> template looks like this:</p>
<pre class="brush:ruby">
  &lt;% title "Companies" %&gt;

  &lt;div class="companies"&gt;
    &lt;% @companies.each do |company| %&gt;
      &lt;div class="company"&gt;
        &lt;h4&gt;&lt;%= company.name %&gt;&lt;/h4&gt;
        &lt;%= render :partial =&gt; 'email_addresses/email_addresses', :object =&gt; company.email_addresses %&gt;
        &lt;%= render :partial =&gt; 'phone_numbers/phone_numbers', :object =&gt; company.phone_numbers %&gt;
        &lt;ul class="actions"&gt;
          &lt;%= link_to "Show", company %&gt;
          &lt;%= link_to "Edit", edit_company_path(company) %&gt;
          &lt;%= link_to "Destroy", company, :confirm =&gt; 'Are you sure?', :method =&gt; :delete %&gt;
        &lt;/ul&gt;
      &lt;/div&gt;
    &lt;% end %&gt;
  &lt;/div&gt;

  &lt;p&gt;&lt;%= link_to "New Company", new_company_path %&gt;&lt;/p&gt;
</pre>
<p>Copy that code and paste it into your new <code>.haml</code> page and we&#8217;ll strip it down. If your <span class="caps">ERB</span> template is properly indented like that, then the hard work is done for you. Here&#8217;s how we manually convert it to <span class="caps">HAML</span>:</p>
<ul>
	<li>Remove all close <span class="caps">ERB</span> tags <code>%&gt;</code></li>
	<li>Change all outputting <span class="caps">ERB</span> tags <code>&lt;%=</code> to just <code>=</code></li>
	<li>Change all non-printing <span class="caps">ERB</span> tags <code>&lt;%</code> to just <code>-</code></li>
	<li>Remove any lines that just contain a Ruby <code>end</code></li>
	<li>Remove all closing <span class="caps">HTML</span> tags like <code>&lt;/ul&gt;</code>, <code>&lt;/div&gt;</code>, etc</li>
	<li>Change open <span class="caps">HTML</span> tags from using greater than and less than like <code>&lt;h4&gt;</code> to just a leading percent like <code>%h4</code></li>
	<li>If those elements have a <span class="caps">CSS</span> class, write it in <span class="caps">CSS</span> style like <code>%div.companies</code></li>
	<li>And <code>div</code> is the default tag, so you can write <code>&lt;div class="companies"&gt;</code> as just <code>.companies</code></li>
</ul>
<p>Now you&#8217;ve got <span class="caps">HAML</span>!  Rewriting my template reduced it from 657 bytes to 540 bytes, from 71 words down to 53 words. That&#8217;s a good savings since they output the exact same thing. Run your tests and everything should be cool.</p>
<p>Here&#8217;s my completed <code>index.html.haml</code> for reference.</p>
<pre class="brush:ruby">
  - title "Companies" 

  .companies
    - @companies.each do |company| 
      .company
        %h4= company.name
        = render :partial =&gt; 'email_addresses/email_addresses', :object =&gt; company.email_addresses 
        = render :partial =&gt; 'phone_numbers/phone_numbers', :object =&gt; company.phone_numbers 
        %ul.actions
          = link_to "Show", company 
          = link_to "Edit", edit_company_path(company) 
          = link_to "Destroy", company, :confirm =&gt; 'Are you sure?', :method =&gt; :delete 

  %p= link_to "New Company", new_company_path
</pre>
<p>Go ahead and <strong>delete</strong> the old <span class="caps">ERB</span> template. You don&#8217;t have to rebuild existing templates unless you want to, but we&#8217;ll build things in <span class="caps">HAML</span> moving forward.</p>
<h3>Ship It</h3>
<p>We&#8217;re done with this iteration and your tests are green &#8212; it&#8217;s time to ship it.</p>
<p>Make sure everything&#8217;s checked in on your feature branch, <code>checkout</code> master, <code>merge</code> in the branch, then <code>push</code> it to Heroku. Check out the results in your browser. Look at the beauty of those minus signs and many deleted files.</p>
<h2>I6: Supporting Users</h2>
<p>What&#8217;s the point of a web application if only one person can use it?  Let&#8217;s make our system support multiple users. There are three pieces to making this happen:</p>
<ul>
	<li><strong>Authentication</strong> &#8211; Establish identity</li>
	<li><strong>Ownership</strong> &#8211; Attach data records to user records</li>
	<li><strong>Authorization</strong> &#8211; Control who is allowed to do what</li>
</ul>
<h3>Background on Authentication</h3>
<p>There have been about a dozen popular methods for authenticating Rails applications over the past five years.</p>
<p>The most popular right now is <a href="https://github.com/plataformatec/devise">Devise</a> because it makes it very easy to get up and running quickly. The downside is that the implementation uses very aggressive Ruby and metaprogramming techniques which make it very challenging to customize.</p>
<p>In the past I&#8217;ve been a fan of <a href="https://github.com/binarylogic/authlogic">AuthLogic</a> because it takes a very straightforward model/view/controller approach, but it means you have to write a lot of code to get it up and running.</p>
<p>As we learn more about constructing web applications there is a greater emphasis on decoupling components. It makes a lot of sense to depend on an external service for our authentication, then that service can serve this application along with many others.</p>
<h3>Why OmniAuth?</h3>
<p>The best application of this concept is the <a href="https://github.com/intridea/omniauth">OmniAuth</a>. It&#8217;s popular because it allows you to use multiple third-party services to authenticate, but it is really a pattern for component-based authentication. You could let your users login with their Twitter account, but you could also build our own OmniAuth provider that authenticates all your companies apps. Maybe you can use the existing <span class="caps">LDAP</span> provider to hook into ActiveDirectory or OpenLDAP, or make use of the Google Apps interface?</p>
<p>Better yet, OmniAuth can handle multiple concurrent strategies, so you can offer users multiple ways to authenticate. Your app is just built against the OmniAuth interface, those external components can come and go.</p>
<h3>Starting a Feature Branch</h3>
<p>Before we start writing code, let&#8217;s create a branch in our repository. Here&#8217;s a one-liner to create a branch and check it out:</p>
<pre class="console">
  git checkout -b adding_authentication
</pre>
<p>Now you&#8217;re ready to write code.</p>
<h3>Getting Started with OmniAuth</h3>
<p>The first step is to add the dependency to your <code>Gemfile</code>:</p>
<pre class="brush:ruby">
  gem "omniauth"
</pre>
<p>Then run <code>bundle</code> from your terminal.</p>
<p>OmniAuth runs as a &#8220;Rack Middleware&#8221; which means it&#8217;s not really a part of our app, it&#8217;s a thin layer between our app and the client. To instantiate and control the middleware, we need an initializer. Create a file <code>/config/initializers/omniauth.rb</code> and add the following:</p>
<pre class="brush:ruby">
  Rails.application.config.middleware.use OmniAuth::Builder do
    provider :twitter, "EZYxQSqP0j35QWqoV0kUg", "IToKT8jdWZEhEH60wFL94HGf4uoGE1SqFUrZUR34M4"
  end
</pre>
<p>What is all that garbage?  Twitter, like many <span class="caps">API</span>-providing services, wants to track who&#8217;s using it. They accomplish this by distributing <span class="caps">API</span> accounts. Specifically, they use the OAuth protocol which requires a &#8220;comsumer key&#8221; and a &#8220;consumer secret.&#8221;  If you want to build an application using the Twitter <span class="caps">API</span> you&#8217;ll need to <a href="https://dev.twitter.com/apps">register and get your own credentials</a>. For this tutorial, I&#8217;ve registered a sample application and given you my key/secret above.</p>
<h3>Trying It Out</h3>
<p>You need to <strong>restart your server</strong> so the new library and initializer are picked up. In your browser go to <code>http://127.0.0.1:8080/auth/twitter</code> and, after a few seconds, you should see a Twitter login page. Login to Twitter using any account, then you should see a <strong>Routing Error</strong> from your application. If you&#8217;ve got that, then things are on the right track.</p>
<p>If you get to this point and encounter a <strong>401 Unauthorized</strong> message there is more work to do. You&#8217;re probably using your own <span class="caps">API</span> key and secret. You need to go into the <a href="https://dev.twitter.com/apps/">settings on Twitter for your application</a>, and add <code>http://127.0.0.1</code> as a registered callback domain. I also add <code>http://0.0.0.0</code> and <code>http://localhost</code> while I&#8217;m in there. Now give it a try and you should get the <strong>Routing Error</strong></p>
<h3>Handling the Callback</h3>
<p>The way this authentication works is that your app redirects to the third party authenticator, the third party processes the authentication, then it sends the user back to your application at a &#8220;callback <span class="caps">URL</span>&#8221;. Twitter is attempting to send the data back to your application, but your app isn&#8217;t listening at the default OmniAuth callback address, <code>/auth/twitter/callback</code>. Let&#8217;s add a route to listen for those requests.</p>
<p>Open <code>/app/config/routes.rb</code> and add this line:</p>
<pre class="brush:ruby">
  match '/auth/:provider/callback', :to =&gt; 'sessions#create'
</pre>
<p>Re-visit <code>http://localhost:8080/auth/twitter</code>, it will process your already-existing Twitter login, then redirect back to your application and give you <strong>Uninitialized Constant SessionsController</strong>. Our router is attempting to call the <code>create</code> action of the <code>SessionsController</code>, but that controller doesn&#8217;t exist yet.</p>
<h3>Creating a Sessions Controller</h3>
<p>Let&#8217;s use a generator to create the controller from the command line:</p>
<pre class="console">
  rails generate controller sessions
</pre>
<p>Then open up that controller file and add code so it looks like this:</p>
<pre class="brush:ruby">
  class SessionsController &lt; ApplicationController
    def create
      render :text =&gt; debug request.env["omniauth.auth"]
      debugger
    end
  end
</pre>
<p>Revisit <code>/auth/twitter</code> and, once it redirects to your application, you should see a bunch of information provided by Twitter about the authenticated user!  Now we just need to figure out what to <strong>do</strong> with all that.</p>
<h3>Creating a User Model</h3>
<p>Even though we&#8217;re using an external service for authentication, we&#8217;ll still need to keep track of user objects within our system. Let&#8217;s create a model that will be responsible for that data.</p>
<p>As you saw, Twitter gives us a ton of data about the user. What should we store in our database?  The minimum expectations for an OmniAuth provider are three things:</p>
<ul>
	<li><strong>provider</strong> &#8211; A string name uniquely identifying the provider service</li>
	<li><strong>uid</strong> &#8211; An identifying string uniquely identifying the user within that provider</li>
	<li><strong>name</strong> &#8211; Some kind of human-meaningful name for the user</li>
</ul>
<p>Let&#8217;s start with just those three in our model. From your terminal:</p>
<pre class="console">
  rails generate model User provider:string uid:string name:string
</pre>
<p>Then update the database with <code>rake db:migrate</code>.</p>
<h3>Creating Actual Users</h3>
<p>How you create users might vary depending on the application. For the purposes of our contact manager, we&#8217;ll allow anyone to create an account automatically just by logging in with the third party service.</p>
<p>Hop back to the <code>SessionsController</code>. I believe strongly that the controller should have as little code as possible, so we&#8217;ll proxy the User lookup/creation from the controller down to the model like this:</p>
<pre class="brush:ruby">
  def create
    @user = User.find_or_create_by_auth(request.env["omniauth.auth"])
  end
</pre>

<p>Now the <code>User</code> model is responsible for figuring out what to do with that big hash of data from Twitter. Open that model file and add this method:</p>
<pre class="brush:ruby">
  def self.find_or_create_by_auth(auth_data)
    user = self.find_or_create_by_provider_and_uid(auth_data["provider"], auth_data["uid"])
    if user.name != auth_data["user_info"]["name"]
      user.name = auth_data["user_info"]["name"]
      user.save
    end    
    return user
  end
</pre>
<p>To walk through that step by step&#8230;</p>
<ul>
	<li>Look in the users table for a record with this provider and uid combination. If it&#8217;s found, you&#8217;ll get it back. If it&#8217;s not found, a new record will be created and returned</li>
	<li>Compare the user&#8217;s name and the name in the auth data. If they&#8217;re different, either this is a new user and we want to store the name or they&#8217;ve changed their name on the external service and it should be updated here. Then save it.</li>
	<li>Either way, return the user</li>
</ul>
<p>Now, back to <code>SessionsController</code>, let&#8217;s add a redirect action to send them to the <code>companies_path</code> after login:</p>
<pre class="brush:ruby">
  def create
    @user = User.find_or_create_by_auth(request.env["omniauth.auth"])
    redirect_to companies_path, :notice =&gt; "Logged in as #{@user.name}"
  end
</pre>
<p>Now visit <code>/auth/twitter</code> and you should eventually be redirected to your Companies listing and the flash message at the top will show a message saying that you&#8217;re logged in.</p>
<h3>UI for Login/Logout</h3>
<p>That&#8217;s exciting, but now we need links for login/logout that don&#8217;t require manually manipulating URLs. Anything like login/logout that you want visible on every page goes in the layout.</p>
<p>Open <code>/app/views/layouts/application.html.erb</code> and you&#8217;ll see the framing for all our view templates. Let&#8217;s add in the following <strong>just below the flash messages</strong>:</p>
<pre class="brush:ruby">
  &lt;div id="account"&gt;
    &lt;% if current_user %&gt;
      &lt;span&gt;Welcome, &lt;%= current_user.name %&gt;&lt;/span&gt;
      &lt;%= link_to "logout", logout_path, :id =&gt; "login" %&gt;
    &lt;% else %&gt;
      &lt;%= link_to "login", login_path, :id =&gt; "logout" %&gt;
    &lt;% end %&gt;
  &lt;/div&gt;
</pre>
<p>If you refresh your browser that will all crash for several reasons.</p>
<h3>Accessing the Current User</h3>
<p>It&#8217;s a convention that Rails authentication systems provide a <code>current_user</code> method to access the user. Let&#8217;s create that in our <code>ApplicationController</code> with these steps:</p>
<ul>
	<li>Underneath the <code>protect_from_forgery</code> line, add this: <code>helper_method :current_user</code></li>
	<li>Just before the closing <code>end</code> of the class, add this:</li>
</ul>
<pre class="brush:ruby">
  private
    def current_user
      @current_user ||= User.find(session[:user_id]) if session[:user_id]
    end  
</pre>
<p>By defining the <code>current_user</code> method as private in <code>ApplicationController</code>, that method will be available to all our controllers because they inherit from <code>ApplicationController</code>. In addition, the <code>helper_method</code> line makes the method available to all our views. Now we can access <code>current_user</code> from any controller and any view!</p>
<p>Refresh your page and you&#8217;ll move on to the next error, <code>undefined local variable or method `login_path'</code>.</p>
<h3>Convenience Routes</h3>
<p>Just because we&#8217;re following the <span class="caps">REST</span> convention doesn&#8217;t mean we can&#8217;t also create our own named routes. The view snipped we wrote is attempting to link to <code>login_path</code> and <code>logout_path</code>, but our application doesn&#8217;t yet know about those routes.</p>
<p>Open <code>/config/routes.rb</code> and add two custom routes:</p>
<pre class="brush:ruby">
  match "/login" =&gt; redirect("/auth/twitter"), :as =&gt; :login
  match "/logout" =&gt; "sessions#destroy", :as =&gt; :logout  
</pre>
<p>The first line creates a path named <code>login</code> which just redirects to the static address <code>/auth/twitter</code> which will be intercepted by the OmniAuth middleware. The second line creates a <code>logout</code> path which will call the destroy action of our <code>SessionsController</code>.</p>
<p>With those in place, refresh your browser and it should load without error.</p>
<h3>Implementing Logout</h3>
<p>Our login works great, but we can&#8217;t logout!  When you click the logout link it&#8217;s attempting to call the <code>destroy</code> action of <code>SessionsController</code>. Let&#8217;s implement that.</p>
<ul>
	<li>Open <code>SessionsController</code></li>
	<li>Add a <code>destroy</code> method</li>
	<li>In the method, erase the session by setting <code>session[:user_id] = nil</code></li>
	<li>Redirect them to the <code>root_path</code> with the notice <code>"Goodbye!"</code></li>
	<li>Define a <code>root_path</code> in your router like this: <code>root :to =&gt; "companies#index"</code></li>
</ul>
<p>Now try logging out and you&#8217;ll probably end up looking at the Rails &#8220;Welcome Aboard&#8221; page. Why isn&#8217;t your <code>root_path</code> taking affect?</p>
<p>If you have a file in <code>/public</code> that matches the requested <span class="caps">URL</span>, that will get served without ever triggering your router. Since Rails generated a <code>/public/index.html</code> file, that&#8217;s getting served instead of our <code>root_path</code> route. Delete the <code>index.html</code> file from <code>public</code>, and refresh your browser.</p>
<p><strong><span class="caps">NOTE</span></strong>: At this point I observed some strange errors from Twitter. Stopping and restarting my server, which clears the cached data, got it going again.</p>
<h3>Testing&#8230;?</h3>
<p>We haven&#8217;t written tests for login/logout. Here are some excuses:</p>
<ul>
	<li>OmniAuth is tested already, so we don&#8217;t need to test its functionality</li>
	<li>The code added to our app is relatively simple</li>
	<li>Handling the external service integration in our test suite is challenging</li>
</ul>
<p>Let&#8217;s make a mental note that we want to try writing tests for the authentication parts of our app later and move on. We&#8217;ll get some pieces of it going in the next iteration.</p>
<h3>Ship It</h3>
<p>Hop over to a terminal and <code>add</code> your files, <code>commit</code> your changes, <code>merge</code> the branch, and <code>push</code> it to Heroku.</p>
<h2>I7: Adding Ownership</h2>
<p>We&#8217;ve got users, but they all share the same contacts. That, obviously, won&#8217;t work. We need to rethink our data model to attach contacts to a <code>User</code>. It&#8217;d be tempting to add a <code>user_id</code> column to every table in our database, but let&#8217;s see if that&#8217;s really necessary.</p>
<h3>Back Into Testing</h3>
<p>Let&#8217;s start with some tests. Open up <code>user_spec.rb</code> and add this example:</p>
<pre class="brush:ruby">
  it "should have associated people" do
    @user.people.should be_instance_of(Array)
  end  
</pre>
<p>If you run <code>rake</code> that test will fail because there is no <code>@user</code> setup. We&#8217;ll need a <code>before</code> block.</p>
<h3>Setting up a Factory</h3>
<p>So far each of our test files has been making the objects it&#8217;ll need for the tests. If now decide that a <code>Person</code> had a required attribute of <code>title</code>, we&#8217;d have to update several spec files to create the objects properly.</p>
<p>This duplication makes our tests more fragile than they should be. We need to introduce a factory.</p>
<p>The most common libraries for test factories are <a href="https://github.com/thoughtbot/factory_girl">FactoryGirl</a> and <a href="https://github.com/notahat/machinist">Machinist</a>. Each of them has hit a rough patch of maintenance, though, which guided me towards a third option.</p>
<p>Let&#8217;s use <a href="https://github.com/paulelliott/fabrication">Fabrication</a> which is more actively maintained. Open up your <code>Gemfile</code> and add a dependency on <code>"fabrication"</code> in the test/development environment. Run <code>bundle</code> to install the gem.</p>
<p>We can also change the behavior of Rails generators to create fabrication patterns instead of normal fixtures. Open up <code>/config/application.rb</code>, scroll to the bottom, and just below the <code>javascript_expansions</code> add this block:</p>
<pre class="brush:ruby">
  config.generators do |g|
    g.test_framework      :rspec, :fixture =&gt; true
    g.fixture_replacement :fabrication
  end  
</pre>
<h3>Using Fabrication</h3>
<p>Now we need to make our fabricator. Create a folder <code>/spec/fabricators/</code> and in it create a file named <code>user_fabricator.rb</code>. In that file add this definition:</p>
<pre class="brush:ruby">
  Fabricator(:user) do
    name "Sample User"
    provider "twitter"
    uid {Fabricate.sequence(:uid)}
  end
</pre>
<p>Then go back to <code>user_spec.rb</code> and add this <code>before</code> block:</p>
<pre class="brush:ruby">
  before(:each) do
    @user = Fabricate(:user)
  end
</pre>
<p>Now <code>rake</code> your tests and it should fail for the reason we want &#8212; that <code>people</code> is undefined for a <code>User</code>.</p>
<h3>Testing Associations</h3>
<p>Open your <code>User</code> model and express a <code>has_many</code> relationship to <code>people</code>. Run <code>rake</code> and your example will still fail because it&#8217;s looking for a <code>user_id</code> column on the people table. We&#8217;ll need to add that.</p>
<p>Generate a migration to add the integer column named &#8220;user_id&#8221; to the people table. Run the migration, run your examples again, and they should pass.</p>
<h4>Working on the Person</h4>
<p>Let&#8217;s take a look at the <code>Person</code> side, so open the <code>person_spec.rb</code>. First, let&#8217;s refactor the <code>before</code> block to use a Fabricator. Create the <code>/spec/fabricators/person_fabricator.rb</code> file and add this definition:</p>
<pre class="brush:ruby">
  Fabricator(:person) do
    first_name "John"
    last_name "Doe"
  end  
</pre>
<p>Then in the <code>before</code> block of <code>person_spec</code>, use the fabricator like this:</p>
<pre class="brush:ruby">
  before(:each) do
    @person = Fabricate(:person)
  end  
</pre>
<p>Run <code>rake</code> and make sure the examples are still passing.</p>
<h4>Testing that a Person Belongs to a User</h4>
<p>Add an example checking that the <code>@person</code> is the child of a <code>User</code>. Run <code>rake</code> and see it fail.</p>
<p>Then add the <code>belongs_to</code> association in <code>Person</code>, run the tests, and see if they pass.</p>
<p>My test looks like this:</p>
<pre class="brush:ruby">
  it "should be the child of a User" do
    @person.user.should be_instance_of(User)
  end
</pre>
<p>This is really testing two things: that the person responds to the method call <code>user</code> and that the response is a <code>User</code>. My test is failing because the response is <code>nil</code>.</p>
<h4>Revising the Person Fabricator</h4>
<p>We need to work more on the fabricator. When we create a <code>Person</code>, we need to attach it to a <code>User</code>. It&#8217;s super easy because we&#8217;ve already got a fabricator for <code>User</code>. Open the <code>person_fabricator.rb</code> and add the line <code>user!</code> so you have this:</p>
<pre class="brush:ruby">
  Fabricator(:person) do
    first_name "John"
    last_name "Doe"
    user!
  end
</pre>
<p>Now when a <code>Person</code> is fabricated it will automatically associate with a user. Run <code>rake</code> and your tests should pass.</p>
<h4>More From the User Side</h4>
<p>Let&#8217;s check that when a <code>User</code> creates <code>People</code> they actually get associated. Try this example in <code>user_spec</code>:</p>
<pre class="brush:ruby">
  it "should build associated people" do
    person_1 = Fabricate(:person)
    person_2 = Fabricate(:person)
    [person_1, person_2].each do |person|
      @user.people.should_not include(person)
      @user.people &lt;&lt; person
      @user.people.should include(person)
    end
  end
</pre>
<p>Run <code>rake</code> and it&#8217;ll pass because we&#8217;re correctly setup the association on both sides.</p>
<h4>Now for Companies</h4>
<p>Write a similar test for companies:</p>
<pre class="brush:ruby">
  it "should build associated companies" do
    company_1 = Fabricate(:company)
    company_2 = Fabricate(:company)
    [company_1, company_2].each do |company|
      @user.companies.should_not include(company)
      @user.companies &lt;&lt; company
      @user.companies.should include(company)
    end
  end
</pre>
<p>Run <code>rake</code> and it&#8217;ll fail for several reasons. Work through them one-by-one until it&#8217;s passing. Here&#8217;s how I did it:</p>
<ul>
	<li>Create a <code>Fabricator</code> for <code>Company</code> similar to the one for <code>Person</code></li>
	<li>Create a migration to add <code>user_id</code> to the companies table</li>
	<li>Add the <code>belongs_to :user</code> association for <code>Company</code></li>
	<li>Add the <code>has_many :companies</code> association for <code>User</code></li>
</ul>
<p>With that, the tests should pass.</p>
<h3>Refactoring the Interface</h3>
<p>The most important part of adding the <code>User</code> and associations is that when a <code>User</code> is logged in they should only see their own contacts. How can we ensure that?</p>
<h4>Writing an Integration Test</h4>
<p>Let&#8217;s write integration tests to challenge this behavior. Create a new context within <code>"the views for people"</code> in <code>people_views_spec.rb</code> like this:</p>
<pre class="brush:ruby">
  describe "when logged in as a user" do
    before(:all) do
      @user = Fabricate(:user)
    end
  end
</pre>
<p>Then within that context we can check that they see their people:</p>
<pre class="brush:ruby">
  it "should display people associated with this user" do
    @person_1 = Fabricate(:person)
    @user.people &lt;&lt; @person_1
    visit(people_path)
    page.should have_link(@person_1.to_s)
  end
</pre>
<p>Run that and it should pass.</p>
<h4>The Negative Case</h4>
<p>Now let&#8217;s make sure they don&#8217;t see other user&#8217;s contacts. Here&#8217;s an example that should work.</p>
<pre class="brush:ruby">
  it "should display not display people associated with another user" do
    @user_2 = Fabricate(:user)
    @person_2 = Fabricate(:person)
    @user_2.people &lt;&lt; @person_2
    visit(people_path)
    page.should_not have_link(@person_2.to_s)
  end
</pre>
<p>We create a second user, attach them to a second person, then visit the listing. Run <code>rake</code> and this test will fail because the index is still showing <strong>all</strong> the people in the database.</p>
<h4>Scoping to the Current User</h4>
<p>Open up the <code>PeopleController</code> and look at the <code>index</code> action. It&#8217;s querying for <code>Person.all</code>, but we want it to only display the people for <code>current_user</code>. Change the action so it looks like this:</p>
<pre class="brush:ruby">
  def index
    @people = current_user.people
  end
</pre>
<p>Then run <code>rake</code> and you&#8217;ll find your test is crashing because <code>current_user</code> is <code>nil</code>. Our tests aren&#8217;t logging in, so there is no <code>current_user</code>.</p>
<h4>Faking a Login</h4>
<p>We need to have our tests &#8220;login&#8221; to the system. We don&#8217;t want to actually connect to the login provider, we want to mock a request/response cycle.</p>
<p>Here&#8217;s one way to do it. Create a folder <code>/spec/support</code> if you don&#8217;t have one already. In there create file named <code>omniauth.rb</code>. In this file we can define methods that will be available to all specs in the test suite. Here&#8217;s how we can fake the login:</p>
<pre class="brush:ruby">
  def login_as(user)
    OmniAuth.config.test_mode = true
    OmniAuth.config.mock_auth[:twitter] = {
        "provider" =&gt; user.provider,
        "uid" =&gt; user.uid,
        "user_info" =&gt; {"name"=&gt;user.name}
    }  
    visit(login_path)
  end
</pre>
<p>Now we can call the <code>login_as</code> method from any spec, passing in the desired <code>User</code> object, then the system will believe they have logged in.</p>
<h4>Building More Fabricators</h4>
<p>We&#8217;re working towards a refactoring of the integration tests. Let&#8217;s build up some fabricators that they&#8217;ll use.</p>
<p><code>email_address_fabricator.rb</code></p>
<pre class="brush:ruby">
  Fabricator(:email_address) do
    address "sample@sample.com"
  end
</pre>
<p><code>phone_number_fabricator.rb</code></p>
<pre class="brush:ruby">
  Fabricator(:phone_number) do
    number "2223334444"
  end
</pre>
<p><code>person_fabricator.rb</code></p>
<pre class="brush:ruby">
  Fabricator(:person) do
    first_name "John"
    last_name "Doe"
    user!
  end

  Fabricator(:person_with_details, :from =&gt; :person) do
    email_addresses!(:count =&gt; 2){|person, i| Fabricate(:email_address, :address =&gt; "sample_#{i}@sample.com", :contact =&gt; person)}
    phone_numbers!(:count =&gt; 2){|person, i| Fabricate(:phone_number, :number =&gt; "#{i.to_s*10}", :contact =&gt; person)}
  end
</pre>
<p><code>user_fabricator.rb</code></p>
<pre class="brush:ruby">
  Fabricator(:user) do
    name "Sample User"
    provider "twitter"
    uid {Fabricate.sequence(:uid)}
  end

  Fabricator(:user_with_people, :from =&gt; :user) do
    people!(:count =&gt; 3){|user, i| Fabricate(:person, :first_name =&gt; "Sample", :last_name =&gt; "Person #{i}", :user =&gt; user) }
  end

  Fabricator(:user_with_people_with_details, :from =&gt; :user) do
    people!(:count =&gt; 3){|user, i| Fabricate(:person_with_details, :first_name =&gt; "Sample", :last_name =&gt; "Person #{i}", :user =&gt; user) }
  end
</pre>
<h4>Refactoring <code>people_views_spec</code></h4>
<p>Now that we want to scope down to just people attached to the current user we&#8217;ll need to make some changes to <code>people_views_spec</code>. Here is the structure we want for these tests. I&#8217;ve removed the example bodies, but you have most of them built already. Reorganize them to fit into this structure.</p>
<pre class="brush:ruby">
  require 'spec_helper'
  require 'capybara/rspec'

  describe "the views for people", :type =&gt; :request do
    describe "when logged in as a user" do
      before(:all) do
        @user = Fabricate(:user_with_people_with_details)
        login_as(@user)
      end

      describe "when looking at the list of people" do
        before(:each) do
          visit people_path
        end

        it "should display people associated with this user"
        it "should not display people associated with another user"
      end

      describe "when looking at a single person" do
        before(:each) do
          @person = @user.people.first
          visit person_path(@person)
        end

        it "should have delete links for each email address"
        it "should have an add email address link"
        it "should go to the new email address form when the link is clicked"
        it "should display each of the email addresses"
        it "should have edit links for each phone number"
        it "should have delete links for each phone number"
        it "should show the person after deleting a phone number"
        it "should show the person after deleting an email address"
      end
    end
  end
</pre>
<h3>And Now, Companies</h3>
<p>You&#8217;ve done good work on people, but now we need to scope companies down to just the logged in user and refactor the tests as necessary.</p>
<p>Follow the same processes and go to it!</p>
<h3>Breathe, Ship</h3>
<p>That was a tough iteration but thinking about the tests helped up find the trouble spots. If your tests are <strong>green</strong>, check in your code, <code>checkout</code> the master branch, <code>merge</code> your feature branch, and ship it to Heroku!</p>
    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2012 - Jumpstart Lab -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  


  

  

  

  <div class="slide-out-div">
  <a class="handle" href="#">Feedback</a>
  <h3>Have Feedback?</h3>
  <p>Did you find an error? Something confusing? We'd love your help:</p>
  <ul>
    <li><a href="#" id="edit_source">Edit the source code of this page directly on Github</a></li>
    <li><a href="https://github.com/JumpstartLab/curriculum/issues">Create a new issue on the project's Github page</a></li>
  </ul>
  <p>Thanks!</p>
</div>

<script>
  var pathname = window.location.pathname.replace( ".html", ".markdown" );
  var github_url = "https://github.com/JumpstartLab/curriculum/blob/master/source" + pathname;
  $("a#edit_source").attr('href', github_url);
</script>

</body>
</html>
