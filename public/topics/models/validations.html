
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Validations - Jumpstart Lab Curriculum</title>
  <meta name="author" content="Jumpstart Lab">

  
  <meta name="description" content="            Models        Validations          Data integrity is an underrated part of proper application architecture. Many of the bugs in product...">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://yoursite.com/topics/models/validations.html">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection, print" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="http://s3.amazonaws.com/ender-js/jeesh.min.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Jumpstart Lab Curriculum" type="application/atom+xml">
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.3/jquery.min.js" type="text/javascript"></script>
  <script src="http://tab-slide-out.googlecode.com/files/jquery.tabSlideOut.v1.3.js"></script>

  <script type="text/javascript">
    $(function(){
        $('.slide-out-div').tabSlideOut({
          tabHandle: '.handle',                     //class of the element that will become your tab
          pathToTabImage: 'images/contact_tab.gif', //path to the image for the tab //Optionally can be set using css
          imageHeight: '122px',                     //height of tab image           //Optionally can be set using css
          imageWidth: '40px',                       //width of tab image            //Optionally can be set using css
          tabLocation: 'left',                      //side of screen where tab lives, top, right, bottom, or left
          speed: 300,                               //speed of animation
          action: 'click',                          //options: 'click' or 'hover', action to trigger animation
          topPos: '200px',                          //position from the top/ use if tabLocation is left or right
          leftPos: '20px',                          //position from left/ use if tabLocation is bottom or top
          fixedPosition: false                      //options: true makes it stick(fixed position) on scroll
          });

        });

    </script>

  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

</head>

<body  >
  <header role="banner"><hgroup>
  <h1><a href="/">Jumpstart Lab Curriculum</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:yoursite.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
<ul class="main-navigation">
  <li><a href="/">Curriculum Index</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article role="article">
  
  <header>
    
    <h2 class="section-title">Models</h2>
    
    <h1 class="entry-title">Validations</h1>
    
  </header>
  
  <p>Data integrity is an underrated part of proper application architecture. Many of the bugs in production systems are triggered by missing or malformed user data. If a user can possibly screw it up or screw with it, they will. Validations in the model can help!</p>

<h2>On Syntax</h2>

<p>Before we begin, let&#8217;s talk about syntax. There are two primary syntaxes for writing validations in Rails 3:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">validates_presence_of</span> <span class="ss">:price</span>
</span><span class='line'><span class="n">validates</span> <span class="ss">:price</span><span class="p">,</span> <span class="ss">:presence</span> <span class="o">=&gt;</span> <span class="kp">true</span>
</span></code></pre></td></tr></table></div></figure>

<p>These have the exact same functionality. The first is the older style and the second a newer &quot;Rails 3 style&quot;. The Rails 3 style shines when we add in a second validation on the same field:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># Rails 2 Style</span>
</span><span class='line'><span class="n">validates_presence_of</span> <span class="ss">:price</span>
</span><span class='line'><span class="n">validates_numericality_of</span> <span class="ss">:price</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Rails 3 Style</span>
</span><span class='line'><span class="n">validates</span> <span class="ss">:price</span><span class="p">,</span> <span class="ss">:presence</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">:numericality</span> <span class="o">=&gt;</span> <span class="kp">true</span>
</span></code></pre></td></tr></table></div></figure>

<p>The newer syntax allows you to condense multiple validations into a single line of code.</p>

<div class="opinion">
<p>In my opinion, the newer syntax is not good. Clean Ruby reads like English. To read the second set of examples aloud:</p>

<p><strong>Rails 2 Style</strong>: &#8220;validates presence of price, validates numericality of price&#8221;</p>

<p><strong>Rails 3</strong>: &#8220;validates price presence true numericality true&#8221;</p>

<p>The Rails 2 sentence isn&#8217;t poetry, but you can understand what it means. The Rails 3 syntax sounds like computer talk. Ruby is about developers not computers, and for that reason I recommend you <strong>not</strong> use the new syntax.</p>

<p>Aaron Patterson on the Rails core team confirms that there are no plans to deprecate the older syntax.</p>
</div>

<h2>Most Valuable Validations</h2>

<p>There are many validations available to you, check out the full API here: <a href="http://api.rubyonrails.org/classes/ActiveModel/Validations/HelperMethods.html">http://api.rubyonrails.org/classes/ActiveModel/Validations/HelperMethods.html</a></p>

<p>Let&#8217;s take a closer look at the most commonly used methods.</p>

<h3>Presence</h3>

<p><code>validates_presence_of</code></p>

<p>Declare that the field must have some value. Note that an empty string (<code>&quot;&quot;</code>) is <em>not</em> considered a value.</p>

<h4>Usage</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">validates_presence_of</span> <span class="ss">:title</span>
</span></code></pre></td></tr></table></div></figure>

<p>Also, you can declare the validation on multiple fields at once:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">validates_presence_of</span> <span class="ss">:title</span><span class="p">,</span> <span class="ss">:price</span><span class="p">,</span> <span class="ss">:description</span>
</span></code></pre></td></tr></table></div></figure>

<h3>Numericality</h3>

<p><code>validates_numericality_of</code></p>

<p>Check that the value in the field &quot;looks like&quot; a number. It might be a string, but does it look like a number? <code>&quot;123&quot;</code> does, <code>&quot;3.45&quot;</code> does, while <code>&quot;hello&quot;</code> does not. Neither does <code>&quot;a928&quot;</code>. I&#8217;ll tend to apply this to every field that is a number in the database (ex: <code>price</code>) and ones that look like a number but are stored as a string (ex: <code>zipcode</code>).</p>

<h4>Usage</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">validates_numericality_of</span> <span class="ss">:price</span>
</span></code></pre></td></tr></table></div></figure>

<p>That basic usage will allow anything that&#8217;s &quot;number-like&quot; including integers or floats.</p>

<h4>Options</h4>

<p>We can add a few options to add criteria to our &quot;numbers&quot;:</p>

<ul>
<li><code>:only_integer</code> will only accept integers</li>
</ul>

<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="n">validates<em>numericality</em>of</span> <span class="ss">:price</span><span class="p">,</span> <span class="ss">:only_integer</span> <span class="o">=&gt;</span> <span class="kp">true</span>
</span></code></pre></td></tr></table></div></figure></p>

<ul>
<li><p>Control the range of values with these options:</p>

<ul>
<li><code>:greater_than</code></li>
<li><code>:greater_than_or_equal_to</code></li>
<li><code>:less_than</code></li>
<li><code>:less_than_or_equal_to</code><br>
For example:</li>
</ul>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="n">validates_numericality_of</span> <span class="ss">:price</span><span class="p">,</span> <span class="ss">:greater_than</span> <span class="o">=&gt;</span> <span class="mi">0</span>
</span><span class='line'>  <span class="n">validates_numericality_of</span> <span class="ss">:price</span><span class="p">,</span> <span class="ss">:less_than</span> <span class="o">=&gt;</span> <span class="mi">1000</span>
</span><span class='line'>  <span class="n">validates_numericality_of</span> <span class="ss">:price</span><span class="p">,</span> <span class="ss">:greater_than</span> <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="ss">:less_than</span> <span class="o">=&gt;</span> <span class="mi">1000</span>
</span></code></pre></td></tr></table></div></figure></li>
</ul>

<h3>Length</h3>

<p><code>validates_length_of</code></p>

<p>Check the length of a string with <code>validates_length_of</code>.</p>

<h4>Usage &amp; Options</h4>

<p><code>validates_length_of</code> obviously needs to know what the length should be. Here are a few examples of the common specifiers:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">validates_length_of</span> <span class="ss">:zipcode</span><span class="p">,</span> <span class="ss">:is</span> <span class="o">=&gt;</span> <span class="mi">5</span>
</span><span class='line'><span class="n">validates_length_of</span> <span class="ss">:title</span><span class="p">,</span> <span class="ss">:minimum</span> <span class="o">=&gt;</span> <span class="s2">&quot;10&quot;</span>
</span><span class='line'><span class="n">validates_length_of</span> <span class="ss">:title</span><span class="p">,</span> <span class="ss">:maximum</span> <span class="o">=&gt;</span> <span class="s2">&quot;1000&quot;</span>
</span><span class='line'><span class="n">validates_length_of</span> <span class="ss">:title</span><span class="p">,</span> <span class="ss">:in</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="mi">10</span><span class="o">.</span><span class="n">.</span><span class="mi">1000</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>

<h3>Format</h3>

<p><code>validates_format_of</code></p>

<p>The <code>validates_format_of</code> method is the Swiss Army knife of validations. It attempts to match the input against a regular expression, so anything you can write in a regex you can check with this validator.</p>

<div class="opinion">
<p>I always like to share Jamie Zawinski&#8217;s quote when talking about this topic: &#8220;Some people, when confronted with a problem, think &#8216;I know, I&#8217;ll use regular expressions.&#8217; Now they have two problems.&#8221;</p>

<p>But if you&#8217;re comfortable and capable with regular expressions, have at it!</p>
</div>

<h4>Usage</h4>

<p>The canonical example is email address format validation:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">validates_format_of</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="sr">/\A([^@\s]+)@((?:[-a-z0-9]+\.)+[a-z]{2,})\Z/i</span>
</span></code></pre></td></tr></table></div></figure>

<p>Or reject based on a regex using the <code>:without</code> option:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">validates_format_of</span> <span class="ss">:comment</span><span class="p">,</span> <span class="ss">:without</span> <span class="o">=&gt;</span> <span class="sr">/(&lt;script&gt;|&lt;\/script&gt;)/</span>
</span></code></pre></td></tr></table></div></figure>

<h3>Inclusion</h3>

<p><code>validates_inclusion_of</code></p>

<p>Check that a value is in a given set with <code>validates_inclusion_of</code>.</p>

<h4>Usage</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">validates_inclusion_of</span> <span class="ss">:birth_year</span><span class="p">,</span> <span class="ss">:in</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="mi">1880</span><span class="o">.</span><span class="n">.</span><span class="mi">2011</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>

<p>The <code>:in</code> parameter will accept a Ruby range like this example or any other <code>Enumerable</code> object (like an <code>Array</code>).</p>

<h3>Custom Validations</h3>

<p>For custom validations, call the <code>validate</code> method with a symbol specifying the instance method to be called. When a record is saved, that method will be called.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">validate</span> <span class="ss">:not_spammy</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">not_spammy</span>
</span><span class='line'>  <span class="k">if</span> <span class="nb">self</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">downcase</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="s2">&quot;enhancement&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">errors</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="ss">:base</span><span class="p">,</span> <span class="s2">&quot;The description sounds spammy&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Rails will not respect the return value of that method, it determines pass/fail based on whether any error messages were added to the object. To make the validation fail by call <code>errors.add(:base, message)</code>. If no errors are added, the validation passes.</p>

<h2>Validations in the User Interface</h2>

<p>Having expressed validations in the model, let&#8217;s see how to make use of them in the user interface.</p>

<h3>Understanding Errors</h3>

<p>As an example, assume we have this model:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Product</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">validates_presence_of</span> <span class="ss">:title</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<h4>In the Console</h4>

<p>Trigger the validation:</p>

<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='irb'><span class='line'><span class="go">ruby-1.9.2-p290 :001 &gt; p = Product.new</span>
</span><span class='line'><span class="go"> =&gt; #&lt;Product id: nil, title: nil, price: nil, description: nil, image<em>url: nil, created</em>at: nil, updated_at: nil, stock: 0&gt; </span>
</span><span class='line'><span class="go">ruby-1.9.2-p290 :002 &gt; p.valid?</span>
</span><span class='line'><span class="go"> =&gt; false </span>
</span></code></pre></td></tr></table></div></figure></p>

<p>Calling the <code>valid?</code> method on an instance will run the validations and return <code>true</code> or <code>false</code>. From there, we can dig into the errors:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='irb'><span class='line'><span class="go">ruby-1.9.2-p290 :003 &gt; p.errors</span>
</span><span class='line'><span class="go"> =&gt; {:title=&gt;[&quot;can&#39;t be blank&quot;]} </span>
</span><span class='line'><span class="go">ruby-1.9.2-p290 :004 &gt; p.errors.full_messages</span>
</span><span class='line'><span class="go"> =&gt; [&quot;Title can&#39;t be blank&quot;] </span>
</span></code></pre></td></tr></table></div></figure>

<p>The <code>.errors</code> method returns an <code>ActiveRecord::Errors</code> collection, which looks like a hash, with the attribute name as the key and the message(s) in an array. The convenience method <code>.full_messages</code> on that object returns an array of nicely formatted sentence fragments.</p>

<h4>Save vs. Save!</h4>

<p>While looking at validation failures, let&#8217;s highlight the difference between <code>.save</code> and <code>.save!</code>. Both methods run your validations, of course, but the consequences of a failure are different.</p>

<p>For example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='irb'><span class='line'><span class="go">ruby-1.9.2-p290 :001 &gt; p = Product.new</span>
</span><span class='line'><span class="go"> =&gt; #&lt;Product id: nil, title: nil, price: nil, description: nil, image_url: nil, created_at: nil, updated_at: nil, stock: 0&gt; </span>
</span><span class='line'><span class="go">ruby-1.9.2-p290 :002 &gt; p.save</span>
</span><span class='line'><span class="go"> =&gt; false </span>
</span><span class='line'><span class="go">ruby-1.9.2-p290 :003 &gt; p.save!</span>
</span><span class='line'><span class="go">ActiveRecord::RecordInvalid: Validation failed: Title can&#39;t be blank</span>
</span></code></pre></td></tr></table></div></figure>

<p>A call to <code>save</code> will return <code>true</code> if the save succeeds and <code>false</code> if it fails. In your application code, you should react to this return value to determine next steps. For example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">create</span>
</span><span class='line'>  <span class="vi">@product</span> <span class="o">=</span> <span class="no">Product</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:product</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>  <span class="k">if</span> <span class="vi">@product</span><span class="o">.</span><span class="n">save</span>
</span><span class='line'>    <span class="n">redirect_to</span> <span class="vi">@product</span><span class="p">,</span> <span class="ss">:notice</span> <span class="o">=&gt;</span> <span class="s2">&quot;Successfully created product.&quot;</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="n">render</span> <span class="ss">:action</span> <span class="o">=&gt;</span> <span class="s1">&#39;new&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>The <code>if</code>/<code>else</code> switches based on the success/failure of the <code>save</code>.</p>

<p>Alternatively, when we use <code>save!</code>&#8230;</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='irb'><span class='line'><span class="go">ruby-1.9.2-p290 :001 &gt; p = Product.new</span>
</span><span class='line'><span class="go"> =&gt; #&lt;Product id: nil, title: nil, price: nil, description: nil, image_url: nil, created_at: nil, updated_at: nil, stock: 0&gt; </span>
</span><span class='line'><span class="go">ruby-1.9.2-p290 :002 &gt; p.save!</span>
</span><span class='line'><span class="go">ActiveRecord::RecordInvalid: Validation failed: Title can&#39;t be blank</span>
</span></code></pre></td></tr></table></div></figure>

<p>When <code>.save!</code> succeeds it will also return <code>true</code>, but when it fails it will <em>raise an exception</em>. Well architected Ruby treats exceptions as extremely abnormal cases. For that reason, saving a model should only raise an exception when something <em>very strange</em> has happened, like the database has crashed. Users entering junky input is not unexpected, so we shouldn&#8217;t typically raise exceptions on a validation.</p>

<p>So when should you use <code>save!</code>? When you expect the validations to always pass. For instance, if your application is creating objects with no user input, it&#8217;d be very strange to have invalid data. Then use <code>save!</code> and skip the redirect. In such a scenario, redirecting someplace probably isn&#8217;t going to help, so your application should raise an exception.</p>

<h3>Displaying Errors</h3>

<p>Typically we react to <code>.save</code> in the controller and re-render the form if it returned <code>false</code>. Then in the UI we can display the errors for the user to correct.</p>

<h4>Back in Rails 2</h4>

<p>In the olden days, this was very easy. All you had to write in the helper was call <code>error_messages_for</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='erb'><span class='line'><span class="cp">&lt;%=</span> <span class="n">error_messages_for</span> <span class="vi">@product</span> <span class="cp">%&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>

<p>You&#8217;d get a box saying that there were errors and a bulleted list of the error messages. Assuming your form is using the <code>form_for</code> helper, the fields with the validation errors will automatically be wrapped with a <code>&lt;div class='field_with_error&gt;&lt;/div&gt;</code>. </p>

<p>But the markup was not customizable, so most production apps would end up rewriting it.</p>

<p>With Rails 3 the <code>error_messages_for</code> helper was removed.</p>

<h4>Writing a Helper Method</h4>

<p>But now we can write our own <code>error_messages_for</code>, imitate Rails 2, and leave the door open for easy customization at the design stage. Here&#8217;s an implementation from Ryan Bates of RailsCasts:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">error_messages_for</span><span class="p">(</span><span class="o">*</span><span class="n">objects</span><span class="p">)</span>
</span><span class='line'>  <span class="n">options</span> <span class="o">=</span> <span class="n">objects</span><span class="o">.</span><span class="n">extract_options!</span>
</span><span class='line'>  <span class="n">options</span><span class="o">[</span><span class="ss">:header_message</span><span class="o">]</span> <span class="o">||=</span> <span class="no">I18n</span><span class="o">.</span><span class="n">t</span><span class="p">(</span><span class="ss">:&quot;activerecord.errors.header&quot;</span><span class="p">,</span> <span class="ss">:default</span> <span class="o">=&gt;</span> <span class="s2">&quot;Invalid Fields&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">options</span><span class="o">[</span><span class="ss">:message</span><span class="o">]</span> <span class="o">||=</span> <span class="no">I18n</span><span class="o">.</span><span class="n">t</span><span class="p">(</span><span class="ss">:&quot;activerecord.errors.message&quot;</span><span class="p">,</span> <span class="ss">:default</span> <span class="o">=&gt;</span> <span class="s2">&quot;Correct the following errors and try again.&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">messages</span> <span class="o">=</span> <span class="n">objects</span><span class="o">.</span><span class="n">compact</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">o</span><span class="o">|</span> <span class="n">o</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">full_messages</span> <span class="p">}</span><span class="o">.</span><span class="n">flatten</span>
</span><span class='line'>  <span class="k">unless</span> <span class="n">messages</span><span class="o">.</span><span class="n">empty?</span>
</span><span class='line'>    <span class="n">content_tag</span><span class="p">(</span><span class="ss">:div</span><span class="p">,</span> <span class="ss">:class</span> <span class="o">=&gt;</span> <span class="s2">&quot;error_messages&quot;</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">list_items</span> <span class="o">=</span> <span class="n">messages</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">msg</span><span class="o">|</span> <span class="n">content_tag</span><span class="p">(</span><span class="ss">:li</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>      <span class="n">content_tag</span><span class="p">(</span><span class="ss">:h2</span><span class="p">,</span> <span class="n">options</span><span class="o">[</span><span class="ss">:header_message</span><span class="o">]</span><span class="p">)</span> <span class="o">+</span> <span class="n">content_tag</span><span class="p">(</span><span class="ss">:p</span><span class="p">,</span> <span class="n">options</span><span class="o">[</span><span class="ss">:message</span><span class="o">]</span><span class="p">)</span> <span class="o">+</span> <span class="n">content_tag</span><span class="p">(</span><span class="ss">:ul</span><span class="p">,</span> <span class="n">list_items</span><span class="o">.</span><span class="n">join</span><span class="o">.</span><span class="n">html_safe</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>It&#8217;s CSS-compatible with the original Rails 2 implementation and respects i18n message definitions.</p>

<h4>Custom Messages &amp; Internationalization</h4>

<div class="opinion">
<p>All the validations support a <code>:message</code> parameter in the model where you can specify a custom message. But this is the wrong way to do it, and I hope that option is soon deprecated.</p>
</div>

<p>Error messages can be specified in our locale file. These files live in <code>config/locales/</code> and have names corresponding to the language code, like <code>en.yml</code> for English or <code>es.yml</code> for Spanish.</p>

<p>In that translation file you can override the default messages either globally for all uses of a validation or on a per-model basis. Check out the Rails source code for lots of details on implementation: <a href="https://github.com/rails/rails/blob/master/activerecord/lib/active_record/locale/en.yml">https://github.com/rails/rails/blob/master/activerecord/lib/active_record/locale/en.yml</a></p>

<p>Here&#8217;s an example based on <code>validates_presence_of :title</code> for a <code>Product</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">en</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">activerecord</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">errors</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">models</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">product</span><span class="p-Indicator">:</span>
</span><span class='line'>          <span class="l-Scalar-Plain">attributes</span><span class="p-Indicator">:</span>
</span><span class='line'>            <span class="l-Scalar-Plain">title</span><span class="p-Indicator">:</span>
</span><span class='line'>              <span class="l-Scalar-Plain">blank</span><span class="p-Indicator">:</span> <span class="s">&quot;Please</span><span class="nv"> </span><span class="s">enter</span><span class="nv"> </span><span class="s">a</span><span class="nv"> </span><span class="s">title.&quot;</span>
</span></code></pre></td></tr></table></div></figure>

<h3>Client-Side Validation</h3>

<p>Web applications generally do a terrible job of coaching their users. You fill out a big form, click submit, then it&#8217;ll have an uninformative message at the top of the form like &quot;Form Had Errors&quot;.</p>

<p>To treat users with respect, we should run validations and give feedback as soon as possible. That means handling it on the client-side in JavaScript.</p>

<p>Should we re-implement all our model validations in JavaScript? No!</p>

<p>The Client-Side Validations gem (<a href="https://github.com/bcardarella/client_side_validations">https://github.com/bcardarella/client_side_validations</a>) will take care of everything for you. It will read your model validations, wrap them up into a JSON package, and send it to the client along with the form. Combined with a small JavaScript engine to process that JSON, you get a great user experience with very little work.</p>

<p>Check out the project page and readme for details on setup and usage.</p>

<h2>Database Validations</h2>

<p>For truly bullet-proof data integrity you&#8217;ll need to implement validations at the database level, too.</p>

<ul>
<li>The <code>foreigner</code> gem gives you the ability to add foreign key constraints to MySQL, PostgreSQL, and SQLite: <a href="https://github.com/matthuhiggins/foreigner">https://github.com/matthuhiggins/foreigner</a></li>
<li><code>validates_uniqueness_of</code> could, in theory, run into a race condition if there are two concurrent requests creating the same data. To protect against that, you can create a database index on the field and specify that it must be unique:</li>
</ul>

<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="c1"># in your migration...</span>
</span><span class='line'>  <span class="n">t</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="ss">:unique</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>Then the database would reject a second submission with an existing title if it got past the Rails model validation</p>

<h2>Exercises</h2>

<div class="note">
  <p>Use the JSBlogger sample application to complete the exercises in this section. See the <a href="/topics/sample_project.html">Setup Instructions</a> for help.</p>
</div>

<ol>
<li>Write validations to check that an <code>Article</code> object must have both a title and a body.</li>
<li>Validate that a <code>Comment</code> has a body of less than 250 characters.</li>
<li>Validate that neither articles nor comments have your name in them.</li>
<li>Validate that a comment must have an associated article. Test it in your console and make sure it works as expected.</li>
<li>Build a module of <code>TextValidations</code> that can be shared by <code>Article</code> and <code>Comment</code>, then <code>include</code> it from both models.</li>
</ol>

<h2>References</h2>

<ul>
<li>Rails API for <code>validates_X_of</code> methods: <a href="http://api.rubyonrails.org/classes/ActiveModel/Validations/HelperMethods.html">http://api.rubyonrails.org/classes/ActiveModel/Validations/HelperMethods.html</a></li>
<li>Rails API for <code>validates</code> syntax: <a href="http://api.rubyonrails.org/classes/ActiveModel/Validations/ClassMethods.html#method-i-validates">http://api.rubyonrails.org/classes/ActiveModel/Validations/ClassMethods.html#method-i-validates</a></li>
<li>Tricks and techniques for Ruby exceptions: <a href="http://exceptionalruby.com/">http://exceptionalruby.com/</a></li>
<li>Client-Side Validations Gem: <a href="https://github.com/bcardarella/client_side_validations">https://github.com/bcardarella/client_side_validations</a></li>
<li>RailsCast on Client-Side Validations: <a href="http://railscasts.com/episodes/263-client-side-validations">http://railscasts.com/episodes/263-client-side-validations</a></li>
<li>ActiveRecord i18n Validation Messages: <a href="https://github.com/rails/rails/blob/master/activerecord/lib/active_record/locale/en.yml">https://github.com/rails/rails/blob/master/activerecord/lib/active_record/locale/en.yml</a></li>
<li>Rails Guide on i18n for Models: <a href="http://guides.rubyonrails.org/i18n.html#translations-for-active-record-models">http://guides.rubyonrails.org/i18n.html#translations-for-active-record-models</a></li>
<li>Rails migration methods including <code>index</code>: <a href="http://api.rubyonrails.org/classes/ActiveRecord/ConnectionAdapters/Table.html">http://api.rubyonrails.org/classes/ActiveRecord/ConnectionAdapters/Table.html</a></li>
</ul>

  
    <footer>
      
      
        <div class="sharing">
  
  
</div>

      
    </footer>
  
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
  </ul>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2012 - Jumpstart Lab -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  


  

  

  

  <div class="slide-out-div">
    <a class="handle" href="#">Content</a>
    <h3>Have feedback?</h3>
    <p>Thanks for letting us know! There's two ways to give us feedback:</p>
    <ul>
      <li>If you're on GitHub, you can <a href="https://github.com/JumpstartLab/curriculum/tree/master/source/projects">check out the source code</a>. This is all open source!</li>
      <li>If you don't have a GitHub account, you can <a href="mailto:jeff@jumpstartlab.com">send an email to Jeff</a>, and he'll be more than happy to address your issue.</li>
    </ul>
    <p>Thanks!</p>
  </div>
</body>
</html>
